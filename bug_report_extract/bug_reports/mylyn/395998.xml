<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>395998</bug_id>
          
          <creation_ts>2012-12-06 17:31:00 -0500</creation_ts>
          <short_desc>update to HttpComponents Client 4.1.3 (was: CommonHttpClient requests are retried indefinitely when using preemptive auth)</short_desc>
          <delta_ts>2013-04-09 14:57:03 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>14</classification_id>
          <classification>Mylyn</classification>
          <product>Mylyn Commons</product>
          <component>Network</component>
          <version>unspecified</version>
          <rep_platform>All</rep_platform>
          <op_sys>All</op_sys>
          <bug_status>RESOLVED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>3.9</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="David Green">david.green</reporter>
          <assigned_to name="Steffen Pingel">steffen.pingel</assigned_to>
          <cc>benjamin.muskalla</cc>
    
    <cc>steffen.pingel</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2191638</commentid>
    <comment_count>0</comment_count>
    <who name="David Green">david.green</who>
    <bug_when>2012-12-06 17:31:34 -0500</bug_when>
    <thetext>When _all_ of the following circumstances are met, CommonHttpClient retries requests to the server indefinitely:
* using preemptive Basic auth
* using Apache HttpClient 4.1.2
* with servers that accept Basic auth headers
* with servers that do not issue an HTTP Basic challenge

this problem can be avoided by enabling warn-level logging

The problem code appears to be in Apache HttpClient 4.1.2 in DefaultRequestDirector line 1096, where a return statement is only executed if logging is enabled.  The result is that when logging is disabled requests with invalid Basic credentials are retried indefinitely:

bc. 
                try {
                    processChallenges(challenges,
                            this.targetAuthState, this.targetAuthHandler,
                            response, context);
                } catch (AuthenticationException ex) {
                    if (this.log.isWarnEnabled()) {
                        this.log.warn(&quot;Authentication error: &quot; +  ex.getMessage());
                        return null; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; this return statement should be outside of this code block
                    }
                }
                
This results in what appears to be a hang, but in fact the client just loops indefinitely hitting the server.  Looking at the same class in version 4.1.3, the bug is fixed - and as luck would have it, 4.1.3 is in Orbit.

A solution to this problem would be simply requrining a minimum version of 4.1.3 in the manifest.

The following is a workaround that works without enabling logging:

bc.. 
		final UserCredentials credentials = location.getCredentials(AuthenticationType.HTTP);
		if (credentials != null) {
//      instead of using preemptive auth, workaround bug below
//			httpClient.setPreemptiveAuthenticationEnabled(true);

			location.removeCredentials(AuthenticationType.HTTP, credentials);

			httpClient.getHttpClient().addRequestInterceptor(new HttpRequestInterceptor() {

				@Override
				public void process(HttpRequest request, HttpContext context) throws HttpException, IOException {
					Header header = new BasicScheme().authenticate(
							new UsernamePasswordCredentials(credentials.getUserName(), credentials.getPassword()),
							request);
					request.addHeader(header);
				}
			});</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2191639</commentid>
    <comment_count>1</comment_count>
    <who name="David Green">david.green</who>
    <bug_when>2012-12-06 17:32:10 -0500</bug_when>
    <thetext>I forgot to mention: this problem only comes up when using invalid credentials.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2191745</commentid>
    <comment_count>2</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2012-12-07 03:56:58 -0500</bug_when>
    <thetext>Thanks for the bug report. None of the Mylyn connectors that use the HttpClient 4 transport use pre-emptive auth but we should certainly consume the newer HttpClient 4.1.3 bundle that is available in the latest Orbit S-build.

Note that there is also the related bug 381543 for updating to HttpClient 4.2.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2193148</commentid>
    <comment_count>3</comment_count>
    <who name="David Green">david.green</who>
    <bug_when>2012-12-11 12:16:15 -0500</bug_when>
    <thetext>(In reply to comment #2)
&gt; None of the Mylyn connectors that use the HttpClient 4 transport use pre-emptive auth but we should certainly consume the newer
&gt; HttpClient 4.1.3 bundle that is available in the latest Orbit S-build.

Yes, I agree.  Some web services such as those that support both HTTP Basic and anonymous access to the same service require the use of preemptive auth for authentication.  

Will we need to file a CQ?  Let me know if you&apos;d like me to initiate one.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2240438</commentid>
    <comment_count>4</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-04-05 18:24:17 -0400</bug_when>
    <thetext>I filed CQ 7159 and pushed these reviews:

11696: 395998: update dependencies to HttpComponents Client 4.1.3 [I72dc676f]
https://git.eclipse.org/r/#/c/11696/

11697: 395998: update dependencies to HttpComponents Client 4.1.3 [Ibb36bb16]
https://git.eclipse.org/r/#/c/11697/

Still need to update the target environments. I have local change but it&apos;s not complete, yet. I&apos;ll push that soon.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2240635</commentid>
    <comment_count>5</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-04-07 10:30:21 -0400</bug_when>
    <thetext>Update for target definitions: https://git.eclipse.org/r/#/c/11704 .</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2240812</commentid>
    <comment_count>6</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-04-08 05:54:29 -0400</bug_when>
    <thetext>We also need to consume Commons Codec 1.4 along with the update: https://git.eclipse.org/r/11715.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2241698</commentid>
    <comment_count>7</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-04-09 14:57:03 -0400</bug_when>
    <thetext>Dependencies have been updated and CQs have been filed. We&apos;ll review the full list of CQs as part of the next release review.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>