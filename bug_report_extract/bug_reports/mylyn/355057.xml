<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>355057</bug_id>
          
          <creation_ts>2011-08-18 07:08:00 -0400</creation_ts>
          <short_desc>[Compatibility] org.eclipse.core.runtime.isBundleInstalled property tester cannot be found</short_desc>
          <delta_ts>2012-02-17 11:47:49 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>14</classification_id>
          <classification>Mylyn</classification>
          <product>Mylyn Commons</product>
          <component>Discovery</component>
          <version>unspecified</version>
          <rep_platform>All</rep_platform>
          <op_sys>All</op_sys>
          <bug_status>RESOLVED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>enhancement</bug_severity>
          <target_milestone>3.7</target_milestone>
          
          <blocked>321278</blocked>
    
    <blocked>371807</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Steffen Pingel">steffen.pingel</reporter>
          <assigned_to name="Steffen Pingel">steffen.pingel</assigned_to>
          <cc>pwebster</cc>
    
    <cc>remy.suen</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>1980740</commentid>
    <comment_count>0</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2011-08-18 07:08:02 -0400</bug_when>
    <thetext>Steps:
1. Open New Query wizard
2. Press Install More Connectors

Nothing happens. Invoking the Discovery Wizard from the search box has no effect either. No error is logged.

This is possibly related to bug 321263.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1980774</commentid>
    <comment_count>1</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2011-08-18 07:44:49 -0400</bug_when>
    <thetext>If I remove the &lt;enabledWhen/&gt; expression it works when I invoke the command from the search box. Seems strange though since I would expect the expression to evaluate to true.

      &lt;handler
            class=&quot;org.eclipse.mylyn.internal.discovery.ui.commands.ShowConnectorDiscoveryWizardCommandHandler&quot;
            commandId=&quot;org.eclipse.mylyn.discovery.ui.discoveryWizardCommand&quot;&gt;
         &lt;enabledWhen&gt;
     		&lt;test
     			property=&quot;org.eclipse.core.runtime.isBundleInstalled&quot; args=&quot;org.eclipse.equinox.p2.repository&quot;/&gt;
         &lt;/enabledWhen&gt;
      &lt;/handler&gt;</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1980811</commentid>
    <comment_count>2</comment_count>
    <who name="Remy Suen">remy.suen</who>
    <bug_when>2011-08-18 07:58:42 -0400</bug_when>
    <thetext>Steffen, what does your plugin.xml look like? We have a report of enabledWhen not working properly yesterday, see bug 354967.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1980832</commentid>
    <comment_count>3</comment_count>
      <attachid>201712</attachid>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2011-08-18 08:06:57 -0400</bug_when>
    <thetext>Created attachment 201712
org.eclipse.mylyn.commons/org.eclipse.mylyn.discovery.ui/plugin.xml</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1980836</commentid>
    <comment_count>4</comment_count>
    <who name="Remy Suen">remy.suen</who>
    <bug_when>2011-08-18 08:09:55 -0400</bug_when>
    <thetext>Whoops, think I&apos;m barking up the wrong tree.

So you say this wizard is invoked via a button and possibly related to bug 321263. So the button actually calls Java APIs to run the wizard and the button click is not a result of a tool item (defined in some plugin.xml) being clicked, correct?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1980852</commentid>
    <comment_count>5</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2011-08-18 08:18:52 -0400</bug_when>
    <thetext>The button programmatically invokes the command. The weird thing is though that even if I invoke the command directly it doesn&apos;t work which makes me believe that the cause of the problem is actually related to the command enablement.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1980912</commentid>
    <comment_count>6</comment_count>
    <who name="Remy Suen">remy.suen</who>
    <bug_when>2011-08-18 09:22:46 -0400</bug_when>
    <thetext>(In reply to comment #5)
&gt; The button programmatically invokes the command.

What does the Java code look like?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1980963</commentid>
    <comment_count>7</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2011-08-18 10:15:32 -0400</bug_when>
    <thetext>Stepping through the code the CanExecute check in HandlerServiceImpl.executeHandler(ParameterizedCommand command, IEclipseContext staticContext) returns false and hence the command does not execute.

Invocation code:

pre.. 

		final Command discoveryWizardCommand = TasksUiInternal.getConfiguredDiscoveryWizardCommand();
		if (discoveryWizardCommand != null &amp;&amp; discoveryWizardCommand.isEnabled()) {
...
				public void widgetSelected(SelectionEvent event) {
					IHandlerService handlerService = (IHandlerService) PlatformUI.getWorkbench().getService(
							IHandlerService.class);
					try {
						handlerService.executeCommand(discoveryWizardCommand.getId(), null);
					} catch (Exception e) {
...
					}
				}


	public static Command getConfiguredDiscoveryWizardCommand() {
		ICommandService service = (ICommandService) PlatformUI.getWorkbench().getService(ICommandService.class);
		final Command discoveryWizardCommand = service.getCommand(&quot;org.eclipse.mylyn.tasks.ui.discoveryWizardCommand&quot;); //$NON-NLS-1$
		if (discoveryWizardCommand != null) {
			IHandlerService handlerService = (IHandlerService) PlatformUI.getWorkbench().getService(
					IHandlerService.class);
			EvaluationContext evaluationContext = createDiscoveryWizardEvaluationContext(handlerService);
			// update enabled state in case something has changed (ProxyHandler caches state)
			discoveryWizardCommand.setEnabled(evaluationContext);
		}
		return discoveryWizardCommand;
	}

	public static EvaluationContext createDiscoveryWizardEvaluationContext(IHandlerService handlerService) {
		EvaluationContext evaluationContext = new EvaluationContext(handlerService.getCurrentState(), Platform.class);
		// must specify this variable otherwise the PlatformPropertyTester won&apos;t work
		evaluationContext.addVariable(&quot;platform&quot;, Platform.class); //$NON-NLS-1$
		return evaluationContext;
	}</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1980973</commentid>
    <comment_count>8</comment_count>
    <who name="Remy Suen">remy.suen</who>
    <bug_when>2011-08-18 10:32:39 -0400</bug_when>
    <thetext>I have reproduced the problem locally on a similar snippet of code and xml, thank you Steffen for your information.

org.eclipse.core.runtime.CoreException: No property tester contributes a property org.eclipse.core.runtime.isBundleInstalled to type class java.util.Collections$EmptyList
	at org.eclipse.core.internal.expressions.TypeExtensionManager.getProperty(TypeExtensionManager.java:123)
	at org.eclipse.core.internal.expressions.TestExpression.evaluate(TestExpression.java:96)
	at org.eclipse.ui.internal.services.EvaluationReference.evaluate(EvaluationReference.java:93)
	at org.eclipse.ui.internal.services.EvaluationReference.evaluate(EvaluationReference.java:130)
	at org.eclipse.ui.internal.services.EvaluationReference.changed(EvaluationReference.java:124)
	at org.eclipse.e4.core.internal.contexts.TrackableComputationExt.update(TrackableComputationExt.java:94)
	at org.eclipse.e4.core.internal.contexts.EclipseContext.runAndTrack(EclipseContext.java:316)
	at org.eclipse.ui.internal.services.EvaluationService.addEvaluationReference(EvaluationService.java:199)
	at org.eclipse.ui.internal.services.EvaluationService.addEvaluationListener(EvaluationService.java:184)
	at org.eclipse.ui.internal.handlers.HandlerProxy.registerEnablement(HandlerProxy.java:213)
	at org.eclipse.ui.internal.handlers.HandlerProxy.&lt;init&gt;(HandlerProxy.java:192)
	at org.eclipse.ui.internal.handlers.LegacyHandlerService.readHandlers(LegacyHandlerService.java:621)
	at org.eclipse.ui.internal.handlers.LegacyHandlerService.readRegistry(LegacyHandlerService.java:558)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1980995</commentid>
    <comment_count>9</comment_count>
    <who name="Remy Suen">remy.suen</who>
    <bug_when>2011-08-18 10:57:25 -0400</bug_when>
    <thetext>We added some code for this when fixing bug 334257. I have confirmed that explicitly defining the variable will workaround this problem.

That is:
&lt;enabledWhen&gt;
  &lt;with variable=&quot;org.eclipse.core.runtime.Platform&quot;&gt;
    &lt;test
        property=&quot;org.eclipse.core.runtime.isBundleInstalled&quot;
        args=&quot;org.eclipse.equinox.p2.repository&quot;/&gt;
  &lt;/with&gt;
&lt;/enabledWhen&gt;

Will dig around some more to see how the &quot;simple&quot; version is implemented in 3.x.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1981016</commentid>
    <comment_count>10</comment_count>
    <who name="Remy Suen">remy.suen</who>
    <bug_when>2011-08-18 11:28:17 -0400</bug_when>
    <thetext>(In reply to comment #7)
&gt;         // must specify this variable otherwise the PlatformPropertyTester
&gt; won&apos;t work
&gt;         evaluationContext.addVariable(&quot;platform&quot;, Platform.class);
&gt; //$NON-NLS-1$

I didn&apos;t see this code since I only read the first part of comment 7. So it seems explicitly changing your plugin.xml like the snippet I provided in comment 9 will make the button work in addition to Mylyn not having to have this piece of code.

I&apos;ll have to investigate further to determine the legitimacy of this piece of code to get that corresponding snippet of xml to work.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1992963</commentid>
    <comment_count>11</comment_count>
    <who name="Remy Suen">remy.suen</who>
    <bug_when>2011-09-13 15:00:19 -0400</bug_when>
    <thetext>Steffen, do you know why the code was explicitly added in comment 7 instead of just using the XML described in comment 9.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1993555</commentid>
    <comment_count>12</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2011-09-14 13:17:24 -0400</bug_when>
    <thetext>Not entirely sure why we update the command enablement state programmatically, sounds like cached state would sometimes cause the check to fail even though discovery (p2) was available.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2067450</commentid>
    <comment_count>13</comment_count>
    <who name="Remy Suen">remy.suen</who>
    <bug_when>2012-02-17 08:29:54 -0500</bug_when>
    <thetext>(In reply to comment #9)
&gt; &lt;enabledWhen&gt;
&gt;   &lt;with variable=&quot;org.eclipse.core.runtime.Platform&quot;&gt;
&gt;     &lt;test
&gt;         property=&quot;org.eclipse.core.runtime.isBundleInstalled&quot;
&gt;         args=&quot;org.eclipse.equinox.p2.repository&quot;/&gt;
&gt;   &lt;/with&gt;
&gt; &lt;/enabledWhen&gt;

Please change your plugin.xml to match the code above. Paul has told me that this is a requirement.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2067541</commentid>
    <comment_count>14</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2012-02-17 10:22:22 -0500</bug_when>
    <thetext>Thanks a lot! I have made this change and will trigger a new build to test the changes.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2067623</commentid>
    <comment_count>15</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2012-02-17 11:47:49 -0500</bug_when>
    <thetext>I had to make an additional change to the code. Here is what we used to call which ends up invoking MakeHandlersGo.setEnabled() which is noop:

  discoveryWizardCommand.setEnabled(evaluationContext);
  
I changed the code to do this:

  discoveryWizardCommand.isEnabled()
  
That triggers HandlerProxy.setEnabled() which then does the right thing. 

With the change to the extension declaration and the code the command enablement check now works as expected.</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="0"
              isprivate="0"
          >
            <attachid>201712</attachid>
            <date>2011-08-18 08:06:00 -0400</date>
            <delta_ts>2011-08-18 08:06:57 -0400</delta_ts>
            <desc>org.eclipse.mylyn.commons/org.eclipse.mylyn.discovery.ui/plugin.xml</desc>
            <filename>plugin.xml</filename>
            <type>application/xml</type>
            <size>1202</size>
            <attacher name="Steffen Pingel">steffen.pingel</attacher>
            
              <data encoding="base64">PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPD9lY2xpcHNlIHZlcnNpb249
IjMuNCI/PjwhLS0KICAgIENvcHlyaWdodCAoYykgMjAwOSBUYXNrdG9wIFRlY2hub2xvZ2llcyBh
bmQgb3RoZXJzLgogICAgQWxsIHJpZ2h0cyByZXNlcnZlZC4gVGhpcyBwcm9ncmFtIGFuZCB0aGUg
YWNjb21wYW55aW5nIG1hdGVyaWFscwogICAgYXJlIG1hZGUgYXZhaWxhYmxlIHVuZGVyIHRoZSB0
ZXJtcyBvZiB0aGUgRWNsaXBzZSBQdWJsaWMgTGljZW5zZSB2MS4wCiAgICB3aGljaCBhY2NvbXBh
bmllcyB0aGlzIGRpc3RyaWJ1dGlvbiwgYW5kIGlzIGF2YWlsYWJsZSBhdAogICAgaHR0cDovL3d3
dy5lY2xpcHNlLm9yZy9sZWdhbC9lcGwtdjEwLmh0bWwKICAgCiAgICBDb250cmlidXRvcnM6CiAg
ICAgICAgIFRhc2t0b3AgVGVjaG5vbG9naWVzIC0gaW5pdGlhbCBBUEkgYW5kIGltcGxlbWVudGF0
aW9uCiAtLT4KCjxwbHVnaW4+CiAgIDxleHRlbnNpb24KICAgICAgICAgcG9pbnQ9Im9yZy5lY2xp
cHNlLnVpLmNvbW1hbmRzIj4KICAgICAgPGNvbW1hbmQKICAgICAgICAgICAgZGVzY3JpcHRpb249
IiVjb21tYW5kLmRlc2NyaXB0aW9uIgogICAgICAgICAgICBpZD0ib3JnLmVjbGlwc2UubXlseW4u
ZGlzY292ZXJ5LnVpLmRpc2NvdmVyeVdpemFyZENvbW1hbmQiCiAgICAgICAgICAgIG5hbWU9IiVj
b21tYW5kLm5hbWUiPgogICAgICA8L2NvbW1hbmQ+CiAgIDwvZXh0ZW5zaW9uPgogICA8ZXh0ZW5z
aW9uCiAgICAgICAgIHBvaW50PSJvcmcuZWNsaXBzZS51aS5oYW5kbGVycyI+CiAgICAgIDxoYW5k
bGVyCiAgICAgICAgICAgIGNsYXNzPSJvcmcuZWNsaXBzZS5teWx5bi5pbnRlcm5hbC5kaXNjb3Zl
cnkudWkuY29tbWFuZHMuU2hvd0Nvbm5lY3RvckRpc2NvdmVyeVdpemFyZENvbW1hbmRIYW5kbGVy
IgogICAgICAgICAgICBjb21tYW5kSWQ9Im9yZy5lY2xpcHNlLm15bHluLmRpc2NvdmVyeS51aS5k
aXNjb3ZlcnlXaXphcmRDb21tYW5kIj4KICAgICAgICAgPGVuYWJsZWRXaGVuPgogICAgIAkJPHRl
c3QKICAgICAJCQlwcm9wZXJ0eT0ib3JnLmVjbGlwc2UuY29yZS5ydW50aW1lLmlzQnVuZGxlSW5z
dGFsbGVkIiBhcmdzPSJvcmcuZWNsaXBzZS5lcXVpbm94LnAyLnJlcG9zaXRvcnkiLz4KICAgICAg
ICAgPC9lbmFibGVkV2hlbj4KICAgICAgPC9oYW5kbGVyPgogICA8L2V4dGVuc2lvbj4KCjwvcGx1
Z2luPgo=
</data>

          </attachment>
      

    </bug>

</bugzilla>