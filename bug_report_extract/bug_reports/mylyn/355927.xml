<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>355927</bug_id>
          
          <creation_ts>2011-08-26 05:29:00 -0400</creation_ts>
          <short_desc>running of build fails with Unexpected error: Forbidden when Cross Site Request Forgery prevention is enabled</short_desc>
          <delta_ts>2012-01-14 08:58:45 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>14</classification_id>
          <classification>Mylyn</classification>
          <product>Mylyn Builds</product>
          <component>Hudson Connector</component>
          <version>unspecified</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Windows XP</op_sys>
          <bug_status>RESOLVED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords>helpwanted</keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>0.9</target_milestone>
          <dependson>356788</dependson>
    
    <dependson>367573</dependson>
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Terence Miller">cforce</reporter>
          <assigned_to name="Steffen Pingel">steffen.pingel</assigned_to>
          <cc>cforce</cc>
    
    <cc>klemens.muthmann</cc>
    
    <cc>taciano.tres</cc>
          
          <votes>2</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>1984848</commentid>
    <comment_count>0</comment_count>
    <who name="Terence Miller">cforce</who>
    <bug_when>2011-08-26 05:29:16 -0400</bug_when>
    <thetext>Build Identifier: I20110613-1736

org.eclipse.core.runtime.CoreException: Unexpected error: Forbidden
	at org.eclipse.mylyn.internal.hudson.core.HudsonCorePlugin.toCoreException(HudsonCorePlugin.java:61)
	at org.eclipse.mylyn.internal.hudson.core.HudsonServerBehaviour.runBuild(HudsonServerBehaviour.java:738)
	at org.eclipse.mylyn.builds.internal.core.operations.RunBuildOperation$1.doExecute(RunBuildOperation.java:55)
	at org.eclipse.mylyn.builds.internal.core.operations.BuildJob.run(BuildJob.java:79)
	at org.eclipse.core.internal.jobs.Worker.run(Worker.java:54)
Caused by: org.eclipse.mylyn.internal.hudson.core.client.HudsonException: Forbidden
	at org.eclipse.mylyn.internal.hudson.core.client.HudsonOperation.run(HudsonOperation.java:34)
	at org.eclipse.mylyn.internal.hudson.core.client.RestfulHudsonClient.runBuild(RestfulHudsonClient.java:397)
	at org.eclipse.mylyn.internal.hudson.core.HudsonServerBehaviour.runBuild(HudsonServerBehaviour.java:736)
	... 3 more
Caused by: java.io.IOException: Forbidden
	at org.eclipse.mylyn.commons.http.CommonHttpClient.needsReauthentication(CommonHttpClient.java:105)
	at org.eclipse.mylyn.commons.http.HttpOperation.needsReauthentication(HttpOperation.java:102)
	at org.eclipse.mylyn.commons.http.HttpOperation.execute(HttpOperation.java:76)
	at org.eclipse.mylyn.internal.hudson.core.client.RestfulHudsonClient$7.execute(RestfulHudsonClient.java:390)
	at org.eclipse.mylyn.internal.hudson.core.client.HudsonOperation.run(HudsonOperation.java:32)
	... 5 more
Caused by: java.lang.UnsupportedOperationException
	at org.eclipse.mylyn.internal.commons.repositories.LocationService.requestCredentials(LocationService.java:93)
	at org.eclipse.mylyn.builds.internal.core.util.RepositoryWebLocation.requestCredentials(RepositoryWebLocation.java:55)
	at org.eclipse.mylyn.commons.http.CommonHttpClient.needsReauthentication(CommonHttpClient.java:99)
	... 9 more



eclipse.buildId=I20110613-1736
java.version=1.7.0
java.vendor=Oracle Corporation
BootLoader constants: OS=win32, ARCH=x86, WS=win32, NL=de_DE
Framework arguments:  -product org.eclipse.epp.package.jee.product
Command-line arguments:  -data C:\DevMine\workspace\Java -os win32 -ws win32 -arch x86 -product org.eclipse.epp.package.jee.product

Jenkins ver. 1.424 on Tomcat 7 on Windows Server 2008

Running build with saem user/pwd from Jenkins web-gui works without problems.

Reproducible: Always

Steps to Reproduce:
1.Install Jenkins as build sever in Builds view
2. Choose a build job in build view job list below jenkins build server instance and click run
3.Running of build fails</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1984916</commentid>
    <comment_count>1</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2011-08-26 08:27:29 -0400</bug_when>
    <thetext>Can you check if an entry for the Jenkins username and password was created in the preferences under General &gt; Secure Storage &gt; Contents: org.eclipse.mylyn.commons.repository?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1984939</commentid>
    <comment_count>2</comment_count>
    <who name="Terence Miller">cforce</who>
    <bug_when>2011-08-26 09:01:50 -0400</bug_when>
    <thetext>Yes, there are two entries:

org.eclipse.mylyn.tasklist.repositories.password
org.eclipse.mylyn.tasklist.repositories.user

I deleted secure storage, then saved user/pwd after &quot;Validate&quot; in Server properties in Build View via Secure Storage agaian - refreshed job List and selected gob to run.

Same Error!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1985305</commentid>
    <comment_count>3</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2011-08-27 16:52:20 -0400</bug_when>
    <thetext>Thanks for the information. The connector currently only support authenticating through HTTP. I suspect that authentication is failing since your server expects a different type of login.

Is your server publicly accessible? If not, can you check if it uses the standard form-based login mechanism (e.g. http://mylyn.org/jenkins-latest/login?from=%2Fjenkins-latest%2F)?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1985316</commentid>
    <comment_count>4</comment_count>
    <who name="Terence Miller">cforce</who>
    <bug_when>2011-08-27 19:22:45 -0400</bug_when>
    <thetext>(In reply to comment #3)
&gt; Thanks for the information. The connector currently only support authenticating
&gt; through HTTP. I suspect that authentication is failing since your server
&gt; expects a different type of login.
We use the build in ldap support to authtenticate , but standard http form based

&gt; Is your server publicly accessible? If not, can you check if it uses the
&gt; standard form-based login mechanism (e.g.
&gt; http://mylyn.org/jenkins-latest/login?from=%2Fjenkins-latest%2F)?

Our login form looks similar in jekins lookup is done via ldap</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1986417</commentid>
    <comment_count>5</comment_count>
    <who name="Terence Miller">cforce</who>
    <bug_when>2011-08-30 10:23:22 -0400</bug_when>
    <thetext>I managed to locate the origin of that bug.

When i disable the checkbox
&quot;Prevent from Cross Site Request Forgery&quot; attacks in Jenkins global settings the bug disappears. 

Mylyn can&apos;t handle the crumb security feature to prevent csrf attacks . That is a major secuity flaw in my opinion.
Can you fix thta bug please!

Tx for support.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1986707</commentid>
    <comment_count>6</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2011-08-30 17:19:53 -0400</bug_when>
    <thetext>*** Bug 341414 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>1986708</commentid>
    <comment_count>7</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2011-08-30 17:34:58 -0400</bug_when>
    <thetext>Thanks for investigating that. I don&apos;t agree that this a security flaw since it doesn&apos;t work. Obviously support for this security feature should be implemented to enable running of builds when the &quot;Prevent from Cross Site Request Forgery&quot; setting is active. I have updated the summary accordingly.

Request wise it looks like there is a script tag that initializes JavaScript magic:

&lt;script&gt;crumb.init(&quot;.crumb&quot;, &quot;540de756e8c00c046a3a739a85cfe701&quot;);&lt;/script&gt;

This causes an additional header to be included in the request:

.crumb: 540de756e8c00c046a3a739a85cfe701</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2044633</commentid>
    <comment_count>8</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2011-12-27 08:08:02 -0500</bug_when>
    <thetext>I have committed a first pass at this. The fix is in master and will be available in the next weekly build (first week of 2012).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2050482</commentid>
    <comment_count>9</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2012-01-14 08:58:45 -0500</bug_when>
    <thetext>A new weekly build now is available from http://eclipse.org/mylyn/downloads/#weekly . Please retry with the latest and reopen this bug if the problem persists.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>