<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>417481</bug_id>
          
          <creation_ts>2013-09-18 04:02:00 -0400</creation_ts>
          <short_desc>Wikitext stuck in a loop</short_desc>
          <delta_ts>2013-10-25 19:04:47 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>14</classification_id>
          <classification>Mylyn</classification>
          <product>Mylyn Docs</product>
          <component>Wikitext</component>
          <version>unspecified</version>
          <rep_platform>All</rep_platform>
          <op_sys>All</op_sys>
          <bug_status>RESOLVED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc>http://fi.wikipedia.org/w/api.php?action=query&amp;prop=revisions&amp;rvprop=content&amp;rvsection=0&amp;format=xml&amp;titles=Dio</bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P1</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>2.0</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Calum L">caluml</reporter>
          <assigned_to name="Jeremie Bresson">dev</assigned_to>
          <cc>a.c.kalker</cc>
    
    <cc>dev</cc>
    
    <cc>steffen.pingel</cc>
          <qa_contact name="David Green">david.green</qa_contact>
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2308190</commentid>
    <comment_count>0</comment_count>
    <who name="Calum L">caluml</who>
    <bug_when>2013-09-18 04:02:40 -0400</bug_when>
    <thetext>Hello all,

I am using Wikitext 1.9.0.20130621-1305 to convert from Mediawiki to HTML.
With a certain piece of text, it gets stuck in a loop.
I think the text is valid. Either way, I don&apos;t think it should get stuck in a loop forever.
It comes from the Finnish Wikipedia page for &quot;Dio&quot;.

The problem is the following line:
&lt;!--              --&gt;{{Yhtye/tietorivi|[[Universal Music Group]]}}&lt;!--              --&gt;{{Yhtye/tietorivi|Vertigo Records}}

When the second &quot;part&quot; of the line is brought down onto its own line, it works fine.
It also works fine as it is if it is the last line of the infobox.


I have included a JUnit test which demonstrates the problem.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2308191</commentid>
    <comment_count>1</comment_count>
      <attachid>235587</attachid>
    <who name="Calum L">caluml</who>
    <bug_when>2013-09-18 04:03:26 -0400</bug_when>
    <thetext>Created attachment 235587
JUnit test which currently fails</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2321232</commentid>
    <comment_count>2</comment_count>
    <who name="David Green">david.green</who>
    <bug_when>2013-10-21 13:08:31 -0400</bug_when>
    <thetext>Thanks for the bug Calum.  Can you add the specific JVM version that you&apos;re using to this bug?  Sometimes that makes a difference since we&apos;re using regular expressions.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2321555</commentid>
    <comment_count>3</comment_count>
    <who name="Calum L">caluml</who>
    <bug_when>2013-10-22 06:23:29 -0400</bug_when>
    <thetext>Hey David,

JDK 1.6.0_25 seems to be what Eclipse is configured to run currently.

java version &quot;1.6.0_25&quot;
Java(TM) SE Runtime Environment (build 1.6.0_25-b06)
Java HotSpot(TM) 64-Bit Server VM (build 20.0-b11, mixed mode)

It looks like the Oracle JDK, which is strange, as I&apos;d usually use the OpenJDK one.
I have this file in my Downloads, which must be what I used. jdk-6u25-linux-x64.bin
I think I had a problem in the OpenJDK one a while ago, and perhaps I switched to the Oracle one to resolve it.

I followed the code looping around, and it didn&apos;t seem to be to do with regex - but I didn&apos;t look too deeply.


Calum</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2321590</commentid>
    <comment_count>4</comment_count>
    <who name="Jeremie Bresson">dev</who>
    <bug_when>2013-10-22 07:12:37 -0400</bug_when>
    <thetext>Reduced example:

public void testParserShouldNotTimeout() {
	String input = &quot;&lt;!-- X --&gt;Lorem&lt;!-- Y --&gt;Ipsum\n&quot; + &quot;&lt;!-- Z --&gt;&quot;;

	String html = parser.parseToHtml(input);
	TestUtil.println(html);
	assertTrue(html.contains(&quot;XXX&quot;)); //TODO fix the assert.
}

Added in class MediaWikiLanguageTest.

The assertTrue(..) line is never executed. 
I will try to debug it this evening, to see what is going wrong.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2321838</commentid>
    <comment_count>5</comment_count>
    <who name="Jeremie Bresson">dev</who>
    <bug_when>2013-10-22 14:15:31 -0400</bug_when>
    <thetext>Here a Gerrit Change with the proposed JUnit test and a solution:
https://git.eclipse.org/r/17659

It does the job but I am not sure this is the solution.

Two questions:
1/ Are you sure that CommentBlock should be the ParagraphBreakingBlocks?
Why is there a NESTED_BLOCK_START_PATTERN after the ParagraphBreakingBlocks Check?
I wanted to have a look with a Code Coverage tool, because I do not see when this code is used.

2/ Are you sure that findCloseOffset can return -1? It seems to me, that by returning -1, the ParagraphBlock instance is never poped from the nestedBlocks stack.
=&gt; Maybe with an other value, my change in canResume(..) would not be necessary.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2321955</commentid>
    <comment_count>6</comment_count>
    <who name="David Green">david.green</who>
    <bug_when>2013-10-22 22:36:34 -0400</bug_when>
    <thetext>Jeremie, thanks for your excellent work.  I&apos;ve pushed an updated patchset to the review that includes your test but provides an alternate solution.  Please take a look and let me know what you think.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2321963</commentid>
    <comment_count>7</comment_count>
    <who name="Jeremie Bresson">dev</who>
    <bug_when>2013-10-23 00:13:58 -0400</bug_when>
    <thetext>Keeping closed blocks in nestedBlocks is wrong. Your solution that pop them from the stack is good.

I still think that the nested-protocol in MediaWiki ParagraphBlock is not so well implemented: findCloseOffset(..) should not always return -1.

Your change makes MarkupLanguage more robust -&gt; this is good.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2322210</commentid>
    <comment_count>8</comment_count>
    <who name="David Green">david.green</who>
    <bug_when>2013-10-23 11:20:15 -0400</bug_when>
    <thetext>I&apos;ve merged review 17659, thanks Jeremie.

Calumn I&apos;ll close this one as resolved/fixed since the change fixes the problem in our tests.  If you can confirm that the fix works for you that would be great.  Feel free to reopen this bug if the problem comes up again.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2323538</commentid>
    <comment_count>9</comment_count>
    <who name="David Green">david.green</who>
    <bug_when>2013-10-25 19:04:47 -0400</bug_when>
    <thetext>*** Bug 402248 has been marked as a duplicate of this bug. ***</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="0"
              isprivate="0"
          >
            <attachid>235587</attachid>
            <date>2013-09-18 04:03:00 -0400</date>
            <delta_ts>2013-09-18 04:03:26 -0400</delta_ts>
            <desc>JUnit test which currently fails</desc>
            <filename>file_417481.txt</filename>
            <type>text/plain</type>
            <size>1447</size>
            <attacher name="Calum L">caluml</attacher>
            
              <data encoding="base64">ICAgIEBUZXN0KHRpbWVvdXQgPSAyMDAwKQ0KICAgIHB1YmxpYyB2b2lkIFBhcnNlcl9zaG91bGRf
bm90X3RpbWVvdXQoKSB7DQogICAgICAgIFN0cmluZyBpbnB1dCA9ICJ7e1lodHllL3RpZXRvcml2
aXxFYWdsZSBSZWNvcmRzfX1cbiINCiAgICAgICAgICAgICAgICArICI8IS0tICAgICAgICAgICAg
ICAtLT57e1lodHllL3RpZXRvcml2aXxbW1JlcHJpc2UgUmVjb3Jkc11dfX08IS0tICAgICAgICAg
ICAgICAtLT57e1lodHllL3RpZXRvcml2aXxQaG9ub2dyYW0gUmVjb3Jkc319XG4iDQogICAgICAg
ICAgICAgICAgKyAiPCEtLSAgICAgICAgICAgICAgLS0+e3tZaHR5ZS90aWV0b3Jpdml8W1tTYW5j
dHVhcnkgUmVjb3Jkc11dfX1cbiINCiAgICAgICAgICAgICAgICArICJ9fVxuIg0KICAgICAgICAg
ICAgICAgICsgIlxuIg0KICAgICAgICAgICAgICAgICsgIicnJ0RpbycnJyBvbGkgW1tZaGR5c3Zh
bGxhdHx5aGR5c3ZhbHRhbGFpbmVuXV0gW1ttZXRhbGxpbXVzaWlra2l8aGVhdnkgbWV0YWxdXSAt
eWh0eWUsIGpvdGEgam9odGkgc29saXN0aSBbW1Jvbm5pZSBKYW1lcyBEaW9dXSAoUm9uYWxkIFBh
ZGF2b25hKSwgam9rYSBwZXJ1c3RpIERpb24gbG9rYWt1dXNzYSBbWzE5ODJdXSBqw6R0ZXR0ecOk
w6RuIFtbQmxhY2sgU2FiYmF0aF1daW4uIEFsa3VwZXLDpGlzZWVuIGtva29vbnBhbm9vbiBSb25u
aWVuIGxpc8Oka3NpIGt1dWx1aXZhdCBbW1ZpdmlhbiBDYW1wYmVsbF1dIGtpdGFyYXNzYSwgSmlt
bXkgQmFpbiBiYXNzb3NzYSBqYSBbW1Zpbm55IEFwcGljZV1dIHJ1bW11aXNzYS4gWWh0eWVlbiBh
bGJ1bWVpdGEgb24gbXl5dHkgbWFhaWxtYW5sYWFqdWlzZXN0aSB5bGkgNDcgbWlsam9vbmFhLiBE
aW9uIGt1dWx1aXNpbXBpYSBrYXBwYWxlaXRhIG92YXQgbW0uIFwiW1tIb2x5IERpdmVyIChrYXBw
YWxlKXxIb2x5IERpdmVyXV1cIiwgXCJbW1JhaW5ib3cgSW4gVGhlIERhcmtdXVwiLCBcIkRvbid0
IFRhbGsgVG8gU3RyYW5nZXJzXCIsIFwiU3RhbmQgVXAgQW5kIFNob3V0XCIsIFwiV2UgUm9ja1wi
LCBcIlRoZSBMYXN0IEluIExpbmVcIiwgXCJFdmlsIEV5ZXNcIiwgXCJSb2NrICdOJyBSb2xsIENo
aWxkcmVuXCIgamEgXCJIdW5ncnkgRm9yIEhlYXZlblwiLiBbaHR0cDovL3d3dy53b3JkcmVmZXJl
bmNlLmNvbS9pdGVuL2Rpb10iOw0KDQogICAgICAgIFN0cmluZ1dyaXRlciB3cml0ZXIgPSBuZXcg
U3RyaW5nV3JpdGVyKCk7DQogICAgICAgIEh0bWxEb2N1bWVudEJ1aWxkZXIgYnVpbGRlciA9IG5l
dyBIdG1sRG9jdW1lbnRCdWlsZGVyKHdyaXRlcik7DQogICAgICAgIE1hcmt1cFBhcnNlciBwYXJz
ZXIgPSBuZXcgTWFya3VwUGFyc2VyKFNlcnZpY2VMb2NhdG9yLmdldEluc3RhbmNlKCkuZ2V0TWFy
a3VwTGFuZ3VhZ2UoIk1lZGlhV2lraSIpLCBidWlsZGVyKTsNCiAgICAgICAgcGFyc2VyLnBhcnNl
KGlucHV0LCBmYWxzZSk7DQogICAgfQ==
</data>

          </attachment>
      

    </bug>

</bugzilla>