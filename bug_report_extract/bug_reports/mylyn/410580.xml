<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>410580</bug_id>
          
          <creation_ts>2013-06-12 07:00:00 -0400</creation_ts>
          <short_desc>[regression] Internal Exception: Parent and local keys must be specified when adding comment</short_desc>
          <delta_ts>2013-12-19 13:18:09 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>14</classification_id>
          <classification>Mylyn</classification>
          <product>Mylyn Reviews</product>
          <component>Framework</component>
          <version>unspecified</version>
          <rep_platform>Macintosh</rep_platform>
          <op_sys>Mac OS X</op_sys>
          <bug_status>REOPENED</bug_status>
          <resolution></resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P2</priority>
          <bug_severity>major</bug_severity>
          <target_milestone>---</target_milestone>
          
          <blocked>415490</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Steffen Pingel">steffen.pingel</reporter>
          <assigned_to name="Project Inbox">mylyn-triaged</assigned_to>
          <cc>milesparker</cc>
    
    <cc>tomasz.zarna</cc>
          
          <votes>0</votes>

      

      

      <flag name="documentation"
          id="58553"
          type_id="4"
          status="+"
          setter="sam.davis"
    />

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2271738</commentid>
    <comment_count>0</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-06-12 07:00:16 -0400</bug_when>
    <thetext>What steps will reproduce the problem?
1. 
2. 
3. 

Steps:
1. Compare with Base
2. Add comment from compare editor

-- Error Details --
Date: Wed Jun 12 12:57:07 CEST 2013
Message: Unhandled event loop exception
Severity: Error
Product: Eclipse SDK 3.8.2.v201301310800 (org.eclipse.sdk.ide)

Exception Stack Trace:
java.lang.RuntimeException: Internal Exception: Parent and local keys must be specified.
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory$UniqueLocalReference.&lt;init&gt;(AbstractRemoteEmfFactory.java:59)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory.findConsumer(AbstractRemoteEmfFactory.java:263)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory.getConsumerForLocalKey(AbstractRemoteEmfFactory.java:176)
	at org.eclipse.mylyn.internal.reviews.ui.dialogs.AddCommentDialog.performOperation(AddCommentDialog.java:146)
	at org.eclipse.mylyn.internal.reviews.ui.dialogs.AddCommentDialog.close(AddCommentDialog.java:83)
	at org.eclipse.jface.dialogs.Dialog.okPressed(Dialog.java:940)
	at org.eclipse.jface.dialogs.Dialog.buttonPressed(Dialog.java:472)
	at org.eclipse.mylyn.reviews.ui.ProgressDialog.access$1(ProgressDialog.java:1)
	at org.eclipse.mylyn.reviews.ui.ProgressDialog$2.widgetSelected(ProgressDialog.java:265)
	at org.eclipse.swt.widgets.TypedListener.handleEvent(TypedListener.java:248)
	at org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:84)
	at org.eclipse.swt.widgets.Display.sendEvent(Display.java:4136)
	at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1458)
	at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1481)
	at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1466)
	at org.eclipse.swt.widgets.Widget.notifyListeners(Widget.java:1271)
	at org.eclipse.swt.widgets.Display.runDeferredEvents(Display.java:3982)
	at org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3621)
	at org.eclipse.jface.window.Window.runEventLoop(Window.java:825)
	at org.eclipse.jface.window.Window.open(Window.java:801)
	at org.eclipse.mylyn.internal.reviews.ui.actions.AddLineCommentToFileAction.run(AddLineCommentToFileAction.java:119)
	at org.eclipse.mylyn.internal.reviews.ui.actions.AbstractReviewAction.run(AbstractReviewAction.java:49)
	at org.eclipse.ui.actions.BaseSelectionListenerAction.runWithEvent(BaseSelectionListenerAction.java:168)
	at org.eclipse.jface.action.ActionContributionItem.handleWidgetSelection(ActionContributionItem.java:584)
	at org.eclipse.jface.action.ActionContributionItem.access$2(ActionContributionItem.java:501)
	at org.eclipse.jface.action.ActionContributionItem$5.handleEvent(ActionContributionItem.java:411)
	at org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:84)
	at org.eclipse.swt.widgets.Display.sendEvent(Display.java:4136)
	at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1458)
	at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1481)
	at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1466)
	at org.eclipse.swt.widgets.Widget.notifyListeners(Widget.java:1271)
	at org.eclipse.swt.widgets.Display.runDeferredEvents(Display.java:3982)
	at org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3621)
	at org.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:2701)
	at org.eclipse.ui.internal.Workbench.runUI(Workbench.java:2665)
	at org.eclipse.ui.internal.Workbench.access$4(Workbench.java:2499)
	at org.eclipse.ui.internal.Workbench$7.run(Workbench.java:679)
	at org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:332)
	at org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:668)
	at org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:149)
	at org.eclipse.ui.internal.ide.application.IDEApplication.start(IDEApplication.java:124)
	at org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:196)
	at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:110)
	at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:79)
	at org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:353)
	at org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:180)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:601)
	at org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:629)
	at org.eclipse.equinox.launcher.Main.basicRun(Main.java:584)
	at org.eclipse.equinox.launcher.Main.run(Main.java:1438)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2271739</commentid>
    <comment_count>1</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-06-12 07:02:34 -0400</bug_when>
    <thetext>The comment was added but I still got the error which made it seem like the submission failed.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2271757</commentid>
    <comment_count>2</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-06-12 07:59:13 -0400</bug_when>
    <thetext>Let&apos;s disregard this for now. I was running an older build.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2271963</commentid>
    <comment_count>3</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-12 12:12:42 -0400</bug_when>
    <thetext>Whew. I thought I&apos;d seen the last of that bug.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2272389</commentid>
    <comment_count>4</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-06-13 08:56:46 -0400</bug_when>
    <thetext>Clearly saw this exception now with a new review that I hadn&apos;t looked at before using the release build when adding a comment:

java.lang.RuntimeException: Internal Exception: Parent and local keys must be specified.
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory$UniqueLocalReference.&lt;init&gt;(AbstractRemoteEmfFactory.java:59)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory.findConsumer(AbstractRemoteEmfFactory.java:263)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory.getConsumerForLocalKey(AbstractRemoteEmfFactory.java:176)
	at org.eclipse.mylyn.internal.reviews.ui.dialogs.AddCommentDialog.performOperation(AddCommentDialog.java:146)
	at org.eclipse.mylyn.internal.reviews.ui.dialogs.AddCommentDialog.close(AddCommentDialog.java:83)
	at org.eclipse.jface.dialogs.Dialog.okPressed(Dialog.java:940)
	at org.eclipse.jface.dialogs.Dialog.buttonPressed(Dialog.java:472)
	at org.eclipse.mylyn.reviews.ui.ProgressDialog.access$1(ProgressDialog.java:1)
	at org.eclipse.mylyn.reviews.ui.ProgressDialog$2.widgetSelected(ProgressDialog.java:265)
	at org.eclipse.swt.widgets.TypedListener.handleEvent(TypedListener.java:248)
	at org.eclipse.swt.widgets.EventTable.sendEvent(EventTable.java:84)
	at org.eclipse.swt.widgets.Display.sendEvent(Display.java:4136)
	at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1458)
	at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1481)
	at org.eclipse.swt.widgets.Widget.sendEvent(Widget.java:1466)
	at org.eclipse.swt.widgets.Widget.notifyListeners(Widget.java:1271)
	at org.eclipse.swt.widgets.Display.runDeferredEvents(Display.java:3982)
	at org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3621)
	at org.eclipse.jface.window.Window.runEventLoop(Window.java:825)
	at org.eclipse.jface.window.Window.open(Window.java:801)
	at org.eclipse.mylyn.internal.reviews.ui.actions.AddLineCommentToFileAction.run(AddLineCommentToFileAction.java:119)
	at org.eclipse.mylyn.internal.reviews.ui.actions.AbstractReviewAction.run(AbstractReviewAction.java:49)
	at org.eclipse.ui.actions.BaseSelectionListenerAction.runWithEvent(BaseSelectionListenerAction.java:168)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2272521</commentid>
    <comment_count>5</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-13 13:13:39 -0400</bug_when>
    <thetext>(In reply to comment #4)
&gt; Clearly saw this exception now with a new review that I hadn&apos;t looked at before
&gt; using the release build when adding a comment:

Ok, do you have a specific review and file item you&apos;re seeing it on? Is it all file items within a given patch set? All file items within any patch set?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2272599</commentid>
    <comment_count>6</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-06-13 16:46:28 -0400</bug_when>
    <thetext>I saw this with our internal Gerrit. I&apos;ll keep watching for it on Eclipse.org reviews and try to provide steps to reproduce.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2272619</commentid>
    <comment_count>7</comment_count>
    <who name="Sam Davis">sam.davis</who>
    <bug_when>2013-06-13 17:39:50 -0400</bug_when>
    <thetext>I have seen this several times running on the latest.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2272621</commentid>
    <comment_count>8</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-13 17:44:02 -0400</bug_when>
    <thetext>My *guess* is that it is caused by bug 410532.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2272939</commentid>
    <comment_count>9</comment_count>
    <who name="Sam Davis">sam.davis</who>
    <bug_when>2013-06-14 13:30:05 -0400</bug_when>
    <thetext>I am seeing this on reviews that have no drafts currently.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2275298</commentid>
    <comment_count>10</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-20 19:09:46 -0400</bug_when>
    <thetext>https://git.eclipse.org/r/#/c/13965/</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2275303</commentid>
    <comment_count>11</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-20 19:25:53 -0400</bug_when>
    <thetext>Merged https://git.eclipse.org/r/#/c/13965/

Note that this was caused by the code attempting to update observers for any review item set contents. The code allows the Review Explorer to immediately update with the new comment count and contents. However, in the case of a compare set, the review item set (e.g. Gerrit patch set) isn&apos;t actually contained in a model (because it isn&apos;t a permanent part of the review). The IFileVersions and IFiles themselves is generated from the patch sets freshly, even if a corresponding file already exists. So unfortunatetly, this means that in this case we won&apos;t be able to update the Review Explorer automatically.

We could do something like temporarily add the compare to the patch set and search to match the IFile but I think that adds a lot of complexity for very little gain.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2289825</commentid>
    <comment_count>12</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-07-30 13:42:01 -0400</bug_when>
    <thetext>Just hit this again while opening and closing (quickly) a review that was in the process of being synchronized. This was with 2.0.1.20130712.

java.lang.RuntimeException: Internal Exception: Parent and local keys must be specified.
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory$UniqueLocalReference.&lt;init&gt;(AbstractRemoteEmfFactory.java:59)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory.findConsumer(AbstractRemoteEmfFactory.java:263)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory.getConsumerForModel(AbstractRemoteEmfFactory.java:250)
	at org.eclipse.mylyn.internal.gerrit.core.remote.PatchSetDetailRemoteFactory.getRemoteObjectForLocalKey(PatchSetDetailRemoteFactory.java:90)
	at org.eclipse.mylyn.internal.gerrit.core.remote.PatchSetDetailRemoteFactory.getRemoteObjectForLocalKey(PatchSetDetailRemoteFactory.java:1)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory.getRemoteKeyForLocalKey(AbstractRemoteEmfFactory.java:334)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.RemoteEmfConsumer.pull(RemoteEmfConsumer.java:148)
	at org.eclipse.mylyn.internal.gerrit.core.remote.PatchSetContentIdRemoteFactory.pull(PatchSetContentIdRemoteFactory.java:43)
	at org.eclipse.mylyn.internal.gerrit.core.remote.PatchSetContentIdRemoteFactory.pull(PatchSetContentIdRemoteFactory.java:1)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.RemoteEmfConsumer.pull(RemoteEmfConsumer.java:164)
	at org.eclipse.mylyn.reviews.core.spi.remote.JobRemoteService$1.run(JobRemoteService.java:60)
	at org.eclipse.core.internal.jobs.Worker.run(Worker.java:54)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2290829</commentid>
    <comment_count>13</comment_count>
    <who name="Sam Davis">sam.davis</who>
    <bug_when>2013-08-01 19:03:52 -0400</bug_when>
    <thetext>I still get this sometimes when opening reviews. Once it happens, sometimes I can&apos;t refresh the review until I restart.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2296176</commentid>
    <comment_count>14</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-08-19 07:27:57 -0400</bug_when>
    <thetext>I saw this bug when I opened and closed a review while background synchronization was still in progress. I was wondering if cancelation could somehow contribute to this bug.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2296407</commentid>
    <comment_count>15</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-08-19 13:50:23 -0400</bug_when>
    <thetext>Miles, could this be the same problem discussed on bug 414799 where closing of the AbstractRemoteEditFactoryProvider clears references that are still in use by other consumers of the model? From looking at the code it&apos;s not quite clear to me what references are removed there.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2296838</commentid>
    <comment_count>16</comment_count>
    <who name="Tomasz Zarna">tomasz.zarna</who>
    <bug_when>2013-08-20 10:18:44 -0400</bug_when>
    <thetext>(In reply to comment #15)
&gt; Miles, could this be the same problem discussed on bug 414799

I&apos;m not 100% sure if this is the same problem, but I got a similar exception quite often when trying to reproduce the other bug. _Parent and local keys must be specified._ often followed the NPE in Review Explorer.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2297883</commentid>
    <comment_count>17</comment_count>
    <who name="Tomasz Zarna">tomasz.zarna</who>
    <bug_when>2013-08-22 10:07:26 -0400</bug_when>
    <thetext>Trying out https://git.eclipse.org/r/#/c/15004/9 :

java.lang.RuntimeException: Internal Exception: Parent and local keys must be specified.
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory$UniqueLocalReference.&lt;init&gt;(AbstractRemoteEmfFactory.java:58)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory.findConsumer(AbstractRemoteEmfFactory.java:262)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory.getConsumerForModel(AbstractRemoteEmfFactory.java:249)
	at org.eclipse.mylyn.internal.gerrit.core.remote.PatchSetDetailRemoteFactory.getRemoteObjectForLocalKey(PatchSetDetailRemoteFactory.java:90)
	at org.eclipse.mylyn.internal.gerrit.core.remote.PatchSetDetailRemoteFactory.getRemoteObjectForLocalKey(PatchSetDetailRemoteFactory.java:1)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.AbstractRemoteEmfFactory.getRemoteKeyForLocalKey(AbstractRemoteEmfFactory.java:333)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.RemoteEmfConsumer.pull(RemoteEmfConsumer.java:121)
	at org.eclipse.mylyn.internal.gerrit.core.remote.PatchSetContentIdRemoteFactory.pull(PatchSetContentIdRemoteFactory.java:43)
	at org.eclipse.mylyn.internal.gerrit.core.remote.PatchSetContentIdRemoteFactory.pull(PatchSetContentIdRemoteFactory.java:1)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.RemoteEmfConsumer.pull(RemoteEmfConsumer.java:127)
	at org.eclipse.mylyn.reviews.core.spi.remote.JobRemoteService$1.run(JobRemoteService.java:60)
	at org.eclipse.core.internal.jobs.Worker.run(Worker.java:54)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2297887</commentid>
    <comment_count>18</comment_count>
    <who name="Tomasz Zarna">tomasz.zarna</who>
    <bug_when>2013-08-22 10:09:28 -0400</bug_when>
    <thetext>(In reply to comment #17)
&gt; Trying out https://git.eclipse.org/r/#/c/15004/9 :
&gt; 
&gt; java.lang.RuntimeException: Internal Exception: Parent and local keys must
&gt; be specified.
&gt; 	at
&gt; org.eclipse.mylyn.reviews.core.spi.remote.emf.
&gt; AbstractRemoteEmfFactory$UniqueLocalReference.
&gt; &lt;init&gt;(AbstractRemoteEmfFactory.java:58)

This is almost identical to comment 12.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2298045</commentid>
    <comment_count>19</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-08-22 13:27:56 -0400</bug_when>
    <thetext>Yeah this is clearly a result of bug 415490. We&apos;re attempting to find a given review for the supplied Patch Set. But the Review&apos;s consumer has been disposed and so that review is no longer associated w/ a patch set.

One approach to look at is to special case the Review remote Factory so that it will find and set the repository if it isn&apos;t currently associated with the review.

Overall, perhaps we&apos;re being too aggressive with disposing these reviews. I hate to say it, because it&apos;s not a very nice solution from an engineering standpoint, and we should address the root concern, but these issues would go away if we simply let the reviews dwell for a while, or even waited to dispose them until workbench exit. I think in some sense the current solution is overly sophisticated...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2319861</commentid>
    <comment_count>20</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-10-17 16:42:00 -0400</bug_when>
    <thetext>Reassigning to default as I&apos;m not sure how much time I&apos;ll be able to devote to this.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>