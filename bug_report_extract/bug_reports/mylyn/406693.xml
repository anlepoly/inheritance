<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>406693</bug_id>
          
          <creation_ts>2013-04-26 13:31:00 -0400</creation_ts>
          <short_desc>fix Gerrit Synchronization Test</short_desc>
          <delta_ts>2013-05-03 10:40:22 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>14</classification_id>
          <classification>Mylyn</classification>
          <product>Mylyn Reviews</product>
          <component>Gerrit Connector</component>
          <version>unspecified</version>
          <rep_platform>Macintosh</rep_platform>
          <op_sys>Mac OS X</op_sys>
          <bug_status>RESOLVED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>---</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Miles Parker">milesparker</reporter>
          <assigned_to name="Steffen Pingel">steffen.pingel</assigned_to>
          <cc>sebastien.dubois</cc>
    
    <cc>steffen.pingel</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2249132</commentid>
    <comment_count>0</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-04-26 13:31:18 -0400</bug_when>
    <thetext>All of the CI tests have started failing as of yesterday PM. This is what I&apos;m seeing in log:

Running testSynchronizeQueryNewTask(org.eclipse.mylyn.gerrit.tests.core.GerritSynchronizationTest)
Test testSynchronizeQueryNewTask(org.eclipse.mylyn.gerrit.tests.core.GerritSynchronizationTest) is taking too long:
Thread[Bundle File Closer,5,main]
  java.lang.Object.wait(Native Method)
  java.lang.Object.wait(Object.java:485)
  org.eclipse.osgi.framework.eventmgr.EventManager$EventThread.getNextEvent(EventManager.java:400)
  org.eclipse.osgi.framework.eventmgr.EventManager$EventThread.run(EventManager.java:336)

https://hudson.eclipse.org/sandbox/job/mylyn-reviews-gerrit/394/console

Steffen, is this simply a matter of upping a timeout somewhere (?), or could there be something else that might be causing this to choke? The failure is proximiate to the test changes I made, but those tests passed initially, and were failing before we even get there.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2249136</commentid>
    <comment_count>1</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-04-26 13:40:19 -0400</bug_when>
    <thetext>Here is the full stack trace:

Thread[main,6,main]
  org.eclipse.swt.internal.gtk.OS._gtk_dialog_run(Native Method)
  org.eclipse.swt.internal.gtk.OS.gtk_dialog_run(OS.java:6591)
  org.eclipse.swt.widgets.MessageBox.open(MessageBox.java:189)
  org.eclipse.swt.browser.PromptService2.Alert(PromptService2.java:198)
  org.eclipse.swt.browser.PromptService2$3.method3(PromptService2.java:71)
  org.eclipse.swt.internal.mozilla.XPCOMObject.callback3(XPCOMObject.java:266)
  org.eclipse.swt.internal.gtk.OS._g_main_context_iteration(Native Method)
  org.eclipse.swt.internal.gtk.OS.g_main_context_iteration(OS.java:2276)
  org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3207)
  org.eclipse.ui.internal.dialogs.EventLoopProgressMonitor.runEventLoop(EventLoopProgressMonitor.java:123)
  org.eclipse.ui.internal.dialogs.EventLoopProgressMonitor.isCanceled(EventLoopProgressMonitor.java:97)
  org.eclipse.core.internal.jobs.JobManager.join(JobManager.java:921)
  org.eclipse.mylyn.gerrit.tests.core.GerritSynchronizationTest.synchronizeAllTasks(GerritSynchronizationTest.java:172)
  org.eclipse.mylyn.gerrit.tests.core.GerritSynchronizationTest.createAndSynchronizeQuery(GerritSynchronizationTest.java:158)
  org.eclipse.mylyn.gerrit.tests.core.GerritSynchronizationTest.testSynchronizeQueryNewTask(GerritSynchronizationTest.java:106)
  
It looks like a test opened an internal browser that prompts for credentials and this is blocking the UI thread.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2249145</commentid>
    <comment_count>2</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-04-26 13:52:48 -0400</bug_when>
    <thetext>Hmmm.. don&apos;t know what&apos;s happening here then ... the test occurs before any of the new/changed tests even run, and it happens on multiple changes against master, which didn&apos;t fail, though there was an issue with first an unexpected user name (I fixed that on test server) and then with a timeout set too low. I&apos;m going to bump that timeout value up and trigger a new test.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2249215</commentid>
    <comment_count>3</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-04-26 16:50:52 -0400</bug_when>
    <thetext>This is not related to the timeout. One of the tests is opening a browser that&apos;s blocking the test. These failures happened sporadically before but no one cared to look into it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2249221</commentid>
    <comment_count>4</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-04-26 17:00:43 -0400</bug_when>
    <thetext>(In reply to comment #3)
&gt; This is not related to the timeout. One of the tests is opening a browser that&apos;s
&gt; blocking the test. These failures happened sporadically before but no one cared
&gt; to look into it.

Yeah, that&apos;s what I&apos;m saying -- they&apos;re unrelated. :) I don&apos;t know anything about this issue -- is there a bug open for it? -- nor why it has suddenly picked today to start barfing. I&apos;ve seen the test running locally and was wondering what was going on there. If you have an idea of a relatively simple test, I can take a look, but have really limited time. I hate to suggest this, but can we just kill the test for now? It&apos;s blocking us being able to confirm a lot of stuff that does need to be exercised -- like bug 405138.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2249234</commentid>
    <comment_count>5</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-04-26 17:14:52 -0400</bug_when>
    <thetext>(In reply to comment #4)
&gt; Yeah, that&apos;s what I&apos;m saying -- they&apos;re unrelated. :) I don&apos;t know anything
&gt; about this issue -- is there a bug open for it? 

Yes, this bug :).

&gt; I hate to suggest this, but can we just kill the test for now?

Well, that&apos;s part of the problem we have to figure out which test is opening the browser. The test hangs because it spins the UI thread not because it opened the browser necessarily. So, no :).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2249243</commentid>
    <comment_count>6</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-04-26 17:45:27 -0400</bug_when>
    <thetext>(In reply to comment #5)
&gt; Yes, this bug :).

You mean this one that I just created? ;P

&gt; Well, that&apos;s part of the problem we have to figure out which test is opening the
&gt; browser. The test hangs because it spins the UI thread not because it opened the
&gt; browser necessarily. So, no :).

Ok I have a working hypothesis. I note that this started just after I started spamming the Gerrit host with lot&apos;s of newly created reviews. I note that the synchornization test now takes a long time even on my local machine; like 90 seconds. Thinking maybe we&apos;ll want to synchronize against a more limited query or something.  Investigating..</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2249248</commentid>
    <comment_count>7</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-04-26 18:05:16 -0400</bug_when>
    <thetext>I think what is happening is that GerritUrlHandlerTest opens a browser for https://git.eclipse.org/r which has a certificate that is not recognized by Mozilla which causes the modal dialog to pop up. Here is a fix: https://git.eclipse.org/r/#/c/12257/..

I&apos;m looking at speeding up tests.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2249252</commentid>
    <comment_count>8</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-04-26 18:28:28 -0400</bug_when>
    <thetext>(In reply to comment #7)
&gt; I think what is happening is that GerritUrlHandlerTest opens a browser for
&gt; https://git.eclipse.org/r which has a certificate that is not recognized by
&gt; Mozilla which causes the modal dialog to pop up. Here is a fix:
&gt; https://git.eclipse.org/r/#/c/12257/..

Great, taking a look now.

&gt; 
&gt; I&apos;m looking at speeding up tests.

Beat you to it:

This one just searches for the first review. (And should fix bug 405138)

https://git.eclipse.org/r/#/c/12258/</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2249347</commentid>
    <comment_count>9</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-04-27 06:04:16 -0400</bug_when>
    <thetext>The fix was committed.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2252064</commentid>
    <comment_count>10</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-05-03 10:40:22 -0400</bug_when>
    <thetext>Turns out there is another problem that causes a synchronization job to be re-scheduled all the time which frequently causes the Gerrit tests to still fail: https://git.eclipse.org/r/#/c/12491/.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>