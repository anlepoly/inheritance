<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>410597</bug_id>
          
          <creation_ts>2013-06-12 09:34:00 -0400</creation_ts>
          <short_desc>[regression] NPE when querying and configuration is not cached</short_desc>
          <delta_ts>2013-12-19 13:15:59 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>14</classification_id>
          <classification>Mylyn</classification>
          <product>Mylyn Reviews</product>
          <component>Gerrit Connector</component>
          <version>2.0</version>
          <rep_platform>All</rep_platform>
          <op_sys>All</op_sys>
          <bug_status>REOPENED</bug_status>
          <resolution></resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P2</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>---</target_milestone>
          <dependson>419700</dependson>
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Steffen Pingel">steffen.pingel</reporter>
          <assigned_to name="Project Inbox">mylyn-triaged</assigned_to>
          <cc>milesparker</cc>
    
    <cc>tomasz.zarna</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2271814</commentid>
    <comment_count>0</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-06-12 09:34:26 -0400</bug_when>
    <thetext>Steps:
1. Connect as anonymous
2. Create a query to bring in all reviews

Caused by: java.lang.NullPointerException
	at org.eclipse.mylyn.internal.gerrit.core.remote.GerritReviewRemoteFactory.updateApprovalsAndRequirements(GerritReviewRemoteFactory.java:261)
	at org.eclipse.mylyn.internal.gerrit.core.remote.GerritReviewRemoteFactory.updateModel(GerritReviewRemoteFactory.java:193)
	at org.eclipse.mylyn.internal.gerrit.core.remote.GerritReviewRemoteFactory.updateModel(GerritReviewRemoteFactory.java:1)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.RemoteEmfConsumer.applyModel(RemoteEmfConsumer.java:234)
	at org.eclipse.mylyn.reviews.core.spi.remote.JobRemoteService$3.run(JobRemoteService.java:100)
	at org.eclipse.ui.internal.UILockListener.doPendingWork(UILockListener.java:164)
	at org.eclipse.ui.internal.UISynchronizer$3.run(UISynchronizer.java:158)
	at org.eclipse.swt.widgets.RunnableLock.run(RunnableLock.java:35)
	at org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:135)
	... 23 more
	
If I synchronize tasks that never finishes:

&quot;Worker-3&quot; prio=5 tid=0x000000010200b000 nid=0x8d03 waiting on condition [0x0000000113ff7000]
   java.lang.Thread.State: TIMED_WAITING (sleeping)
	at java.lang.Thread.sleep(Native Method)
	at org.eclipse.mylyn.internal.gerrit.core.GerritTaskDataHandler.updateModelData(GerritTaskDataHandler.java:147)
	at org.eclipse.mylyn.internal.gerrit.core.GerritTaskDataHandler.getTaskData(GerritTaskDataHandler.java:107)
	at org.eclipse.mylyn.internal.gerrit.core.GerritConnector.getTaskData(GerritConnector.java:160)
	at org.eclipse.mylyn.internal.tasks.core.sync.SynchronizeTasksJob.synchronizeTask(SynchronizeTasksJob.java:245)
	at org.eclipse.mylyn.internal.tasks.core.sync.SynchronizeTasksJob.runInternal(SynchronizeTasksJob.java:218)
	at org.eclipse.mylyn.internal.tasks.core.sync.SynchronizeTasksJob.run(SynchronizeTasksJob.java:153)
	at org.eclipse.mylyn.internal.tasks.core.sync.SynchronizeTasksJob.run(SynchronizeTasksJob.java:135)
	at org.eclipse.mylyn.internal.tasks.core.sync.SynchronizeQueriesJob.run(SynchronizeQueriesJob.java:225)
	at org.eclipse.core.internal.jobs.Worker.run(Worker.java:53)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2271979</commentid>
    <comment_count>1</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-12 12:29:23 -0400</bug_when>
    <thetext>(In reply to comment #0)
&gt; Steps:
&gt; 1. Connect as anonymous
&gt; 2. Create a query to bring in all reviews
&gt; 
&gt; Caused by: java.lang.NullPointerException
&gt; at
&gt; org.eclipse.mylyn.internal.gerrit.core.remote.GerritReviewRemoteFactory.updateApprovalsAndRequirements(GerritReviewRemoteFactory.java:261)
&gt; at
&gt; org.eclipse.mylyn.internal.gerrit.core.remote.GerritReviewRemoteFactory.updateModel(GerritReviewRemoteFactory.java:193)
&gt; at
&gt; org.eclipse.mylyn.internal.gerrit.core.remote.GerritReviewRemoteFactory.updateModel(GerritReviewRemoteFactory.java:1)
&gt; at
&gt; org.eclipse.mylyn.reviews.core.spi.remote.emf.RemoteEmfConsumer.applyModel(RemoteEmfConsumer.java:234)
&gt; at
&gt; org.eclipse.mylyn.reviews.core.spi.remote.JobRemoteService$3.run(JobRemoteService.java:100)
&gt; at
&gt; org.eclipse.ui.internal.UILockListener.doPendingWork(UILockListener.java:164)
&gt; at org.eclipse.ui.internal.UISynchronizer$3.run(UISynchronizer.java:158)
&gt; at org.eclipse.swt.widgets.RunnableLock.run(RunnableLock.java:35)
&gt; at org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:135)
&gt; ... 23 more
&gt; 
&gt; If I synchronize tasks that never finishes:
&gt; 
&gt; &quot;Worker-3&quot; prio=5 tid=0x000000010200b000 nid=0x8d03 waiting on condition
&gt; [0x0000000113ff7000]
&gt; java.lang.Thread.State: TIMED_WAITING (sleeping)
&gt; at java.lang.Thread.sleep(Native Method)
&gt; at
&gt; org.eclipse.mylyn.internal.gerrit.core.GerritTaskDataHandler.updateModelData(GerritTaskDataHandler.java:147)
&gt; at
&gt; org.eclipse.mylyn.internal.gerrit.core.GerritTaskDataHandler.getTaskData(GerritTaskDataHandler.java:107)
&gt; at
&gt; org.eclipse.mylyn.internal.gerrit.core.GerritConnector.getTaskData(GerritConnector.java:160)
&gt; at
&gt; org.eclipse.mylyn.internal.tasks.core.sync.SynchronizeTasksJob.synchronizeTask(SynchronizeTasksJob.java:245)
&gt; at
&gt; org.eclipse.mylyn.internal.tasks.core.sync.SynchronizeTasksJob.runInternal(SynchronizeTasksJob.java:218)
&gt; at
&gt; org.eclipse.mylyn.internal.tasks.core.sync.SynchronizeTasksJob.run(SynchronizeTasksJob.java:153)
&gt; at
&gt; org.eclipse.mylyn.internal.tasks.core.sync.SynchronizeTasksJob.run(SynchronizeTasksJob.java:135)
&gt; at
&gt; org.eclipse.mylyn.internal.tasks.core.sync.SynchronizeQueriesJob.run(SynchronizeQueriesJob.java:225)
&gt; at org.eclipse.core.internal.jobs.Worker.run(Worker.java:53)

Does cancelling work? I initially had some timeout code in there, but then thought it better to just respect the user cancel, but if that isn&apos;t working we need a seperate bug for this.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2272070</commentid>
    <comment_count>2</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-12 14:24:01 -0400</bug_when>
    <thetext>(In reply to comment #0)
&gt; Steps:
&gt; 1. Connect as anonymous
&gt; 2. Create a query to bring in all reviews
&gt; 
&gt; Caused by: java.lang.NullPointerException
&gt; at
&gt; org.eclipse.mylyn.internal.gerrit.core.remote.GerritReviewRemoteFactory.updateApprovalsAndRequirements(GerritReviewRemoteFactory.java:261)
&gt; at

Hmm... I&apos;m not able to reproduce. The code does assume that you have a configuration. I wonder if that&apos;s a faulty assumption. Do you get the &quot;Retrieving Configuration&quot; message when you first create it? What&apos;s the exact query you&apos;re using? (I tried All Open.)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2272087</commentid>
    <comment_count>3</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-06-12 14:43:05 -0400</bug_when>
    <thetext>Canceling worked but the editor was not rendering properly since it never retrieved the model data.

I wasn&apos;t able to retrieve configuration. I assume that is what caused the subsequent failures.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2272091</commentid>
    <comment_count>4</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-12 14:47:25 -0400</bug_when>
    <thetext>(In reply to comment #3)
&gt; Canceling worked but the editor was not rendering properly since it never
&gt; retrieved the model data.

Right.

&gt; I wasn&apos;t able to retrieve configuration. I assume that is what caused the
&gt; subsequent failures.

Yes, exactly. It sounds like not being able to retrive the configuration is the real issue. I don&apos;t think it makes sense to guard against not having a configuration, since there is so much code that (reasonably, I think) relies on that.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2272118</commentid>
    <comment_count>5</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-06-12 15:21:07 -0400</bug_when>
    <thetext>(In reply to comment #4)
&gt; Yes, exactly. It sounds like not being able to retrive the configuration is the
&gt; real issue. I don&apos;t think it makes sense to guard against not having a
&gt; configuration, since there is so much code that (reasonably, I think) relies on
&gt; that.

All code that relies on configuration needs to retrieve it in case it&apos;s not cached. Configuration data could get lost for any reason so code should never just assume that it&apos;s there (maybe none of the code does that I haven&apos;t checked).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2272122</commentid>
    <comment_count>6</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-12 15:30:17 -0400</bug_when>
    <thetext>(In reply to comment #5)
&gt; All code that relies on configuration needs to retrieve it in case it&apos;s not
&gt; cached. Configuration data could get lost for any reason so code should never
&gt; just assume that it&apos;s there (maybe none of the code does that I haven&apos;t
&gt; checked).

I checked before my last comment, and I don&apos;t think any of the ~13 usages check for it, but perhaps there are some sort of higher level checks that I&apos;m missing. (Just to mention, I&apos;m pretty sure this was true of 1.1 as well.. )</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2273660</commentid>
    <comment_count>7</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-17 19:02:05 -0400</bug_when>
    <thetext>So, we do already do a GerritClient.refreshConfigOnce(new NullProgressMonitor()); every time before we do a review pull. The only thing I can think is that somehow the configuration went stale between the time we pulled and the time we tried to grab the other approvals. Or perhaps we should be forcing the config to refresh?

I&apos;m still unable to reproduce by changing config to anyonmous access, even after restarting, so it&apos;s difficult to determine for sure if that was the issue. Does it continue to fail after that query or does this just happen once?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2273669</commentid>
    <comment_count>8</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-17 20:14:49 -0400</bug_when>
    <thetext>https://git.eclipse.org/r/#/c/13861

I think the issue was much simpler, actually. I don&apos;t the NPE was in the configuration at all, but in the Approvals, which should be non-existent for the case of anonymous. So we just needed some more null checks here.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2273672</commentid>
    <comment_count>9</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-06-17 20:36:08 -0400</bug_when>
    <thetext>Merged https://git.eclipse.org/r/#/c/13861

Steffen, please reopen if you see this issue again.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2281162</commentid>
    <comment_count>10</comment_count>
    <who name="Tomasz Zarna">tomasz.zarna</who>
    <bug_when>2013-07-05 12:28:34 -0400</bug_when>
    <thetext>I ain&apos;t Steffen, but I just saw this. Created a query for all open reviews as anonymous, against a 2.5.4 repo. Running of master.

org.eclipse.swt.SWTException: Failed to execute runnable (java.lang.NullPointerException)
	at org.eclipse.swt.SWT.error(SWT.java:4361)
	at org.eclipse.swt.SWT.error(SWT.java:4276)
	at org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:138)
	at org.eclipse.swt.widgets.Display.runAsyncMessages(Display.java:4144)
	at org.eclipse.swt.widgets.Display.readAndDispatch(Display.java:3761)
	at org.eclipse.ui.internal.Workbench.runEventLoop(Workbench.java:2701)
	at org.eclipse.ui.internal.Workbench.runUI(Workbench.java:2665)
	at org.eclipse.ui.internal.Workbench.access$4(Workbench.java:2499)
	at org.eclipse.ui.internal.Workbench$7.run(Workbench.java:679)
	at org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:332)
	at org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:668)
	at org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:149)
	at org.eclipse.ui.internal.ide.application.IDEApplication.start(IDEApplication.java:124)
	at org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:196)
	at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:110)
	at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:79)
	at org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:353)
	at org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:180)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:601)
	at org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:629)
	at org.eclipse.equinox.launcher.Main.basicRun(Main.java:584)
	at org.eclipse.equinox.launcher.Main.run(Main.java:1438)
	at org.eclipse.equinox.launcher.Main.main(Main.java:1414)
Caused by: java.lang.NullPointerException
	at org.eclipse.mylyn.internal.gerrit.core.remote.GerritReviewRemoteFactory.updateModel(GerritReviewRemoteFactory.java:198)
	at org.eclipse.mylyn.internal.gerrit.core.remote.GerritReviewRemoteFactory.updateModel(GerritReviewRemoteFactory.java:1)
	at org.eclipse.mylyn.reviews.core.spi.remote.emf.RemoteEmfConsumer.applyModel(RemoteEmfConsumer.java:234)
	at org.eclipse.mylyn.reviews.core.spi.remote.JobRemoteService$3.run(JobRemoteService.java:95)
	at org.eclipse.ui.internal.UILockListener.doPendingWork(UILockListener.java:164)
	at org.eclipse.ui.internal.UISynchronizer$3.run(UISynchronizer.java:158)
	at org.eclipse.swt.widgets.RunnableLock.run(RunnableLock.java:35)
	at org.eclipse.swt.widgets.Synchronizer.runAsyncMessages(Synchronizer.java:135)
	... 23 more</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2281173</commentid>
    <comment_count>11</comment_count>
    <who name="Tomasz Zarna">tomasz.zarna</who>
    <bug_when>2013-07-05 12:36:07 -0400</bug_when>
    <thetext>(In reply to comment #10)
&gt; Caused by: java.lang.NullPointerException
&gt; 	at
&gt; org.eclipse.mylyn.internal.gerrit.core.remote.GerritReviewRemoteFactory.
&gt; updateModel(GerritReviewRemoteFactory.java:198)

GerritConfiguration is null as Anonymous cannot read the config, see bug 412102 comment 1</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2281558</commentid>
    <comment_count>12</comment_count>
    <who name="Tomasz Zarna">tomasz.zarna</who>
    <bug_when>2013-07-08 06:52:17 -0400</bug_when>
    <thetext>See also bug 412496, for an exception thrown when adding a comment as anonymous user.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2283461</commentid>
    <comment_count>13</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-07-11 13:08:13 -0400</bug_when>
    <thetext>https://git.eclipse.org/r/#/c/14454 or similar solution should address this.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2284002</commentid>
    <comment_count>14</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-07-12 13:43:54 -0400</bug_when>
    <thetext>The review does not address the problem. My guess is that the configuration is null because it hasn&apos;t been cached, yet. You should be able to reproduce that by shutting down Eclipse, deleting the configuration cache and restarting.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2284081</commentid>
    <comment_count>15</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-07-12 17:57:50 -0400</bug_when>
    <thetext>(In reply to comment #14)
&gt; The review does not address the problem. My guess is that the configuration
&gt; is null because it hasn&apos;t been cached, yet. You should be able to reproduce
&gt; that by shutting down Eclipse, deleting the configuration cache and
&gt; restarting.

I think that you can&apos;t get the configuration (it&apos;s really confusing because there are two if you include the Mylyn GerritConfiguration, here I&apos;m referring to the GerritConfig) at all in this case. I don&apos;t have the code in front of me (not at work today), but I think that&apos;s a central assumption of the change. But I could be wrong about that.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2284090</commentid>
    <comment_count>16</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-07-12 18:31:10 -0400</bug_when>
    <thetext>There are two scenarios:

1. The client has cached the configuration either in this session or a previous session. Both GerritConfiguration and GerritConfig are available.
2. The client has never cached the configuration because refreshConfigOnce() was not invoked or downloading of the configuration failed.

Any operation that relies on configuration (e.g. for approvals) needs to trigger a configuration download in scenario (2). If downloading fails the repository is not functional and the operation needs to fail.

The scenario where only GerritConfiguration but not GerritConfig exists doesn&apos;t make sense, they have a 1:1 entity relationship.

Problems could arise if the configuration was cached and gets lost (for whatever reason) and UI elements rely on it being there but can&apos;t refresh it from the UI thread or because a connection can&apos;t be established. That&apos;s the scenario that we need to look at and handle gracefully (so may actually need some null checks for GerritConfiguration but not GerritConfig).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2284556</commentid>
    <comment_count>17</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-07-15 13:02:16 -0400</bug_when>
    <thetext>Ok, where does Account fit into that? Because I don&apos;t think it&apos;s possible to have an Account without a valid login, is it? And it seemed that you couldn&apos;t get a GerritConfig either, but I could be wrong about that.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2284572</commentid>
    <comment_count>18</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-07-15 13:32:46 -0400</bug_when>
    <thetext>See bug 410597, I think Steffen is saying that the deeper issue is that we don&apos;t have a configuration and we should, not that we aren&apos;t properly checking for lack of configuration. I think we need to discuss how these two fit together.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2284602</commentid>
    <comment_count>19</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-07-15 14:38:29 -0400</bug_when>
    <thetext>Also note that this change handles one other issue. It supresses the user specific searches when we have an anonymous user.  See:

https://git.eclipse.org/r/#/c/14294/12/org.eclipse.mylyn.gerrit.ui/src/org/eclipse/mylyn/internal/gerrit/ui/wizards/GerritCustomQueryPage.java

Please let me know if you&apos;d like me to break any of these out into seperate reviews. :)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2284661</commentid>
    <comment_count>20</comment_count>
    <who name="Steffen Pingel">steffen.pingel</who>
    <bug_when>2013-07-15 16:22:15 -0400</bug_when>
    <thetext>(In reply to comment #19)
&gt; Also note that this change handles one other issue. It supresses the user
&gt; specific searches when we have an anonymous user.  See:
&gt; 
&gt; https://git.eclipse.org/r/#/c/14294/12/org.eclipse.mylyn.gerrit.ui/src/org/eclipse/mylyn/internal/gerrit/ui/wizards/GerritCustomQueryPage.java
&gt; 
&gt; Please let me know if you&apos;d like me to break any of these out into seperate
&gt; reviews. :)

That has always been broken as far as I know. I don&apos;t think hiding the UI elements is the a good solution though since it&apos;s not obvious what&apos;s going on. I&apos;d indeed prefer if you could file a separate bug (if we don&apos;t have one already) and split out the change.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2284692</commentid>
    <comment_count>21</comment_count>
    <who name="Miles Parker">milesparker</who>
    <bug_when>2013-07-15 17:08:30 -0400</bug_when>
    <thetext>(In reply to comment #20)
&gt; That has always been broken as far as I know. I don&apos;t think hiding the UI
&gt; elements is the a good solution though since it&apos;s not obvious what&apos;s going on.

Good point.

&gt; I&apos;d indeed prefer if you could file a separate bug (if we don&apos;t have one
&gt; already) and split out the change.

bug 413010 (It doesn&apos;t make sense to split this out until we know how we&apos;re going to handle anonymous configurations.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>