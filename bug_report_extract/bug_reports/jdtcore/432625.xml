<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>432625</bug_id>
          
          <creation_ts>2014-04-11 09:35:00 -0400</creation_ts>
          <short_desc>[1.8] VerifyError with lambdas and wildcards</short_desc>
          <delta_ts>2014-04-29 08:26:54 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.3.2</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Windows 7</op_sys>
          <bug_status>VERIFIED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>4.4 M7</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Robert Grabowski">robert.grabowski</reporter>
          <assigned_to name="Srikanth Sankaran">srikanth_sankaran</assigned_to>
          <cc>jarthana</cc>
    
    <cc>srikanth_sankaran</cc>
    
    <cc>stephan.herrmann</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2388071</commentid>
    <comment_count>0</comment_count>
    <who name="Robert Grabowski">robert.grabowski</who>
    <bug_when>2014-04-11 09:35:24 -0400</bug_when>
    <thetext>The Java 8 compiler that comes with Eclipse generates invalid bytecode for the following code:

------------
import java.util.stream.Stream;
public class MainClass
{
    public static void main(String[] args)
    {
        Stream&lt;?&gt; stream = Stream.of(&quot;A&quot;);
        stream.map(x -&gt; (String) x);
    }
}
------------

Running this program immediately fails with a &quot;bad return type&quot; VerifyError:

------------
Exception in thread &quot;main&quot; java.lang.VerifyError: Bad return type
Exception Details:
  Location:
    MainClass.lambda$0(Ljava/lang/Object;)Ljava/lang/String; @1: areturn
  Reason:
    Type &apos;java/lang/Object&apos; (current frame, stack[0]) is not assignable to &apos;java/lang/String&apos; (from method signature)
  Current Frame:
    bci: @1
    flags: { }
    locals: { &apos;java/lang/Object&apos; }
    stack: { &apos;java/lang/Object&apos; }
  Bytecode:
    0000000: 2ab0                                   

	at java.lang.Class.getDeclaredMethods0(Native Method)
	at java.lang.Class.privateGetDeclaredMethods(Class.java:2688)
	at java.lang.Class.getMethod0(Class.java:2937)
	at java.lang.Class.getMethod(Class.java:1771)
	at sun.launcher.LauncherHelper.validateMainClass(LauncherHelper.java:544)
	at sun.launcher.LauncherHelper.checkAndLoadMain(LauncherHelper.java:526)
------------

Compiling this class from the command line with jdk8 works fine.

Also, the problem does not occur in Eclipse if we replace the type &quot;Stream&lt;?&gt;&quot; with &quot;Stream&lt;? extends Object&gt;&quot;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2388170</commentid>
    <comment_count>1</comment_count>
    <who name="Stephan Herrmann">stephan.herrmann</who>
    <bug_when>2014-04-11 13:36:15 -0400</bug_when>
    <thetext>Thanks for the report.

Signature and body of the lambda are indeed inconsistent in the byte code

  private static java.lang.String lambda$0(?);
    flags: ACC_PRIVATE, ACC_STATIC, ACC_SYNTHETIC
    Signature: #32                          // (*)Ljava/lang/String;
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0       
         1: areturn       
      LineNumberTable:
        line 7: 0</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2388624</commentid>
    <comment_count>2</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-04-14 05:28:43 -0400</bug_when>
    <thetext>See https://bugs.eclipse.org/bugs/show_bug.cgi?id=429090#c11</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2388626</commentid>
    <comment_count>3</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-04-14 05:35:58 -0400</bug_when>
    <thetext>Fix and tests released here: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=0e681f80efbcd55630ac88e7932322f24f43cac4</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2388631</commentid>
    <comment_count>4</comment_count>
    <who name="Robert Grabowski">robert.grabowski</who>
    <bug_when>2014-04-14 05:59:21 -0400</bug_when>
    <thetext>Wow - thanks for the super-quick response!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2394563</commentid>
    <comment_count>5</comment_count>
    <who name="Sasikanth Bharadwaj">saammana</who>
    <bug_when>2014-04-29 05:43:39 -0400</bug_when>
    <thetext>Verified for 4.4 M7 using I20140428-2000 build</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>