<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>405051</bug_id>
          
          <creation_ts>2013-04-05 17:54:00 -0400</creation_ts>
          <short_desc>JavaModel.refreshExternalArchives needs to happen before search is primed</short_desc>
          <delta_ts>2013-11-11 09:24:43 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.2.2</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Windows 7</op_sys>
          <bug_status>RESOLVED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>3.8.2+</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Troy Bishop">tjbishop</reporter>
          <assigned_to name="Jay Arthanareeswaran">jarthana</assigned_to>
          <cc>daniel_megert</cc>
    
    <cc>raquelmc</cc>
          
          <votes>0</votes>

      

      

      <flag name="pmc_approved"
          id="59891"
          type_id="2"
          status="+"
          setter="daniel_megert"
    />

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2240427</commentid>
    <comment_count>0</comment_count>
    <who name="Troy Bishop">tjbishop</who>
    <bug_when>2013-04-05 17:54:00 -0400</bug_when>
    <thetext>When the search engine is primed (as part of calling JavaCore.initializeAfterLoad(IProgressMonitor)) then it populates the index manager based on the information returned from IndexManager#computeIndexLocation(IPath containerPath).  If the underlying index is a pre-built index but it has been deleted from the file-system, then the index is re-created in the workspace metadata and not in the location specified by the INDEX_LOCATION_ATTRIBUTE_NAME classpath attribute.  This is because search has no concept of the classpath containers - it simply knows a list of project and the corresponding archive files.

In JavaCore.initializeAfterLoad(IProgressMonitor) the call to refresh external archives (which populates the index manager with the correct classpath attribute information) happens after the search occurs.  Since the index has already been built from the search call then it ends up being used.

There are two ways to fix this:

1) In JavaCore.initializeAfterLoad(IProgressMonitor), move the call to refresh the archives to happen BEFORE the search engine is primed.

2) In IndexManager#computeIndexLocation(IPath containerPath, final URL newIndexURL) added via bug 395897, if the existing URL is different from the new URL then the index needs to be rebuilt after it is removed.

I think fix 1 makes more sense as, ideally, you want to know the latest archive state before a search is done.  This approach also ensures that the indexer manager is doing less work</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2240429</commentid>
    <comment_count>1</comment_count>
    <who name="Troy Bishop">tjbishop</who>
    <bug_when>2013-04-05 17:55:32 -0400</bug_when>
    <thetext>The use case for this is when the indexes supplied for a pre-built index scenario do not exist on disk (i.e. they were accidently removed).  In this case, the indexes are not reconstructed in the right place.

I can supply a patch for either approach depending on what is determined to be the right solution.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2240783</commentid>
    <comment_count>2</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-04-08 04:40:39 -0400</bug_when>
    <thetext>(In reply to comment #0)
&gt; 1) In JavaCore.initializeAfterLoad(IProgressMonitor), move the call to
&gt; refresh the archives to happen BEFORE the search engine is primed.

I prefer this. You meant the dummy searchAllTypeNames call inside JavaCore.initializeAfterLoad to be run after model.refreshExternalArchives(..) call, right?

Initially I was concerned that one might invoke the indexing even before initializeAfterLoad() is called, let&apos;s say by using &quot;Open Type&quot;. But looks like they are being blocked by initializeAfterLoad(). So, at first glance, looks to be safe.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2245154</commentid>
    <comment_count>3</comment_count>
      <attachid>229838</attachid>
    <who name="Troy Bishop">tjbishop</who>
    <bug_when>2013-04-17 22:02:00 -0400</bug_when>
    <thetext>Created attachment 229838
possible patch

patch for the proposed solution.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2245159</commentid>
    <comment_count>4</comment_count>
    <who name="Troy Bishop">tjbishop</who>
    <bug_when>2013-04-17 22:09:26 -0400</bug_when>
    <thetext>I&apos;ve verified that the JavaSearchBugsTests and JavaIndexTests all pass with the proposed patch.  Are there any other tests I could run to ensure no regressions with this change?

If possible (and tests pass), can this be added to the 4.2.2+ release?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2271692</commentid>
    <comment_count>5</comment_count>
    <who name="Dani Megert">daniel_megert</who>
    <bug_when>2013-06-12 04:56:03 -0400</bug_when>
    <thetext>The fix looks reasonable, but we should first run with the fix for a while before putting it into 4.2.2+.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2273182</commentid>
    <comment_count>6</comment_count>
      <attachid>229838</attachid>
    <who name="Dani Megert">daniel_megert</who>
    <bug_when>2013-06-17 03:31:30 -0400</bug_when>
    <thetext>Comment on attachment 229838
possible patch

Fix looks good. I also ran all Text and JDT UI tests against it.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2275428</commentid>
    <comment_count>7</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-06-21 05:45:58 -0400</bug_when>
    <thetext>(In reply to comment #6)
&gt; Comment on attachment 229838 [details]
&gt; possible patch
&gt; 
&gt; Fix looks good. I also ran all Text and JDT UI tests against it.

Thanks Dani. I have pushed the patch via commit http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=R3_8_maintenance&amp;id=f4a5bcc41639be426386e8268eb2fd9be1e10531

The projects have been tagged and map files updated.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2275462</commentid>
    <comment_count>8</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-06-21 08:06:59 -0400</bug_when>
    <thetext>Fix has been put in master as well. But will wait and see how it plays out before applying in Kepler SR1.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2327888</commentid>
    <comment_count>9</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-11-07 23:51:22 -0500</bug_when>
    <thetext>We missed this one for SR1. Dani, can we release this for Kepler SR2?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2328727</commentid>
    <comment_count>10</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-11-11 09:24:43 -0500</bug_when>
    <thetext>Pushed the fix for Kepler SR2 via:

http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=R4_3_maintenance&amp;id=40bd4fb780cd76f29e884eddc861fb9be2844fff</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>229838</attachid>
            <date>2013-04-17 22:02:00 -0400</date>
            <delta_ts>2013-06-17 03:31:30 -0400</delta_ts>
            <desc>possible patch</desc>
            <filename>eclipse.jdt.core_javacore_initialize.patch</filename>
            <type>text/plain</type>
            <size>2245</size>
            <attacher name="Troy Bishop">tjbishop</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL29yZy5lY2xpcHNlLmpkdC5jb3JlL21vZGVsL29yZy9lY2xpcHNlL2pkdC9j
b3JlL0phdmFDb3JlLmphdmEgYi9vcmcuZWNsaXBzZS5qZHQuY29yZS9tb2RlbC9vcmcvZWNsaXBz
ZS9qZHQvY29yZS9KYXZhQ29yZS5qYXZhCmluZGV4IDFhZjU1MTAuLmFlZjRlMjQgMTAwNjQ0Ci0t
LSBhL29yZy5lY2xpcHNlLmpkdC5jb3JlL21vZGVsL29yZy9lY2xpcHNlL2pkdC9jb3JlL0phdmFD
b3JlLmphdmEKKysrIGIvb3JnLmVjbGlwc2UuamR0LmNvcmUvbW9kZWwvb3JnL2VjbGlwc2UvamR0
L2NvcmUvSmF2YUNvcmUuamF2YQpAQCAtMzk0Nyw2ICszOTQ3LDIxIEBACiAJCQkJLy8gQ3JlYXRp
b24gb2YgZXh0ZXJuYWwgZm9sZGVyIHByb2plY3QgZmFpbGVkLiBMb2cgaXQgYW5kIGNvbnRpbnVl
OwogCQkJCVV0aWwubG9nKGptZSwgIkVycm9yIHdoaWxlIHByb2Nlc3NpbmcgZXh0ZXJuYWwgZm9s
ZGVycyIpOyAvLyROT04tTkxTLTEkCiAJCQl9CisKKwkJCS8vIGVuc3VyZSBleHRlcm5hbCBqYXJz
IGFyZSByZWZyZXNoZWQgKHNlZSBodHRwczovL2J1Z3MuZWNsaXBzZS5vcmcvYnVncy9zaG93X2J1
Zy5jZ2k/aWQ9OTM2NjgpCisJCQkvLyBiZWZvcmUgc2VhcmNoIGlzIGluaXRpYWxpemVkIChzZWUg
aHR0cHM6Ly9idWdzLmVjbGlwc2Uub3JnL2J1Z3Mvc2hvd19idWcuY2dpP2lkPTQwNTA1MSkKKwkJ
CWZpbmFsIEphdmFNb2RlbCBtb2RlbCA9IG1hbmFnZXIuZ2V0SmF2YU1vZGVsKCk7CisJCQl0cnkg
eworCQkJCWlmIChtb25pdG9yICE9IG51bGwpCisJCQkJCW1vbml0b3Iuc3ViVGFzayhNZXNzYWdl
cy5qYXZhbW9kZWxfcmVmcmVzaGluZ19leHRlcm5hbF9qYXJzKTsKKwkJCQltb2RlbC5yZWZyZXNo
RXh0ZXJuYWxBcmNoaXZlcygKKwkJCQkJbnVsbC8qcmVmcmVzaCBhbGwgcHJvamVjdHMqLywKKwkJ
CQkJbW9uaXRvciA9PSBudWxsID8gbnVsbCA6IG5ldyBTdWJQcm9ncmVzc01vbml0b3IobW9uaXRv
ciwgMSkgLy8gMSUgb2YgdGhlIHRpbWUgaXMgc3BlbnQgaW4gamFyIHJlZnJlc2gKKwkJCQkpOwor
CQkJfSBjYXRjaCAoSmF2YU1vZGVsRXhjZXB0aW9uIGUpIHsKKwkJCQkvLyByZWZyZXNoaW5nIGZh
aWxlZDogaWdub3JlCisJCQl9CisKIAkJCS8vIGluaXRpYWxpemUgZGVsdGEgc3RhdGUKIAkJCWlm
IChtb25pdG9yICE9IG51bGwpCiAJCQkJbW9uaXRvci5zdWJUYXNrKE1lc3NhZ2VzLmphdmFtb2Rl
bF9pbml0aWFsaXppbmdfZGVsdGFfc3RhdGUpOwpAQCAtNDAwMSw3ICs0MDE2LDYgQEAKIAkJCX0g
Y2F0Y2ggKENvcmVFeGNlcHRpb24gZSkgewogCQkJCS8vIGNvdWxkIG5vdCByZWFkIHZlcnNpb24g
bnVtYmVyOiBjb25zaWRlciBpdCBpcyBuZXcKIAkJCX0KLQkJCWZpbmFsIEphdmFNb2RlbCBtb2Rl
bCA9IG1hbmFnZXIuZ2V0SmF2YU1vZGVsKCk7CiAJCQlTdHJpbmcgbmV3VmVyc2lvbk51bWJlciA9
IEJ5dGUudG9TdHJpbmcoU3RhdGUuVkVSU0lPTik7CiAJCQlpZiAoIW5ld1ZlcnNpb25OdW1iZXIu
ZXF1YWxzKHZlcnNpb25OdW1iZXIpKSB7CiAJCQkJLy8gYnVpbGQgc3RhdGUgdmVyc2lvbiBudW1i
ZXIgaGFzIGNoYW5nZWQ6IHRvdWNoIGV2ZXJ5IHByb2plY3RzIHRvIGZvcmNlIGEgcmVidWlsZApA
QCAtNDAzNSwxOSArNDA0OSw2IEBACiAJCQkJCVV0aWwubG9nKGUsICJDb3VsZCBub3QgcGVyc2lz
dCBidWlsZCBzdGF0ZSB2ZXJzaW9uIG51bWJlciIpOyAvLyROT04tTkxTLTEkCiAJCQkJfQogCQkJ
fQotCi0JCQkvLyBlbnN1cmUgZXh0ZXJuYWwgamFycyBhcmUgcmVmcmVzaGVkIChzZWUgaHR0cHM6
Ly9idWdzLmVjbGlwc2Uub3JnL2J1Z3Mvc2hvd19idWcuY2dpP2lkPTkzNjY4KQotCQkJdHJ5IHsK
LQkJCQlpZiAobW9uaXRvciAhPSBudWxsKQotCQkJCQltb25pdG9yLnN1YlRhc2soTWVzc2FnZXMu
amF2YW1vZGVsX3JlZnJlc2hpbmdfZXh0ZXJuYWxfamFycyk7Ci0JCQkJbW9kZWwucmVmcmVzaEV4
dGVybmFsQXJjaGl2ZXMoCi0JCQkJCW51bGwvKnJlZnJlc2ggYWxsIHByb2plY3RzKi8sCi0JCQkJ
CW1vbml0b3IgPT0gbnVsbCA/IG51bGwgOiBuZXcgU3ViUHJvZ3Jlc3NNb25pdG9yKG1vbml0b3Is
IDEpIC8vIDElIG9mIHRoZSB0aW1lIGlzIHNwZW50IGluIGphciByZWZyZXNoCi0JCQkJKTsKLQkJ
CX0gY2F0Y2ggKEphdmFNb2RlbEV4Y2VwdGlvbiBlKSB7Ci0JCQkJLy8gcmVmcmVzaGluZyBmYWls
ZWQ6IGlnbm9yZQotCQkJfQotCiAJCX0gZmluYWxseSB7CiAJCQlpZiAobW9uaXRvciAhPSBudWxs
KSBtb25pdG9yLmRvbmUoKTsKIAkJfQ==
</data>
<flag name="review"
          id="58568"
          type_id="6"
          status="+"
          setter="daniel_megert"
    />
          </attachment>
      

    </bug>

</bugzilla>