<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>431190</bug_id>
          
          <creation_ts>2014-03-26 00:19:00 -0400</creation_ts>
          <short_desc>[1.8] VerifyError when using a method reference</short_desc>
          <delta_ts>2014-04-29 08:38:59 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.4</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>VERIFIED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>4.4 M7</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Jeffrey Falgout">jeffrey.falgout</reporter>
          <assigned_to name="Sasikanth Bharadwaj">saammana</assigned_to>
          <cc>jarthana</cc>
    
    <cc>srikanth_sankaran</cc>
          
          <votes>0</votes>

      

      

      <flag name="review"
          id="62081"
          type_id="1"
          status="+"
          setter="srikanth_sankaran"
    />

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2380212</commentid>
    <comment_count>0</comment_count>
      <attachid>241252</attachid>
    <who name="Jeffrey Falgout">jeffrey.falgout</who>
    <bug_when>2014-03-26 00:19:34 -0400</bug_when>
    <thetext>Created attachment 241252
Source file

When running the following class, you get a verify error:

public class Java8VerifyError {
    public static class Foo {
        public Object get() {
            return new Object();
        }
    }
    
    @FunctionalInterface
    public static interface Provider&lt;T&gt; {
        public T get();
    }
    
    public static void main(String[] args) {
        Provider&lt;Foo&gt; f = () -&gt; new Foo();
        
        Provider&lt;Provider&lt;Object&gt;&gt; meta = () -&gt; f.get()::get;
        System.out.println(meta);
    }
}

Exception in thread &quot;main&quot; java.lang.VerifyError: Bad type on operand stack
Exception Details:
  Location:
    Java8VerifyError.lambda$1(LJava8VerifyError$Provider;)LJava8VerifyError$Provider; @6: invokedynamic
  Reason:
    Type &apos;java/lang/Object&apos; (current frame, stack[0]) is not assignable to &apos;Java8VerifyError$Foo&apos;
  Current Frame:
    bci: @6
    flags: { }
    locals: { &apos;Java8VerifyError$Provider&apos; }
    stack: { &apos;java/lang/Object&apos; }
  Bytecode:
    0000000: 2ab9 0033 0100 ba00 3a00 00b0

Work around:

        Provider&lt;Provider&lt;Object&gt;&gt; meta = () -&gt; {
            Foo foo = f.get();
            return foo::get;
        };</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2390552</commentid>
    <comment_count>1</comment_count>
      <attachid>242116</attachid>
    <who name="Sasikanth Bharadwaj">saammana</who>
    <bug_when>2014-04-18 06:13:28 -0400</bug_when>
    <thetext>Created attachment 242116
Changes in code and tests</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2390553</commentid>
    <comment_count>2</comment_count>
    <who name="Sasikanth Bharadwaj">saammana</who>
    <bug_when>2014-04-18 06:16:16 -0400</bug_when>
    <thetext>The necessary checkcast is missing in the generated code. Looks like the method computeConversion, which  is never called on the lhs of the reference expression. Adding the line

this.lhs.computeConversion(scope, lhsType, lhsType);

to ReferenceExpression.resolveType solves this problem. Attached proposed changes in code and tests.
Srikanth, please review

No new failures in RunAllJava8Tests with these changes</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2391111</commentid>
    <comment_count>3</comment_count>
    <who name="Sasikanth Bharadwaj">saammana</who>
    <bug_when>2014-04-22 02:53:23 -0400</bug_when>
    <thetext>My contribution for this defect fix complies with http://www.eclipse.org/legal/CoO.php</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2391148</commentid>
    <comment_count>4</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-04-22 04:25:15 -0400</bug_when>
    <thetext>Patch looks good. Just to minimize any side effects, I moved the call to
computeConversion to be inside evaluate-once-only block guarded by

if (this.constant != Constant.NotAConstant) {

}

Fix and tests released here: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=f1df490ec0d248b686e20ddd372b10f6c06ffe43

Thanks Sasi.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2394690</commentid>
    <comment_count>5</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2014-04-29 08:38:59 -0400</bug_when>
    <thetext>Verified for 4.4 M7 with build I20140428-2000</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="0"
              isprivate="0"
          >
            <attachid>241252</attachid>
            <date>2014-03-26 00:19:00 -0400</date>
            <delta_ts>2014-03-26 00:19:34 -0400</delta_ts>
            <desc>Source file</desc>
            <filename>Java8VerifyError.java</filename>
            <type>text/x-java</type>
            <size>508</size>
            <attacher name="Jeffrey Falgout">jeffrey.falgout</attacher>
            
              <data encoding="base64">cHVibGljIGNsYXNzIEphdmE4VmVyaWZ5RXJyb3IgewogICAgcHVibGljIHN0YXRpYyBjbGFzcyBG
b28gewogICAgICAgIHB1YmxpYyBPYmplY3QgZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gbmV3
IE9iamVjdCgpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgQEZ1bmN0aW9uYWxJbnRlcmZhY2UK
ICAgIHB1YmxpYyBzdGF0aWMgaW50ZXJmYWNlIFByb3ZpZGVyPFQ+IHsKICAgICAgICBwdWJsaWMg
VCBnZXQoKTsKICAgIH0KICAgIAogICAgcHVibGljIHN0YXRpYyB2b2lkIG1haW4oU3RyaW5nW10g
YXJncykgewogICAgICAgIFByb3ZpZGVyPEZvbz4gZiA9ICgpIC0+IG5ldyBGb28oKTsKICAgICAg
ICAKICAgICAgICBQcm92aWRlcjxQcm92aWRlcjxPYmplY3Q+PiBtZXRhID0gKCkgLT4gewogICAg
ICAgICAgICBGb28gZm9vID0gZi5nZXQoKTsKICAgICAgICAgICAgcmV0dXJuIGZvbzo6Z2V0Owog
ICAgICAgIH07CiAgICAgICAgU3lzdGVtLm91dC5wcmludGxuKG1ldGEpOwogICAgfQp9Cg==
</data>

          </attachment>
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>242116</attachid>
            <date>2014-04-18 06:13:00 -0400</date>
            <delta_ts>2014-04-18 06:13:28 -0400</delta_ts>
            <desc>Changes in code and tests</desc>
            <filename>431190.patch</filename>
            <type>text/plain</type>
            <size>2397</size>
            <attacher name="Sasikanth Bharadwaj">saammana</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL29yZy5lY2xpcHNlLmpkdC5jb3JlLnRlc3RzLmNvbXBpbGVyL3NyYy9vcmcv
ZWNsaXBzZS9qZHQvY29yZS90ZXN0cy9jb21waWxlci9yZWdyZXNzaW9uL0xhbWJkYUV4cHJlc3Np
b25zVGVzdC5qYXZhIGIvb3JnLmVjbGlwc2UuamR0LmNvcmUudGVzdHMuY29tcGlsZXIvc3JjL29y
Zy9lY2xpcHNlL2pkdC9jb3JlL3Rlc3RzL2NvbXBpbGVyL3JlZ3Jlc3Npb24vTGFtYmRhRXhwcmVz
c2lvbnNUZXN0LmphdmENCmluZGV4IDgwZWJjNDAuLmJiYWU1M2QgMTAwNjQ0DQotLS0gYS9vcmcu
ZWNsaXBzZS5qZHQuY29yZS50ZXN0cy5jb21waWxlci9zcmMvb3JnL2VjbGlwc2UvamR0L2NvcmUv
dGVzdHMvY29tcGlsZXIvcmVncmVzc2lvbi9MYW1iZGFFeHByZXNzaW9uc1Rlc3QuamF2YQ0KKysr
IGIvb3JnLmVjbGlwc2UuamR0LmNvcmUudGVzdHMuY29tcGlsZXIvc3JjL29yZy9lY2xpcHNlL2pk
dC9jb3JlL3Rlc3RzL2NvbXBpbGVyL3JlZ3Jlc3Npb24vTGFtYmRhRXhwcmVzc2lvbnNUZXN0Lmph
dmENCkBAIC00MjEyLDYgKzQyMTIsMjkgQEANCiAJCX0sDQogCQkiIik7DQogfQ0KKy8vIGh0dHBz
Oi8vYnVncy5lY2xpcHNlLm9yZy9idWdzL3Nob3dfYnVnLmNnaT9pZD00MzExOTAsIFsxLjhdIFZl
cmlmeUVycm9yIHdoZW4gdXNpbmcgYSBtZXRob2QgcmVmZXJlbmNlDQorcHVibGljIHZvaWQgdGVz
dDQzMTE5MCgpIHRocm93cyBFeGNlcHRpb24gew0KKwl0aGlzLnJ1bkNvbmZvcm1UZXN0KA0KKwkJ
bmV3IFN0cmluZ1tdIHsNCisJCQkiSmF2YThWZXJpZnlFcnJvci5qYXZhIiwNCisJCQkicHVibGlj
IGNsYXNzIEphdmE4VmVyaWZ5RXJyb3Ige1xuIiArDQorCQkJIiAgICBwdWJsaWMgc3RhdGljIGNs
YXNzIEZvbyB7XG4iICsNCisJCQkiICAgICAgICBwdWJsaWMgT2JqZWN0IGdldCgpIHtcbiIgKw0K
KwkJCSIgICAgICAgICAgICByZXR1cm4gbmV3IE9iamVjdCgpO1xuIiArDQorCQkJIiAgICAgICAg
fVxuIiArDQorCQkJIiAgICB9XG4iICsNCisJCQkiICAgIEBGdW5jdGlvbmFsSW50ZXJmYWNlXG4i
ICsNCisJCQkiICAgIHB1YmxpYyBzdGF0aWMgaW50ZXJmYWNlIFByb3ZpZGVyPFQ+IHtcbiIgKw0K
KwkJCSIgICAgICAgIHB1YmxpYyBUIGdldCgpO1xuIiArDQorCQkJIiAgICB9XG4iICsNCisJCQki
ICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBtYWluKFN0cmluZ1tdIGFyZ3MpIHtcbiIgKw0KKwkJCSIg
ICAgICAgIFByb3ZpZGVyPEZvbz4gZiA9ICgpIC0+IG5ldyBGb28oKTtcbiIgKw0KKwkJCSIgICAg
ICAgIFByb3ZpZGVyPFByb3ZpZGVyPE9iamVjdD4+IG1ldGEgPSAoKSAtPiBmLmdldCgpOjpnZXQ7
XG4iICsNCisJCQkiICAgIH1cbiIgKw0KKwkJCSJ9XG4iDQorCQl9LA0KKwkJIiIpOw0KK30NCiBw
dWJsaWMgc3RhdGljIENsYXNzIHRlc3RDbGFzcygpIHsNCiAJcmV0dXJuIExhbWJkYUV4cHJlc3Np
b25zVGVzdC5jbGFzczsNCiB9DQpkaWZmIC0tZ2l0IGEvb3JnLmVjbGlwc2UuamR0LmNvcmUvY29t
cGlsZXIvb3JnL2VjbGlwc2UvamR0L2ludGVybmFsL2NvbXBpbGVyL2FzdC9SZWZlcmVuY2VFeHBy
ZXNzaW9uLmphdmEgYi9vcmcuZWNsaXBzZS5qZHQuY29yZS9jb21waWxlci9vcmcvZWNsaXBzZS9q
ZHQvaW50ZXJuYWwvY29tcGlsZXIvYXN0L1JlZmVyZW5jZUV4cHJlc3Npb24uamF2YQ0KaW5kZXgg
YTIxMGE3Yy4uZDJkMDAxZSAxMDA2NDQNCi0tLSBhL29yZy5lY2xpcHNlLmpkdC5jb3JlL2NvbXBp
bGVyL29yZy9lY2xpcHNlL2pkdC9pbnRlcm5hbC9jb21waWxlci9hc3QvUmVmZXJlbmNlRXhwcmVz
c2lvbi5qYXZhDQorKysgYi9vcmcuZWNsaXBzZS5qZHQuY29yZS9jb21waWxlci9vcmcvZWNsaXBz
ZS9qZHQvaW50ZXJuYWwvY29tcGlsZXIvYXN0L1JlZmVyZW5jZUV4cHJlc3Npb24uamF2YQ0KQEAg
LTM5NSw3ICszOTUsNyBAQA0KIAkJCWxoc1R5cGUgPSBsaHNUeXBlLmNsb3Nlc3RNYXRjaCgpOwkv
LyBpbXByb3ZlIHJlc29sdmluZyBleHBlcmllbmNlDQogICAgIAlpZiAoIWxoc1R5cGUuaXNWYWxp
ZEJpbmRpbmcoKSkgDQogCQkJcmV0dXJuIHRoaXMucmVzb2x2ZWRUeXBlID0gbnVsbDsJLy8gbm9w
ZSwgbm8gdXNlZnVsIHR5cGUgZm91bmQNCi0JCQ0KKwkJdGhpcy5saHMuY29tcHV0ZUNvbnZlcnNp
b24oc2NvcGUsIGxoc1R5cGUsIGxoc1R5cGUpOw0KIAkJZmluYWwgVHlwZUJpbmRpbmdbXSBkZXNj
cmlwdG9yUGFyYW1ldGVycyA9IHRoaXMuZGVzY3JpcHRvciAhPSBudWxsID8gdGhpcy5kZXNjcmlw
dG9yLnBhcmFtZXRlcnMgOiBCaW5kaW5nLk5PX1BBUkFNRVRFUlM7DQogCQlpZiAobGhzVHlwZS5p
c0Jhc2VUeXBlKCkpIHsNCiAJCQlzY29wZS5wcm9ibGVtUmVwb3J0ZXIoKS5lcnJvck5vTWV0aG9k
Rm9yKHRoaXMubGhzLCBsaHNUeXBlLCB0aGlzLnNlbGVjdG9yLCBkZXNjcmlwdG9yUGFyYW1ldGVy
cyk7
</data>

          </attachment>
      

    </bug>

</bugzilla>