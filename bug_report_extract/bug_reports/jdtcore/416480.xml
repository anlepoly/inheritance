<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>416480</bug_id>
          
          <creation_ts>2013-09-03 18:00:00 -0400</creation_ts>
          <short_desc>Error in bytecode generated by ECJ compiler leads to IncompatibleClassChangeError</short_desc>
          <delta_ts>2015-01-20 07:04:04 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.4</version>
          <rep_platform>All</rep_platform>
          <op_sys>All</op_sys>
          <bug_status>VERIFIED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>4.4.2</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Graham Stanton">grahamstanton</reporter>
          <assigned_to name="Srikanth Sankaran">srikanth_sankaran</assigned_to>
          <cc>jarthana</cc>
    
    <cc>shankhba</cc>
    
    <cc>srikanth_sankaran</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2302403</commentid>
    <comment_count>0</comment_count>
      <attachid>235123</attachid>
    <who name="Graham Stanton">grahamstanton</who>
    <bug_when>2013-09-03 18:00:01 -0400</bug_when>
    <thetext>Created attachment 235123
SneakyCaster.java

To reproduce, compile (and then run) the attached SneakyCaster.java using both javac and ECJ.

ECJ misses the checkcast instruction at the end of the cast() method. This allows assignment of an Object to a Runnable variable. Eventually, the JVM throws an IncompatibleClassChangeError, but clearly, as there is only one .class file, that&apos;s not right.

javac correctly includes the checkcast instruction, and a ClassCastException is thrown before the invalid assignment could ever be made.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2308131</commentid>
    <comment_count>1</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-09-18 00:32:55 -0400</bug_when>
    <thetext>Stephan, thanks for taking a look!

BTW, I can reproduce this in 4.3.1 as well as 4.3.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2309046</commentid>
    <comment_count>2</comment_count>
    <who name="Stephan Herrmann">stephan.herrmann</who>
    <bug_when>2013-09-19 18:52:54 -0400</bug_when>
    <thetext>Bug already exists since generics got introduced to ecj.

It seems I got more urgent things on my plate, but I&apos;ll keep it on my radar.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2388559</commentid>
    <comment_count>3</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-04-14 03:26:33 -0400</bug_when>
    <thetext>(In reply to Stephan Herrmann from comment #2)
&gt; Bug already exists since generics got introduced to ecj.


Thanks for that information. We will take a look at this for 4.5
after the Java 8 maintenance work&apos;s urgent issues are addressed.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2448634</commentid>
    <comment_count>4</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-09-08 05:35:25 -0400</bug_when>
    <thetext>I agree the error message is somewhat confusing. Code generated by javac
includes a cast in cast() method - which produces a CCE when run, but the
cast in cast() is really not justified.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2448640</commentid>
    <comment_count>5</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-09-08 05:56:24 -0400</bug_when>
    <thetext>(In reply to Srikanth Sankaran from comment #4)
&gt; I agree the error message is somewhat confusing. Code generated by javac
&gt; includes a cast in cast() method - which produces a CCE when run, but the
&gt; cast in cast() is really not justified.

I need to take a closer look - the workspace had a bunch of unrelated changes
while I was debugging this scenario.

I will look into this for 4.5 M2.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2448651</commentid>
    <comment_count>6</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-09-08 06:10:59 -0400</bug_when>
    <thetext>Amzzingly, org.eclipse.jdt.internal.compiler.ast.SingleNameReference.computeConversion(Scope, TypeBinding, TypeBinding) is lacking any treatment of locals. Only fields are
handled there. I think the genericCast attribute would need to get updated
there to produce a checkcast in cast()</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2448712</commentid>
    <comment_count>7</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-09-08 08:56:04 -0400</bug_when>
    <thetext>Fix and tests released here: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=6fe04df602475d9f13e955fcfd38124da359e84a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2452875</commentid>
    <comment_count>8</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2014-09-17 02:52:15 -0400</bug_when>
    <thetext>Verified for 4.5 M2 using build I20140916-2000</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2473890</commentid>
    <comment_count>9</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2014-10-30 02:06:10 -0400</bug_when>
    <thetext>+1 for back porting, reopening.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2477699</commentid>
    <comment_count>10</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2014-11-06 03:54:54 -0500</bug_when>
    <thetext>Released in R4_4_maintenance via commit(s):

http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=R4_4_maintenance&amp;id=3c5d92e016f995dd43c0cbda18d4e4cb505ad3d4</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2507788</commentid>
    <comment_count>11</comment_count>
    <who name="shankha banerjee">shankhba</who>
    <bug_when>2015-01-20 07:04:04 -0500</bug_when>
    <thetext>Verified for 4.4.2 RC1 using build M20150114-1500.</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="0"
              isprivate="0"
          >
            <attachid>235123</attachid>
            <date>2013-09-03 18:00:00 -0400</date>
            <delta_ts>2013-09-03 18:00:01 -0400</delta_ts>
            <desc>SneakyCaster.java</desc>
            <filename>file_416480.txt</filename>
            <type>text/plain</type>
            <size>432</size>
            <attacher name="Graham Stanton">grahamstanton</attacher>
            
              <data encoding="base64">cHVibGljIGNsYXNzIFNuZWFreUNhc3RlcjxUIGV4dGVuZHMgT2JqZWN0ICYgUnVubmFibGU+IHsN
CiAgICBwcml2YXRlIFJ1bm5hYmxlIGNhc3QoVCBvYmopIHsNCiAgICAgICAgcmV0dXJuIG9iajsN
CiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIHZvaWQgbWFpbihTdHJpbmdbXSBhcmdzKSB7DQog
ICAgICAgIFJ1bm5hYmxlIHJ1bm5hYmxlID0gbmV3IFNuZWFreUNhc3RlcigpLmNhc3QobmV3IE9i
amVjdCgpKTsNCiAgICAgICAgU3lzdGVtLmVyci5wcmludGxuKCJydW5uYWJsZSBpbnN0YW5jZW9m
IFJ1bm5hYmxlID09ICINCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArIChydW5uYWJs
ZSBpbnN0YW5jZW9mIFJ1bm5hYmxlKSk7DQogICAgICAgIFN5c3RlbS5lcnIucHJpbnRsbigpOw0K
ICAgICAgICBydW5uYWJsZS5ydW4oKTsNCiAgICB9DQp9
</data>

          </attachment>
      

    </bug>

</bugzilla>