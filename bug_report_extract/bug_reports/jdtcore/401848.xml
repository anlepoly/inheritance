<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>401848</bug_id>
          
          <creation_ts>2013-02-26 20:14:00 -0500</creation_ts>
          <short_desc>ASTRewrite on type annotations adds an additional &lt;CR&gt;</short_desc>
          <delta_ts>2014-02-18 12:19:23 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.3</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Windows 7</op_sys>
          <bug_status>RESOLVED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>BETA J8</target_milestone>
          <dependson>425040</dependson>
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Manoj Palat Away Until May 11 2015">manpalat</reporter>
          <assigned_to name="Markus Keller">markus_keller</assigned_to>
          <cc>jarthana</cc>
    
    <cc>jesper</cc>
    
    <cc>manpalat</cc>
    
    <cc>markus_keller</cc>
    
    <cc>noopur_gupta</cc>
    
    <cc>srikanth_sankaran</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2222370</commentid>
    <comment_count>0</comment_count>
      <attachid>227640</attachid>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2013-02-26 20:14:21 -0500</bug_when>
    <thetext>Created attachment 227640
Testcase to reproduce the error

A &quot;\n&quot; introduced when an additional Annotation is added using rewrite</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2228486</commentid>
    <comment_count>1</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2013-03-09 11:46:09 -0500</bug_when>
    <thetext>See https://bugs.eclipse.org/bugs/show_bug.cgi?id=395612#c6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2228500</commentid>
    <comment_count>2</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2013-03-09 13:55:35 -0500</bug_when>
    <thetext>Manoj, this may fall in the area of the formatter, if so it may make sense
for Jesper to follow up. Would you like this reassigned ?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2233490</commentid>
    <comment_count>3</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2013-03-19 06:19:05 -0400</bug_when>
    <thetext>(In reply to comment #2)
&gt; Manoj, this may fall in the area of the formatter, if so it may make sense
&gt; for Jesper to follow up. Would you like this reassigned ?

yes, please.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2234160</commentid>
    <comment_count>4</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2013-03-20 07:46:48 -0400</bug_when>
    <thetext>The patch from comment#0 does not compile - there are various errors.
Please fix it and provide a test that can be worked on.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2234161</commentid>
    <comment_count>5</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2013-03-20 07:49:42 -0400</bug_when>
    <thetext>I think this is coming because that is the formatting style for SE7 annotations and the formatter cannot always distinguish between the two. Only if bindings are
requested, it can.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2234641</commentid>
    <comment_count>6</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2013-03-20 23:30:15 -0400</bug_when>
    <thetext>(In reply to comment #4)
&gt; The patch from comment#0 does not compile - there are various errors.
Please
&gt; fix it and provide a test that can be worked on.

Please take just the testPrimitiveType() function and add it to any rewriting test, say ASTRewritingTypeDeclTest.java and the test compiles without any error, and will show the issue while running.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2234643</commentid>
    <comment_count>7</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2013-03-20 23:38:22 -0400</bug_when>
    <thetext>(In reply to comment #5)
&gt; I think this is coming because that is the formatting style for SE7
&gt; annotations and the formatter cannot always distinguish between the two.
&gt; Only if bindings are
requested, it can.

In this case, the annotations are at a place where SE7 annotations cannot come.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2234644</commentid>
    <comment_count>8</comment_count>
      <attachid>228806</attachid>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2013-03-20 23:42:59 -0400</bug_when>
    <thetext>Created attachment 228806
Testcase as a patch to reproduce

Testcase to reproduce attached as a patch</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2234645</commentid>
    <comment_count>9</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2013-03-20 23:44:07 -0400</bug_when>
    <thetext>(In reply to comment #7)
&gt; (In reply to comment #5)
&gt; &gt; I think this is coming because that is the formatting style for SE7
&gt; &gt; annotations and the formatter cannot always distinguish between the two.
&gt; &gt; Only if bindings are
&gt; requested, it can.
&gt; 
&gt; In this case, the annotations are at a place where SE7 annotations cannot
&gt; come.

Which location are you referring to as one where SE7 annotations cannot come ?

	public @Annot int b;

@Annot could be a SE8 annotation or a SE7 annotation.

OTOH

    class X extends @Annot Y {}

@Annot is featuring in a SE8 only location.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2234650</commentid>
    <comment_count>10</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2013-03-21 00:11:22 -0400</bug_when>
    <thetext>See also: https://bugs.eclipse.org/bugs/show_bug.cgi?id=122247</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2234653</commentid>
    <comment_count>11</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2013-03-21 01:03:12 -0400</bug_when>
    <thetext>(In reply to comment #9)
&gt; (In reply to comment #7)

&gt; 	public @Annot int b;
&gt; 
&gt; @Annot could be a SE8 annotation or a SE7 annotation.
&gt; 
right. missed adding ElementType.FIELD in the test case. So as you mentioned, we need the binding to distinguish.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2234733</commentid>
    <comment_count>12</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2013-03-21 04:51:38 -0400</bug_when>
    <thetext>WRT https://bugs.eclipse.org/bugs/show_bug.cgi?id=403816,
the spec committee is at the very least likely to amend JLS to recommend that
as a coding convention, type annotations should immediately precede the type.

If that recommendation is in place, then the formatter could under an
option format the immediately preceding annotations &quot;inline&quot;</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2247302</commentid>
    <comment_count>13</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-04-23 09:37:39 -0400</bug_when>
    <thetext>When this is fixed, ASTRewritingMethodDeclTest._testReceiver4_since_8() should be enabled.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2346079</commentid>
    <comment_count>14</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-01-06 09:46:16 -0500</bug_when>
    <thetext>Manoj, please study and share your findings.TIA.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2346511</commentid>
    <comment_count>15</comment_count>
      <attachid>238733</attachid>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2014-01-07 10:12:17 -0500</bug_when>
    <thetext>Created attachment 238733
Test case

Patch depicting both scenarios: 
 - For SE8 exclusive locations, this issue is not present. As described in comment 9, the problem occurs in SE7 location (ie public @Annot int i;) where a SE8 annotation comes.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2346512</commentid>
    <comment_count>16</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2014-01-07 10:12:45 -0500</bug_when>
    <thetext>Moving to 4.4</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2357372</commentid>
    <comment_count>17</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2014-01-31 15:20:08 -0500</bug_when>
    <thetext>Make sure bug 425040 is fixed before you start investigating the problem with ASTRewrite.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2358967</commentid>
    <comment_count>18</comment_count>
    <who name="Noopur Gupta">noopur_gupta</who>
    <bug_when>2014-02-05 04:51:17 -0500</bug_when>
    <thetext>(In reply to Manoj Palat from comment #15) 
&gt;  - For SE8 exclusive locations, this issue is not present. 

bug 426868 comment #1 - the disabled test in the patch, is an example of the SE8 exclusive location where the issue occurs.

Example:
-------------------------------------------------------------------
import java.io.FileNotFoundException;
import java.lang.annotation.ElementType;
import java.lang.annotation.Target;

class E {
	void test(int a) {
		throw new @Marker FileNotFoundException();
	}
}

@Target(ElementType.TYPE_USE)
@interface Marker { }
-------------------------------------------------------------------
Apply the patch from bug 426868 comment #1 in JDT/UI and hover over the error in above example (at &apos;thorw&apos;).
Select &quot;Add throws declaration&quot; quick fix. The result is:
-------------------------------------------------------------------
class E {
	void test(int a) throws @Marker
	FileNotFoundException {
		throw new @Marker FileNotFoundException();
	}
}
-------------------------------------------------------------------

Here, the &quot;@Marker FileNotFoundException&quot; node to be added in &apos;throws&apos; comes as a SimpleType with #annotations having &apos;@Marker&apos;.

Please check if the above issue will be resolved with this bug or bug 425040.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2359954</commentid>
    <comment_count>19</comment_count>
    <who name="Noopur Gupta">noopur_gupta</who>
    <bug_when>2014-02-07 01:42:45 -0500</bug_when>
    <thetext>(In reply to Noopur Gupta from comment #18)
Observed that this issue happens only when &quot;Insert new line after annotations on fields&quot; is enabled.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2360269</commentid>
    <comment_count>20</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2014-02-07 10:54:00 -0500</bug_when>
    <thetext>(In reply to Noopur Gupta from comment #19)
&gt; (In reply to Noopur Gupta from comment #18)
&gt; Observed that this issue happens only when &quot;Insert new line after
&gt; annotations on fields&quot; is enabled.

Yup, that&apos;s because ASTRewriteFormatter#formatNode(ASTNode, String, int) creates a snippet where the type is in a field declaration:

	case ASTNode.SIMPLE_TYPE:
		suffix= &quot; x;&quot;; //$NON-NLS-1$
		code= CodeFormatter.K_CLASS_BODY_DECLARATIONS;
		break;

The problem is that the given ASTNode is a new node, so you can&apos;t find the right context via getLocationInParent(). The full fix has to pass the StructuralPropertyDescriptor from ListRewriter#rewriteList(..) down into #formatNode(..):

ASTRewriteFormatter.formatNode(ASTNode, String, int) line: 289	
ASTRewriteFormatter.getFormattedResult(ASTNode, int, Collection) line: 191	
ASTRewriteAnalyzer.doTextInsert(int, ASTNode, int, boolean, TextEditGroup) line: 1343	
ASTRewriteAnalyzer$ListRewriter.rewriteList(ASTNode, StructuralPropertyDescriptor, String, String, int) line: 635	


A quick hack that would improve the situation with the default code formatter profile (where insert_new_line_after_annotation_on_parameter=do not insert) is to just format the type in a method parameter list like this:

	case ASTNode.SIMPLE_TYPE:
		prefix= &quot;void m(&quot;; //$NON-NLS-1$
		suffix= &quot; x);&quot;; //$NON-NLS-1$
		code= CodeFormatter.K_CLASS_BODY_DECLARATIONS;</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2361314</commentid>
    <comment_count>21</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-02-11 00:25:31 -0500</bug_when>
    <thetext>(In reply to Markus Keller from comment #20)

&gt; A quick hack that would improve the situation with the default code
&gt; formatter profile (where insert_new_line_after_annotation_on_parameter=do
&gt; not insert) is to just format the type in a method parameter list like this:
&gt; 
&gt; 	case ASTNode.SIMPLE_TYPE:
&gt; 		prefix= &quot;void m(&quot;; //$NON-NLS-1$
&gt; 		suffix= &quot; x);&quot;; //$NON-NLS-1$
&gt; 		code= CodeFormatter.K_CLASS_BODY_DECLARATIONS;

Thanks. It does not look particularly hacky to me as one snippet is as
arbitrary as the other. 

Do you see any side effects ?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2361316</commentid>
    <comment_count>22</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-02-11 00:27:35 -0500</bug_when>
    <thetext>(In reply to Srikanth Sankaran from comment #21)
&gt; (In reply to Markus Keller from comment #20)
&gt; 
&gt; &gt; A quick hack that would improve the situation with the default code
&gt; &gt; formatter profile (where insert_new_line_after_annotation_on_parameter=do
&gt; &gt; not insert) is to just format the type in a method parameter list like this:
&gt; &gt; 
&gt; &gt; 	case ASTNode.SIMPLE_TYPE:
&gt; &gt; 		prefix= &quot;void m(&quot;; //$NON-NLS-1$
&gt; &gt; 		suffix= &quot; x);&quot;; //$NON-NLS-1$
&gt; &gt; 		code= CodeFormatter.K_CLASS_BODY_DECLARATIONS;
&gt; 
&gt; Thanks. It does not look particularly hacky to me as one snippet is as
&gt; arbitrary as the other. 
&gt; 
&gt; Do you see any side effects ?

Manoj, please put together a test that invokes rewrite on the type reference
of the field by programmatically inserting annotations and let us understand
what is the impact - if any,</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2361403</commentid>
    <comment_count>23</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2014-02-11 04:32:36 -0500</bug_when>
    <thetext>(In reply to Srikanth Sankaran from comment #22)
&gt; 
&gt; Manoj, please put together a test that invokes rewrite on the type reference
&gt; of the field by programmatically inserting annotations and let us understand
&gt; what is the impact - if any,

testcase commit via http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=BETA_JAVA8&amp;id=f7a3f976b2776b953199bf3c6716d25e2ddea03e</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2361993</commentid>
    <comment_count>24</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2014-02-12 03:42:08 -0500</bug_when>
    <thetext>(In reply to Srikanth Sankaran from comment #21)
&gt; Thanks. It does not look particularly hacky to me as one snippet is as
&gt; arbitrary as the other. 
&gt; 
&gt; Do you see any side effects ?

No, releasing that would be fine for me. The only &quot;hack&quot; is that this doesn&apos;t fix the complete problem, but just works around the visible effects.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2364968</commentid>
    <comment_count>25</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2014-02-18 12:19:23 -0500</bug_when>
    <thetext>Comment 20 has been released with bug 427622.

(In reply to Markus Keller from comment #24)
&gt; The only &quot;hack&quot; is that this
&gt; doesn&apos;t fix the complete problem, but just works around the visible effects.

Just to spell this out: The snippet puts the type into a method parameter, and since the default code formatter setting for insert_new_line_after_annotation_on_parameter is &quot;do not insert&quot;, we don&apos;t get a new line any more.

Remaining problems:

1) If *_annotation_on_parameter is set to &quot;insert&quot;, then we again get a new line for the type annotation, even if *_type_annotation is &quot;do not insert&quot;.

2) If *_annotation_on_parameter is set to &quot;do not insert&quot;, and *_type_annotation is &quot;insert&quot;, then we don&apos;t get a new line.

The first problem can be fixed by changing the snippet in ASTRewriteFormatter to
    prefix= &quot;void m(final &quot;; //$NON-NLS-1$

The second problem can be fixed with an improved fix for bug 425040 comment 13. However, I now think we should only treat method parameters specially, i.e. assume type annotations if there are no other keywords in the modifier list.

A common usage pattern is to have @SuppressWarnings(&quot;...&quot;) on a local variable, and we should not start treating these as type annotations.

Fixed this bug and the modified version of bug 425040 comment 13 with
http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=cd140389e1d0cdca9f232f9b33d1b09e90034b22</thetext>
  </long_desc>
      
          <attachment
              isobsolete="1"
              ispatch="0"
              isprivate="0"
          >
            <attachid>227640</attachid>
            <date>2013-02-26 20:14:00 -0500</date>
            <delta_ts>2013-03-20 23:42:59 -0400</delta_ts>
            <desc>Testcase to reproduce the error</desc>
            <filename>ASTRewritingTypeAnnotationsTest.java</filename>
            <type>application/octet-stream</type>
            <size>2600</size>
            <attacher name="Manoj Palat Away Until May 11 2015">manpalat</attacher>
            
              <data encoding="base64">cGFja2FnZSBvcmcuZWNsaXBzZS5qZHQuY29yZS50ZXN0cy5yZXdyaXRlLmRlc2NyaWJpbmc7DQoN
Cg0KaW1wb3J0IGp1bml0LmZyYW1ld29yay5UZXN0Ow0KDQppbXBvcnQgb3JnLmVjbGlwc2UuamR0
LmNvcmUuSUNvbXBpbGF0aW9uVW5pdDsNCmltcG9ydCBvcmcuZWNsaXBzZS5qZHQuY29yZS5JUGFj
a2FnZUZyYWdtZW50Ow0KaW1wb3J0IG9yZy5lY2xpcHNlLmpkdC5jb3JlLmRvbS5BU1Q7DQppbXBv
cnQgb3JnLmVjbGlwc2UuamR0LmNvcmUuZG9tLkFubm90YXRpb247DQppbXBvcnQgb3JnLmVjbGlw
c2UuamR0LmNvcmUuZG9tLkNvbXBpbGF0aW9uVW5pdDsNCmltcG9ydCBvcmcuZWNsaXBzZS5qZHQu
Y29yZS5kb20uRmllbGREZWNsYXJhdGlvbjsNCmltcG9ydCBvcmcuZWNsaXBzZS5qZHQuY29yZS5k
b20uTWFya2VyQW5ub3RhdGlvbjsNCmltcG9ydCBvcmcuZWNsaXBzZS5qZHQuY29yZS5kb20uVHlw
ZURlY2xhcmF0aW9uOw0KaW1wb3J0IG9yZy5lY2xpcHNlLmpkdC5jb3JlLmRvbS5yZXdyaXRlLkFT
VFJld3JpdGU7DQppbXBvcnQgb3JnLmVjbGlwc2UuamR0LmNvcmUuZG9tLnJld3JpdGUuTGlzdFJl
d3JpdGU7DQoNCnB1YmxpYyBjbGFzcyBBU1RSZXdyaXRpbmdUeXBlQW5ub3RhdGlvbnNUZXN0IGV4
dGVuZHMgQVNUUmV3cml0aW5nVGVzdHsNCg0KCXB1YmxpYyBBU1RSZXdyaXRpbmdUeXBlQW5ub3Rh
dGlvbnNUZXN0KFN0cmluZyBuYW1lKSB7DQoJCXN1cGVyKG5hbWUpOw0KCX0NCg0KCXB1YmxpYyAg
QVNUUmV3cml0aW5nVHlwZUFubm90YXRpb25zVGVzdChTdHJpbmcgbmFtZSwgaW50IGFwaUxldmVs
KSB7DQoJCXN1cGVyKG5hbWUsIGFwaUxldmVsKTsNCgl9DQoNCglwdWJsaWMgc3RhdGljIFRlc3Qg
c3VpdGUoKSB7DQoJCXJldHVybiBjcmVhdGVTdWl0ZShBU1RSZXdyaXRpbmdUeXBlQW5ub3RhdGlv
bnNUZXN0LmNsYXNzKTsNCgl9DQoNCglwdWJsaWMgdm9pZCB0ZXN0UHJpbWl0aXZlVHlwZSgpIHRo
cm93cyBFeGNlcHRpb24gew0KCQlpZiAodGhpcy5hcGlMZXZlbCA8IEFTVC5KTFM4KSByZXR1cm47
DQoJCUlQYWNrYWdlRnJhZ21lbnQgcGFjazE9IHRoaXMuc291cmNlRm9sZGVyLmNyZWF0ZVBhY2th
Z2VGcmFnbWVudCgidGVzdDEiLCBmYWxzZSwgbnVsbCk7DQoJCVN0cmluZ0J1ZmZlciBidWY9IG5l
dyBTdHJpbmdCdWZmZXIoKTsNCgkJYnVmLmFwcGVuZCgicGFja2FnZSB0ZXN0MTtcbiIpOw0KCQli
dWYuYXBwZW5kKCJpbXBvcnQgamF2YS5sYW5nLmFubm90YXRpb24uRWxlbWVudFR5cGU7XG4iKTsN
CgkJYnVmLmFwcGVuZCgicHVibGljIGNsYXNzIFgge1xuIik7DQoJCWJ1Zi5hcHBlbmQoIglwdWJs
aWMgQEFubm90IGludCBiO1xuIik7ICANCgkJYnVmLmFwcGVuZCgiQGphdmEubGFuZy5hbm5vdGF0
aW9uLlRhcmdldCh2YWx1ZSA9IHtFbGVtZW50VHlwZS5UWVBFX1VTRX0pXG4iKTsgDQoJCWJ1Zi5h
cHBlbmQoIkBpbnRlcmZhY2UgQW5ub3Qge31cbiIpOw0KCQlJQ29tcGlsYXRpb25Vbml0IGN1PSBw
YWNrMS5jcmVhdGVDb21waWxhdGlvblVuaXQoIlguamF2YSIsIGJ1Zi50b1N0cmluZygpLCBmYWxz
ZSwgbnVsbCk7DQoNCgkJQ29tcGlsYXRpb25Vbml0IGFzdFJvb3Q9IGNyZWF0ZUFTVChjdSk7DQoJ
CUFTVFJld3JpdGUgcmV3cml0ZT0gQVNUUmV3cml0ZS5jcmVhdGUoYXN0Um9vdC5nZXRBU1QoKSk7
DQoJCUFTVCBhc3Q9IGFzdFJvb3QuZ2V0QVNUKCk7DQoJCVR5cGVEZWNsYXJhdGlvbiB0eXBlPSBm
aW5kVHlwZURlY2xhcmF0aW9uKGFzdFJvb3QsICJYIik7DQoJCQ0KCQlGaWVsZERlY2xhcmF0aW9u
IGZpZWxkID0gdHlwZS5nZXRGaWVsZHMoKVswXTsNCgkJQW5ub3RhdGlvbiBhbm5vdGF0aW9uID0g
IChBbm5vdGF0aW9uKWZpZWxkLm1vZGlmaWVycygpLmdldCgxKTsNCgkJew0KCQkJTWFya2VyQW5u
b3RhdGlvbiBtYXJrZXJBbm5vdGF0aW9uPSBhc3QubmV3TWFya2VyQW5ub3RhdGlvbigpOw0KCQkJ
bWFya2VyQW5ub3RhdGlvbi5zZXRUeXBlTmFtZShhc3QubmV3U2ltcGxlTmFtZSgiQSIpKTsNCg0K
CQkJTGlzdFJld3JpdGUgbGlzdFJld3JpdGU9IHJld3JpdGUuZ2V0TGlzdFJld3JpdGUoZmllbGQs
IEZpZWxkRGVjbGFyYXRpb24uTU9ESUZJRVJTMl9QUk9QRVJUWSk7DQoJCQlsaXN0UmV3cml0ZS5p
bnNlcnRCZWZvcmUobWFya2VyQW5ub3RhdGlvbiwgYW5ub3RhdGlvbiwgbnVsbCk7DQoJCX0NCgkJ
U3RyaW5nIHByZXZpZXcgPSBldmFsdWF0ZVJld3JpdGUoY3UsIHJld3JpdGUpOw0KCQlidWY9IG5l
dyBTdHJpbmdCdWZmZXIoKTsNCgkJYnVmLmFwcGVuZCgicGFja2FnZSB0ZXN0MTtcbiIpOw0KCQli
dWYuYXBwZW5kKCJpbXBvcnQgamF2YS5sYW5nLmFubm90YXRpb24uRWxlbWVudFR5cGU7XG4iKTsN
CgkJYnVmLmFwcGVuZCgicHVibGljIGNsYXNzIFgge1xuIik7DQoJCWJ1Zi5hcHBlbmQoIglwdWJs
aWMgQEEgQEFubm90IGludCBiO1xuIik7ICANCgkJYnVmLmFwcGVuZCgiQGphdmEubGFuZy5hbm5v
dGF0aW9uLlRhcmdldCh2YWx1ZSA9IHtFbGVtZW50VHlwZS5UWVBFX1VTRX0pXG4iKTsgDQoJCWJ1
Zi5hcHBlbmQoIkBpbnRlcmZhY2UgQW5ub3Qge31cbiIpOw0KCQlhc3NlcnRFcXVhbFN0cmluZyhw
cmV2aWV3LCBidWYudG9TdHJpbmcoKSk7DQoJfQ0KfQ0KDQo=
</data>

          </attachment>
          <attachment
              isobsolete="1"
              ispatch="1"
              isprivate="0"
          >
            <attachid>228806</attachid>
            <date>2013-03-20 23:42:00 -0400</date>
            <delta_ts>2014-01-07 10:12:17 -0500</delta_ts>
            <desc>Testcase as a patch to reproduce</desc>
            <filename>401848-test-case-patch.patch</filename>
            <type>text/plain</type>
            <size>2291</size>
            <attacher name="Manoj Palat Away Until May 11 2015">manpalat</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL29yZy5lY2xpcHNlLmpkdC5jb3JlLnRlc3RzLm1vZGVsL3NyYy9vcmcvZWNs
aXBzZS9qZHQvY29yZS90ZXN0cy9yZXdyaXRlL2Rlc2NyaWJpbmcvQVNUUmV3cml0aW5nVHlwZURl
Y2xUZXN0LmphdmEgYi9vcmcuZWNsaXBzZS5qZHQuY29yZS50ZXN0cy5tb2RlbC9zcmMvb3JnL2Vj
bGlwc2UvamR0L2NvcmUvdGVzdHMvcmV3cml0ZS9kZXNjcmliaW5nL0FTVFJld3JpdGluZ1R5cGVE
ZWNsVGVzdC5qYXZhCmluZGV4IDU0NmE1Y2IuLmFhZDkwMjcgMTAwNjQ0Ci0tLSBhL29yZy5lY2xp
cHNlLmpkdC5jb3JlLnRlc3RzLm1vZGVsL3NyYy9vcmcvZWNsaXBzZS9qZHQvY29yZS90ZXN0cy9y
ZXdyaXRlL2Rlc2NyaWJpbmcvQVNUUmV3cml0aW5nVHlwZURlY2xUZXN0LmphdmEKKysrIGIvb3Jn
LmVjbGlwc2UuamR0LmNvcmUudGVzdHMubW9kZWwvc3JjL29yZy9lY2xpcHNlL2pkdC9jb3JlL3Rl
c3RzL3Jld3JpdGUvZGVzY3JpYmluZy9BU1RSZXdyaXRpbmdUeXBlRGVjbFRlc3QuamF2YQpAQCAt
MTkyOCw2ICsxOTI4LDQyIEBACiAJCWJ1Zi5hcHBlbmQoIkBpbnRlcmZhY2UgQW5ub3QyIHt9XG4i
KTsKIAkJYXNzZXJ0RXF1YWxTdHJpbmcocHJldmlldywgYnVmLnRvU3RyaW5nKCkpOwogCX0KKwlw
dWJsaWMgdm9pZCB0ZXN0UHJpbWl0aXZlVHlwZSgpIHRocm93cyBFeGNlcHRpb24geworCQlpZiAo
dGhpcy5hcGlMZXZlbCA8IEFTVC5KTFM4KSByZXR1cm47CisJCUlQYWNrYWdlRnJhZ21lbnQgcGFj
azE9IHRoaXMuc291cmNlRm9sZGVyLmNyZWF0ZVBhY2thZ2VGcmFnbWVudCgidGVzdDEiLCBmYWxz
ZSwgbnVsbCk7CisJCVN0cmluZ0J1ZmZlciBidWY9IG5ldyBTdHJpbmdCdWZmZXIoKTsKKwkJYnVm
LmFwcGVuZCgicGFja2FnZSB0ZXN0MTtcbiIpOworCQlidWYuYXBwZW5kKCJpbXBvcnQgamF2YS5s
YW5nLmFubm90YXRpb24uRWxlbWVudFR5cGU7XG4iKTsKKwkJYnVmLmFwcGVuZCgicHVibGljIGNs
YXNzIFgge1xuIik7CisJCWJ1Zi5hcHBlbmQoIglwdWJsaWMgQEFubm90IGludCBiO1xuIik7ICAK
KwkJYnVmLmFwcGVuZCgiQGphdmEubGFuZy5hbm5vdGF0aW9uLlRhcmdldCh2YWx1ZSA9IHtFbGVt
ZW50VHlwZS5UWVBFX1VTRX0pXG4iKTsgCisJCWJ1Zi5hcHBlbmQoIkBpbnRlcmZhY2UgQW5ub3Qg
e31cbiIpOworCQlJQ29tcGlsYXRpb25Vbml0IGN1PSBwYWNrMS5jcmVhdGVDb21waWxhdGlvblVu
aXQoIlguamF2YSIsIGJ1Zi50b1N0cmluZygpLCBmYWxzZSwgbnVsbCk7CisKKwkJQ29tcGlsYXRp
b25Vbml0IGFzdFJvb3Q9IGNyZWF0ZUFTVChjdSk7CisJCUFTVFJld3JpdGUgcmV3cml0ZT0gQVNU
UmV3cml0ZS5jcmVhdGUoYXN0Um9vdC5nZXRBU1QoKSk7CisJCUFTVCBhc3Q9IGFzdFJvb3QuZ2V0
QVNUKCk7CisJCVR5cGVEZWNsYXJhdGlvbiB0eXBlPSBmaW5kVHlwZURlY2xhcmF0aW9uKGFzdFJv
b3QsICJYIik7CisJCQorCQlGaWVsZERlY2xhcmF0aW9uIGZpZWxkID0gdHlwZS5nZXRGaWVsZHMo
KVswXTsKKwkJQW5ub3RhdGlvbiBhbm5vdGF0aW9uID0gIChBbm5vdGF0aW9uKWZpZWxkLm1vZGlm
aWVycygpLmdldCgxKTsKKwkJeworCQkJTWFya2VyQW5ub3RhdGlvbiBtYXJrZXJBbm5vdGF0aW9u
PSBhc3QubmV3TWFya2VyQW5ub3RhdGlvbigpOworCQkJbWFya2VyQW5ub3RhdGlvbi5zZXRUeXBl
TmFtZShhc3QubmV3U2ltcGxlTmFtZSgiQSIpKTsKKworCQkJTGlzdFJld3JpdGUgbGlzdFJld3Jp
dGU9IHJld3JpdGUuZ2V0TGlzdFJld3JpdGUoZmllbGQsIEZpZWxkRGVjbGFyYXRpb24uTU9ESUZJ
RVJTMl9QUk9QRVJUWSk7CisJCQlsaXN0UmV3cml0ZS5pbnNlcnRCZWZvcmUobWFya2VyQW5ub3Rh
dGlvbiwgYW5ub3RhdGlvbiwgbnVsbCk7CisJCX0KKwkJU3RyaW5nIHByZXZpZXcgPSBldmFsdWF0
ZVJld3JpdGUoY3UsIHJld3JpdGUpOworCQlidWY9IG5ldyBTdHJpbmdCdWZmZXIoKTsKKwkJYnVm
LmFwcGVuZCgicGFja2FnZSB0ZXN0MTtcbiIpOworCQlidWYuYXBwZW5kKCJpbXBvcnQgamF2YS5s
YW5nLmFubm90YXRpb24uRWxlbWVudFR5cGU7XG4iKTsKKwkJYnVmLmFwcGVuZCgicHVibGljIGNs
YXNzIFgge1xuIik7CisJCWJ1Zi5hcHBlbmQoIglwdWJsaWMgQEEgQEFubm90IGludCBiO1xuIik7
ICAKKwkJYnVmLmFwcGVuZCgiQGphdmEubGFuZy5hbm5vdGF0aW9uLlRhcmdldCh2YWx1ZSA9IHtF
bGVtZW50VHlwZS5UWVBFX1VTRX0pXG4iKTsgCisJCWJ1Zi5hcHBlbmQoIkBpbnRlcmZhY2UgQW5u
b3Qge31cbiIpOworCQlhc3NlcnRFcXVhbFN0cmluZyhwcmV2aWV3LCBidWYudG9TdHJpbmcoKSk7
CisJfQogCiAKIH0=
</data>

          </attachment>
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>238733</attachid>
            <date>2014-01-07 10:12:00 -0500</date>
            <delta_ts>2014-01-07 10:12:17 -0500</delta_ts>
            <desc>Test case</desc>
            <filename>Bug-401848-Test-Case-Patch.patch</filename>
            <type>text/plain</type>
            <size>3295</size>
            <attacher name="Manoj Palat Away Until May 11 2015">manpalat</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL29yZy5lY2xpcHNlLmpkdC5jb3JlLnRlc3RzLm1vZGVsL3NyYy9vcmcvZWNs
aXBzZS9qZHQvY29yZS90ZXN0cy9yZXdyaXRlL2Rlc2NyaWJpbmcvQVNUUmV3cml0aW5nVHlwZURl
Y2xUZXN0LmphdmEgYi9vcmcuZWNsaXBzZS5qZHQuY29yZS50ZXN0cy5tb2RlbC9zcmMvb3JnL2Vj
bGlwc2UvamR0L2NvcmUvdGVzdHMvcmV3cml0ZS9kZXNjcmliaW5nL0FTVFJld3JpdGluZ1R5cGVE
ZWNsVGVzdC5qYXZhCmluZGV4IGFmNTFkOGMuLjE2YjliMGYgMTAwNjQ0Ci0tLSBhL29yZy5lY2xp
cHNlLmpkdC5jb3JlLnRlc3RzLm1vZGVsL3NyYy9vcmcvZWNsaXBzZS9qZHQvY29yZS90ZXN0cy9y
ZXdyaXRlL2Rlc2NyaWJpbmcvQVNUUmV3cml0aW5nVHlwZURlY2xUZXN0LmphdmEKKysrIGIvb3Jn
LmVjbGlwc2UuamR0LmNvcmUudGVzdHMubW9kZWwvc3JjL29yZy9lY2xpcHNlL2pkdC9jb3JlL3Rl
c3RzL3Jld3JpdGUvZGVzY3JpYmluZy9BU1RSZXdyaXRpbmdUeXBlRGVjbFRlc3QuamF2YQpAQCAt
NDksNiArNDksNyBAQAogaW1wb3J0IG9yZy5lY2xpcHNlLmpkdC5jb3JlLmRvbS5QcmltaXRpdmVU
eXBlOwogaW1wb3J0IG9yZy5lY2xpcHNlLmpkdC5jb3JlLmRvbS5TaW1wbGVOYW1lOwogaW1wb3J0
IG9yZy5lY2xpcHNlLmpkdC5jb3JlLmRvbS5TaW1wbGVQcm9wZXJ0eURlc2NyaXB0b3I7CitpbXBv
cnQgb3JnLmVjbGlwc2UuamR0LmNvcmUuZG9tLlNpbXBsZVR5cGU7CiBpbXBvcnQgb3JnLmVjbGlw
c2UuamR0LmNvcmUuZG9tLlNpbmdsZU1lbWJlckFubm90YXRpb247CiBpbXBvcnQgb3JnLmVjbGlw
c2UuamR0LmNvcmUuZG9tLlNpbmdsZVZhcmlhYmxlRGVjbGFyYXRpb247CiBpbXBvcnQgb3JnLmVj
bGlwc2UuamR0LmNvcmUuZG9tLlN0cmluZ0xpdGVyYWw7CkBAIC0xOTY2LDUgKzE5NjcsNTEgQEAK
IAkJSVR5cGVCaW5kaW5nIG1lbWJlclR5cGVCaW5kaW5nID0gbWVtYmVyVHlwZURlY2xhcmF0aW9u
LnJlc29sdmVCaW5kaW5nKCk7CiAJCWFzc2VydFRydWUoKG1lbWJlclR5cGVCaW5kaW5nLmdldE1v
ZGlmaWVycygpICYgTW9kaWZpZXIuU1RBVElDKSAhPSAwKTsKIAl9CisJcHVibGljIHZvaWQgdGVz
dEJ1ZzQwMTg0OF9zaW5jZV84KCkgdGhyb3dzIEV4Y2VwdGlvbiB7CisJCUlQYWNrYWdlRnJhZ21l
bnQgcGFjazE9IHRoaXMuc291cmNlRm9sZGVyLmNyZWF0ZVBhY2thZ2VGcmFnbWVudCgidGVzdDEi
LCBmYWxzZSwgbnVsbCk7CisJCVN0cmluZ0J1ZmZlciBidWY9IG5ldyBTdHJpbmdCdWZmZXIoKTsK
KwkJYnVmLmFwcGVuZCgicGFja2FnZSB0ZXN0MTtcbiIpOworCQlidWYuYXBwZW5kKCJpbXBvcnQg
amF2YS5sYW5nLmFubm90YXRpb24uRWxlbWVudFR5cGU7XG4iKTsKKwkJYnVmLmFwcGVuZCgicHVi
bGljIGNsYXNzIFggZXh0ZW5kcyBAQW5ub3QgWSB7XG4iKTsKKwkJYnVmLmFwcGVuZCgiICBwdWJs
aWMgQEFubm90IGludCBpO1xuIik7CisJCWJ1Zi5hcHBlbmQoIn1cbiIpOworCQlidWYuYXBwZW5k
KCJjbGFzcyBZIHt9XG4iKTsKKwkJYnVmLmFwcGVuZCgiQGphdmEubGFuZy5hbm5vdGF0aW9uLlRh
cmdldCh2YWx1ZSA9IHtFbGVtZW50VHlwZS5UWVBFX1VTRX0pXG4iKTsgCisJCWJ1Zi5hcHBlbmQo
IkBpbnRlcmZhY2UgQW5ub3Qge31cbiIpOworCQlJQ29tcGlsYXRpb25Vbml0IGN1PSBwYWNrMS5j
cmVhdGVDb21waWxhdGlvblVuaXQoIlguamF2YSIsIGJ1Zi50b1N0cmluZygpLCBmYWxzZSwgbnVs
bCk7CisKKwkJQ29tcGlsYXRpb25Vbml0IGFzdFJvb3Q9IGNyZWF0ZUFTVChjdSk7CisJCUFTVFJl
d3JpdGUgcmV3cml0ZT0gQVNUUmV3cml0ZS5jcmVhdGUoYXN0Um9vdC5nZXRBU1QoKSk7CisJCUFT
VCBhc3Q9IGFzdFJvb3QuZ2V0QVNUKCk7CisJCVR5cGVEZWNsYXJhdGlvbiB0eXBlRGVjbGFyYXRp
b24gPSBmaW5kVHlwZURlY2xhcmF0aW9uKGFzdFJvb3QsICJYIik7CisJCQorCQlTaW1wbGVUeXBl
IHNpbXBsZVR5cGUgPSAoU2ltcGxlVHlwZSkgdHlwZURlY2xhcmF0aW9uLmdldFN1cGVyY2xhc3NU
eXBlKCk7CisJCUFubm90YXRpb24gYW5ub3RhdGlvbiA9ICAoQW5ub3RhdGlvbilzaW1wbGVUeXBl
LmFubm90YXRpb25zKCkuZ2V0KDApOworCQl7CisJCQlNYXJrZXJBbm5vdGF0aW9uIG1hcmtlckFu
bm90YXRpb249IGFzdC5uZXdNYXJrZXJBbm5vdGF0aW9uKCk7CisJCQltYXJrZXJBbm5vdGF0aW9u
LnNldFR5cGVOYW1lKGFzdC5uZXdTaW1wbGVOYW1lKCJBIikpOworCQkJTGlzdFJld3JpdGUgbGlz
dFJld3JpdGU9IHJld3JpdGUuZ2V0TGlzdFJld3JpdGUoc2ltcGxlVHlwZSwgU2ltcGxlVHlwZS5B
Tk5PVEFUSU9OU19QUk9QRVJUWSk7CisJCQlsaXN0UmV3cml0ZS5pbnNlcnRCZWZvcmUobWFya2Vy
QW5ub3RhdGlvbiwgYW5ub3RhdGlvbiwgbnVsbCk7CisJCX0KKwkJeworCQkJRmllbGREZWNsYXJh
dGlvbiBmaWVsZCA9IHR5cGVEZWNsYXJhdGlvbi5nZXRGaWVsZHMoKVswXTsKKwkJCWFubm90YXRp
b24gPSAgKEFubm90YXRpb24pZmllbGQubW9kaWZpZXJzKCkuZ2V0KDEpOworCQkJTWFya2VyQW5u
b3RhdGlvbiBtYXJrZXJBbm5vdGF0aW9uPSBhc3QubmV3TWFya2VyQW5ub3RhdGlvbigpOworCQkJ
bWFya2VyQW5ub3RhdGlvbi5zZXRUeXBlTmFtZShhc3QubmV3U2ltcGxlTmFtZSgiQSIpKTsKKwkJ
CUxpc3RSZXdyaXRlIGxpc3RSZXdyaXRlPSByZXdyaXRlLmdldExpc3RSZXdyaXRlKGZpZWxkLCBG
aWVsZERlY2xhcmF0aW9uLk1PRElGSUVSUzJfUFJPUEVSVFkpOworCQkJbGlzdFJld3JpdGUuaW5z
ZXJ0QmVmb3JlKG1hcmtlckFubm90YXRpb24sIGFubm90YXRpb24sIG51bGwpOworCQl9CisJCVN0
cmluZyBwcmV2aWV3ID0gZXZhbHVhdGVSZXdyaXRlKGN1LCByZXdyaXRlKTsKKwkJYnVmPSBuZXcg
U3RyaW5nQnVmZmVyKCk7CisJCWJ1Zi5hcHBlbmQoInBhY2thZ2UgdGVzdDE7XG4iKTsKKwkJYnVm
LmFwcGVuZCgiaW1wb3J0IGphdmEubGFuZy5hbm5vdGF0aW9uLkVsZW1lbnRUeXBlO1xuIik7CisJ
CWJ1Zi5hcHBlbmQoInB1YmxpYyBjbGFzcyBYIGV4dGVuZHMgQEEgQEFubm90IFkge1xuIik7CisJ
CWJ1Zi5hcHBlbmQoIiAgcHVibGljIEBBIEBBbm5vdCBpbnQgaTtcbiIpOworCQlidWYuYXBwZW5k
KCJ9XG4iKTsKKwkJYnVmLmFwcGVuZCgiY2xhc3MgWSB7fVxuIik7CisJCWJ1Zi5hcHBlbmQoIkBq
YXZhLmxhbmcuYW5ub3RhdGlvbi5UYXJnZXQodmFsdWUgPSB7RWxlbWVudFR5cGUuVFlQRV9VU0V9
KVxuIik7IAorCQlidWYuYXBwZW5kKCJAaW50ZXJmYWNlIEFubm90IHt9XG4iKTsKKwkJYXNzZXJ0
RXF1YWxTdHJpbmcocHJldmlldywgYnVmLnRvU3RyaW5nKCkpOworCX0KIAogfQ==
</data>

          </attachment>
      

    </bug>

</bugzilla>