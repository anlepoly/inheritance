<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>419748</bug_id>
          
          <creation_ts>2013-10-17 13:09:00 -0400</creation_ts>
          <short_desc>[1.8][dom ast] MethodDeclaration&apos;s receiverType cannot be AnnotatableType</short_desc>
          <delta_ts>2013-10-23 13:42:55 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.3</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Windows 7</op_sys>
          <bug_status>RESOLVED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>BETA J8</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Markus Keller">markus_keller</reporter>
          <assigned_to name="Markus Keller">markus_keller</assigned_to>
          <cc>markus_keller</cc>
    
    <cc>srikanth_sankaran</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2319739</commentid>
    <comment_count>0</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2013-10-17 13:09:18 -0400</bug_when>
    <thetext>MethodDeclaration&apos;s receiverType cannot be an AnnotatableType, since ParameterizedType is not an AnnotatableType. Example:


package jsr335.invalid;

public class C {
    class A&lt;T&gt; {
        class Inner {
             public Inner(A&lt;T&gt; A.this) { }
        }
    }
}

java.lang.ClassCastException: org.eclipse.jdt.core.dom.ParameterizedType cannot be cast to org.eclipse.jdt.core.dom.AnnotatableType
	at org.eclipse.jdt.core.dom.ASTConverter.convertAndSetReceiver(ASTConverter.java:888)
	at org.eclipse.jdt.core.dom.ASTConverter.convert(ASTConverter.java:543)
	at org.eclipse.jdt.core.dom.ASTConverter.buildBodyDeclarations(ASTConverter.java:201)
	at org.eclipse.jdt.core.dom.ASTConverter.convert(ASTConverter.java:2956)
	at org.eclipse.jdt.core.dom.ASTConverter.buildBodyDeclarations(ASTConverter.java:206)
	at org.eclipse.jdt.core.dom.ASTConverter.convert(ASTConverter.java:2956)
	at org.eclipse.jdt.core.dom.ASTConverter.buildBodyDeclarations(ASTConverter.java:206)
	at org.eclipse.jdt.core.dom.ASTConverter.convert(ASTConverter.java:2956)
	at org.eclipse.jdt.core.dom.ASTConverter.convert(ASTConverter.java:1374)
	at org.eclipse.jdt.core.dom.CompilationUnitResolver.convert(CompilationUnitResolver.java:295)
	at org.eclipse.jdt.core.dom.ASTParser.internalCreateAST(ASTParser.java:1212)
	at org.eclipse.jdt.core.dom.ASTParser.createAST(ASTParser.java:812)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2319750</commentid>
    <comment_count>1</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2013-10-17 13:30:24 -0400</bug_when>
    <thetext>Fixed the wrong type in the API with http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=6c3b6971f88c7f6d5be3c70fdaf936700dc7f94b

I&apos;ve added ASTConverter18Test#testParameterizedReceiverType(), but I had to release it in an incomplete version since the source range of the outermost ParameterizedType doesn&apos;t include the annotation. See the commented
//TODO: bad AST node structure:
for the remaining work to be done for this bug.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2319917</commentid>
    <comment_count>2</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2013-10-17 18:57:56 -0400</bug_when>
    <thetext>(In reply to Markus Keller from comment #1)
&gt; Fixed the wrong type in the API with
&gt; http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
&gt; ?id=6c3b6971f88c7f6d5be3c70fdaf936700dc7f94b


Markus, this still leaves org.eclipse.jdt.core.dom.MethodDeclaration.RECEIVER_TYPE_PROPERTY referring
to AnnotatableType - is this intentional ? 

and a few casts in:
org.eclipse.jdt.core.dom.MethodDeclaration.internalGetSetChildProperty(ChildPropertyDescriptor, boolean, ASTNode)

org.eclipse.jdt.core.dom.MethodDeclaration.clone0(AST)


org.eclipse.jdt.core.dom.AnnotatableType

etc.

Would org.eclipse.jdt.internal.core.dom.rewrite.ASTRewriteAnalyzer.rewriteModifiers2(ASTNode, ChildListPropertyDescriptor, int)

hit a CCE for public Inner(final A&lt;T&gt; A.this) ? I didn&apos;t check.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2321063</commentid>
    <comment_count>3</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2013-10-21 09:53:19 -0400</bug_when>
    <thetext>(In reply to Srikanth Sankaran from comment #2)
&gt; Markus, this still leaves
&gt; org.eclipse.jdt.core.dom.MethodDeclaration.* referring
&gt; to AnnotatableType - is this intentional ?

Not intended. All occurrences of &quot;AnnotatableType&quot; in MethodDeclaration should be replaced by &quot;Type&quot; (textual Replace All).


&gt; Would
&gt; org.eclipse.jdt.internal.core.dom.rewrite.ASTRewriteAnalyzer.
&gt; rewriteModifiers2(ASTNode, ChildListPropertyDescriptor, int)
&gt; 
&gt; hit a CCE for public Inner(final A&lt;T&gt; A.this) ? I didn&apos;t check.

I don&apos;t see a possibility for a CCE there; the cast is always protected by the preceding instanceof. But the current DOM API actually misses support for modifiers on the receiver parameter. Filed bug 419974.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2321593</commentid>
    <comment_count>4</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2013-10-22 07:19:31 -0400</bug_when>
    <thetext>(In reply to Markus Keller from comment #3)
&gt; (In reply to Srikanth Sankaran from comment #2)
&gt; &gt; Markus, this still leaves
&gt; &gt; org.eclipse.jdt.core.dom.MethodDeclaration.* referring
&gt; &gt; to AnnotatableType - is this intentional ?
&gt; 
&gt; Not intended. All occurrences of &quot;AnnotatableType&quot; in MethodDeclaration
&gt; should be replaced by &quot;Type&quot; (textual Replace All).

Thanks, Released here: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=BETA_JAVA8&amp;id=56279d048bf630d57d8fac349861b864730cf774

&gt; I don&apos;t see a possibility for a CCE there; the cast is always protected by
&gt; the preceding instanceof. 

Correct. Thanks.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2322275</commentid>
    <comment_count>5</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2013-10-23 13:42:55 -0400</bug_when>
    <thetext>Thanks Srikanth, I think we can close this bug now.

(In reply to Markus Keller from comment #1)
&gt; I&apos;ve added ASTConverter18Test#testParameterizedReceiverType(), but I had to
&gt; release it in an incomplete version since the source range of the outermost
&gt; ParameterizedType doesn&apos;t include the annotation.

Let&apos;s take this over to bug 419974: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=85e8ac1cb08d7a07857723eab3efc805d5dbc4ea</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>