<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>464977</bug_id>
          
          <creation_ts>2015-04-20 03:32:00 -0400</creation_ts>
          <short_desc>[compiler] Deprecated bit not set</short_desc>
          <delta_ts>2015-04-26 23:25:45 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.5</version>
          <rep_platform>All</rep_platform>
          <op_sys>All</op_sys>
          <bug_status>VERIFIED</bug_status>
          <resolution>FIXED</resolution>
          
          <see_also>https://git.eclipse.org/r/46453</see_also>
    
    <see_also>https://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=bc6b27bd92cc1473386e7ebcfc5790ffed5deaf3</see_also>
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>4.5 M7</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Stefan Oehme">stefan.oehme</reporter>
          <assigned_to name="Jay Arthanareeswaran">jarthana</assigned_to>
          <cc>dennis.huebner</cc>
    
    <cc>jan.sievers</cc>
    
    <cc>jarthana</cc>
    
    <cc>manpalat</cc>
    
    <cc>Sebastian.Zarnekow</cc>
    
    <cc>stephan.herrmann</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2548463</commentid>
    <comment_count>0</comment_count>
      <attachid>252526</attachid>
    <who name="Stefan Oehme">stefan.oehme</who>
    <bug_when>2015-04-20 03:32:52 -0400</bug_when>
    <thetext>Created attachment 252526
An example project

@Deprecated
public class DeprecatedClass {}


Compiling this class with the tycho-compiler-plugin, I expect the deprecated bit to be set in the class file. But it isn&apos;t.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2548588</commentid>
    <comment_count>1</comment_count>
    <who name="Tobias Oberlies">tobias.oberlies</who>
    <bug_when>2015-04-20 06:17:34 -0400</bug_when>
    <thetext>Tycho is using the JDT compiler. Did you also report the problem to them?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2548797</commentid>
    <comment_count>2</comment_count>
    <who name="Stefan Oehme">stefan.oehme</who>
    <bug_when>2015-04-20 11:23:33 -0400</bug_when>
    <thetext>The same code compiles correctly inside Eclipse with JDT 3.10 installed.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2548828</commentid>
    <comment_count>3</comment_count>
    <who name="Jan Sievers">jan.sievers</who>
    <bug_when>2015-04-20 12:03:27 -0400</bug_when>
    <thetext>not sure why this happens but her is how to test it (the easiest way I could come up with is to use apache BCEL)

    public static void main(String[] args) throws Exception {
        JavaClass javaClass = new ClassParser(args[0]).parse();
        System.out.println(Arrays.asList(javaClass.getAttributes()));
    }


when run on the sample class compiled in eclipse, it shows

[SourceFile(DeprecatedClass.java), Deprecated, (Unknown attribute RuntimeVisibleAnnotations: 00 01 00 13 00 00)]


whereas the same file compiled with Tycho as per sample it shows

[SourceFile(DeprecatedClass.java), (Unknown attribute RuntimeVisibleAnnotations: 00 01 00 12 00 00)]

note the missing Deprectaed attribute.
it seems the problem is the same also with Tycho 0.23.0-SNAPSHOT

any chance deprecated attributes in bytecode are optional and it&apos;s just a matter of (default) configuration?

I also checked if activating APT has any impact (similar as bug 453474) but it seems this does not affect the problem here.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2548855</commentid>
    <comment_count>4</comment_count>
    <who name="Stefan Oehme">stefan.oehme</who>
    <bug_when>2015-04-20 12:30:45 -0400</bug_when>
    <thetext>You can run

javap -v &lt;classFile&gt; to get a more readable representation of the class.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2548858</commentid>
    <comment_count>5</comment_count>
    <who name="Stefan Oehme">stefan.oehme</who>
    <bug_when>2015-04-20 12:33:25 -0400</bug_when>
    <thetext>Also, when I add the @deprecated JavaDoc tag, it works:

/**
 * @deprecated
 */
@Deprecated
public class DeprecatedClass {}

But the doc tag should not be required.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2549092</commentid>
    <comment_count>6</comment_count>
    <who name="Jan Sievers">jan.sievers</who>
    <bug_when>2015-04-21 02:53:20 -0400</bug_when>
    <thetext>(In reply to Stefan Oehme from comment #5)
&gt; Also, when I add the @deprecated JavaDoc tag, it works:
&gt; 
&gt; /**
&gt;  * @deprecated
&gt;  */
&gt; @Deprecated
&gt; public class DeprecatedClass {}
&gt; 
&gt; But the doc tag should not be required.

I hava a hunch this is similar to JDT bug 453474 where annotations were also involved.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551127</commentid>
    <comment_count>7</comment_count>
    <who name="Sebastian Zarnekow">Sebastian.Zarnekow</who>
    <bug_when>2015-04-24 04:00:32 -0400</bug_when>
    <thetext>Any news on this one?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551259</commentid>
    <comment_count>8</comment_count>
    <who name="Jan Sievers">jan.sievers</who>
    <bug_when>2015-04-24 06:15:11 -0400</bug_when>
    <thetext>(In reply to Sebastian Zarnekow from comment #7)
&gt; Any news on this one?

I was right with my suspicion in comment 6.

this is a JDT bug that only happens if 

org.eclipse.jdt.compiler.apt

is also on the compiler&apos;s runtime classpath.

Tycho always adds this fragment to the compiler classpath (as a plain jar in a maven classloader environment) because it&apos;s needed as soon as APT is configured by the user and in general should not hurt. Looks like in this case it does hurt.

What I did to verify this is to build Tycho 0.23.0-SNAPSHOT and simply remove org.eclipse.jdt.compiler.apt. If you use this patched version of Tycho, the deprecated bit is present in the classfile (as per javap -v).

I was not able to reproduce this in eclipse by enabling Annotation Processing in the project&apos;s compiler settings, but maybe there is some lazy loading and it&apos;s only actually loaded/activated when you use APT annotations. 

Forwarding to JDT.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551260</commentid>
    <comment_count>9</comment_count>
    <who name="Jan Sievers">jan.sievers</who>
    <bug_when>2015-04-24 06:15:42 -0400</bug_when>
    <thetext>Forgot to mention: this was tested using JDT from Luna M6</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551262</commentid>
    <comment_count>10</comment_count>
      <attachid>252725</attachid>
    <who name="Jan Sievers">jan.sievers</who>
    <bug_when>2015-04-24 06:17:46 -0400</bug_when>
    <thetext>Created attachment 252725
tycho patch which removes compiler.apt</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551271</commentid>
    <comment_count>11</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2015-04-24 06:50:33 -0400</bug_when>
    <thetext>(In reply to Jan Sievers from comment #6)
&gt; I hava a hunch this is similar to JDT bug 453474 where annotations were also
&gt; involved.

I thought so too, but that bug (via original bug 436486) was fixed in M5.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551273</commentid>
    <comment_count>12</comment_count>
    <who name="Jan Sievers">jan.sievers</who>
    <bug_when>2015-04-24 06:53:20 -0400</bug_when>
    <thetext>workaround (unless you actually use APT) is to exclude org.eclipse.jdt.compiler.apt for the time being:

&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.eclipse.tycho&lt;/groupId&gt;
      &lt;artifactId&gt;tycho-compiler-plugin&lt;/artifactId&gt;
      &lt;version&gt;${tycho-version}&lt;/version&gt;
      &lt;dependencies&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.eclipse.tycho&lt;/groupId&gt; 
          &lt;artifactId&gt;tycho-compiler-jdt&lt;/artifactId&gt;
          &lt;version&gt;${tycho-version}&lt;/version&gt;
          &lt;exclusions&gt;
            &lt;exclusion&gt;
              &lt;groupId&gt;org.eclipse.tycho&lt;/groupId&gt; 
              &lt;artifactId&gt;org.eclipse.jdt.compiler.apt&lt;/artifactId&gt;
            &lt;/exclusion&gt;
          &lt;/exclusions&gt;
        &lt;/dependency&gt;
      &lt;/dependencies&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551274</commentid>
    <comment_count>13</comment_count>
    <who name="Jan Sievers">jan.sievers</who>
    <bug_when>2015-04-24 06:55:49 -0400</bug_when>
    <thetext>(In reply to Jay Arthanareeswaran from comment #11)
&gt; (In reply to Jan Sievers from comment #6)
&gt; &gt; I hava a hunch this is similar to JDT bug 453474 where annotations were also
&gt; &gt; involved.
&gt; 
&gt; I thought so too, but that bug (via original bug 436486) was fixed in M5.

sure. it&apos;s similar but not the same. 

as I said I tested with Luna M6 and this particular bug is still present.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551287</commentid>
    <comment_count>14</comment_count>
    <who name="Stefan Oehme">stefan.oehme</who>
    <bug_when>2015-04-24 07:19:05 -0400</bug_when>
    <thetext>Since we don&apos;t use apt, that workaround will do it for us until this is fixed. Thanks for figuring that out =)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551333</commentid>
    <comment_count>15</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2015-04-24 08:29:14 -0400</bug_when>
    <thetext>I can reproduce. Looks like in this particular case, when APT is involved, we re missing a call to SourceTypeBinding#getAnnotationTagBits(). I am working on a fix.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551546</commentid>
    <comment_count>16</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2015-04-24 12:43:07 -0400</bug_when>
    <thetext>Hmm... I have a feeling we have been here before but making this change makes it work:


@@ -231,7 +230,7 @@ public class AnnotationDiscoveryVisitor extends ASTVisitor {

                boolean old = scope.insideTypeAnnotation;
                scope.insideTypeAnnotation = true;
-               ASTNode.resolveAnnotations(scope, annotations, currentBinding);
+               currentBinding.getAnnotationTagBits();
                scope.insideTypeAnnotation = old;

Stephan, what do you think?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551597</commentid>
    <comment_count>17</comment_count>
    <who name="Eclipse Genie">genie</who>
    <bug_when>2015-04-24 14:36:41 -0400</bug_when>
    <thetext>New Gerrit change created: https://git.eclipse.org/r/46453</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551671</commentid>
    <comment_count>18</comment_count>
    <who name="Stephan Herrmann">stephan.herrmann</who>
    <bug_when>2015-04-24 19:11:11 -0400</bug_when>
    <thetext>(In reply to Jay Arthanareeswaran from comment #16)
&gt; Hmm... I have a feeling we have been here before

That is my feeling exactly.

&gt; but making this change makes it work:
&gt; 
&gt; 
&gt; @@ -231,7 +230,7 @@ public class AnnotationDiscoveryVisitor extends
&gt; ASTVisitor {
&gt; 
&gt;                 boolean old = scope.insideTypeAnnotation;
&gt;                 scope.insideTypeAnnotation = true;
&gt; -               ASTNode.resolveAnnotations(scope, annotations,
&gt; currentBinding);
&gt; +               currentBinding.getAnnotationTagBits();
&gt;                 scope.insideTypeAnnotation = old;
&gt; 
&gt; Stephan, what do you think?

I think you already had it in your hands in bug 436486 comment 9, and I was just too much afraid of additional effects so I recommended differently. This current bug proves: yes, your patch produces additional effects: fixing this bug, too :)

Also, I had hoped to get rid of calls to getAnnotationTagBits() from clients that aren&apos;t even looking at the result. But that&apos;s mainly a matter of method name (get*) vs. semantics (producing side-effects).

Rather than suggesting even &quot;cleaner&quot;, but incomplete alternatives, I humbly retriggered the gerrit build (assuming that the failure in JavaSearchBugsTests.testBug181488a is unrelated).</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551729</commentid>
    <comment_count>19</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2015-04-25 07:19:26 -0400</bug_when>
    <thetext>Thanks Stephan. Just to be sure, I also ran all compiler tests with APT enabled (ref bug 455427) and to my pleasant surprise, I saw lesser failures than reported at bug 455427, comment #4.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551742</commentid>
    <comment_count>20</comment_count>
    <who name="Eclipse Genie">genie</who>
    <bug_when>2015-04-25 09:12:59 -0400</bug_when>
    <thetext>Gerrit change https://git.eclipse.org/r/46453 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=bc6b27bd92cc1473386e7ebcfc5790ffed5deaf3</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551743</commentid>
    <comment_count>21</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2015-04-25 09:15:25 -0400</bug_when>
    <thetext>Resolving.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2551911</commentid>
    <comment_count>22</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2015-04-26 23:25:45 -0400</bug_when>
    <thetext>Verified for Eclipse Mars 4.5 M7 Build id I20150426-2000</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="0"
              isprivate="0"
          >
            <attachid>252526</attachid>
            <date>2015-04-20 03:32:00 -0400</date>
            <delta_ts>2015-04-20 03:32:52 -0400</delta_ts>
            <desc>An example project</desc>
            <filename>test.zip</filename>
            <type>application/x-zip-compressed</type>
            <size>1319</size>
            <attacher name="Stefan Oehme">stefan.oehme</attacher>
            
              <data encoding="base64">UEsDBBQAAAAIAGhLlEbSW2D7PwAAAFAAAAAVAAAAdGVzdC9idWlsZC5wcm9wZXJ0aWVzK84vLUpO
1dNTsFUoLkrW5+XKLy0pKC0BCyRl5gEFgKReZl5yTmlKajFQ0Nc1xFHX089NXyeGl0sBFejxcgEA
UEsDBBQAAAAAAH1LlEYAAAAAAAAAAAAAAAAOAAAAdGVzdC9NRVRBLUlORi9QSwMEFAAAAAgAoUuU
RvXvuAp/AAAAswAAABkAAAB0ZXN0L01FVEEtSU5GL01BTklGRVNULk1GPc3BCgIhEMbx+8K+gy+g
aIcO3gq8BBvRQvfJnQVBR3JVsqevhfA6v//HTEBuxS3zB6bNRdJMCTkO50KLRz79teOh09zCM3pn
rxBQszXGLj2WQgrVz3d8FZdwMW+0Jf8CQ9WlSAEpa3aBCrPhShz74GSzq7CXt/1R08zDp43DF1BL
AwQUAAAACACLS5RG8ycWZzIBAAD8AgAADAAAAHRlc3QvcG9tLnhtbK2SzU7DMBCEzyDxDlXu8aah
p8jkjtQKJCTErXJdNzUktmU7P7w9a6ehyQEJIW6Z2dndz6tQY/W74H41NLVyD8nZe1MANKwTijDD
+FkQbSt4ftrBhmQkS8ZkMTj5ne77nvT3MZdn2RredtsXbGxYKpXzTHGR3N3eYEfhor3VnHmp1S/W
rX5KRCPtNvtsn5HBHZMSV9BGH0X9KqzD6WUcQGHhhRAO+WCVVFUpeC2NE6mpW9QUrpWQq6xuzeOx
PDBLYRKh0F2G4XiyptDNZjPr5Ylxj8mT1hRmGsshcWhlHQWCxLUuikmN4roc30oumMR/8rNeoITk
bEUMpONppjctCULDFT/Pw4Fm/KEsBi9UMFzpbSsozIyRFOao/8fNdWNkLexf0Rdck4jMFKaroz3+
8Pj9BVBLAwQUAAAAAABES5RGAAAAAAAAAAAAAAAACQAAAHRlc3Qvc3JjL1BLAwQUAAAACABGS5RG
Taao6H0AAACXAAAAHQAAAHRlc3Qvc3JjL0RlcHJlY2F0ZWRDbGFzcy5qYXZhRY27CgIxFERrA/cf
ptSA7C+saLOdsJ3dzQMMxpslDy0W/90ogs3AzJlhBq1JQWPkVq8pY/aGSw0suHAWf0tP7DFJ6FGE
TVJzMK2GJGBxOJynz3ogNZ78kr3l6h2ppZkYLGzkUvAHx69fSZHa/CqPFBzuvl+77Q7rqxNSXd9Q
SwECFAAUAAAACABoS5RG0ltg+z8AAABQAAAAFQAAAAAAAAABACAAAAAAAAAAdGVzdC9idWlsZC5w
cm9wZXJ0aWVzUEsBAhQAFAAAAAAAfUuURgAAAAAAAAAAAAAAAA4AAAAAAAAAAAAQAAAAcgAAAHRl
c3QvTUVUQS1JTkYvUEsBAhQAFAAAAAgAoUuURvXvuAp/AAAAswAAABkAAAAAAAAAAQAgAAAAngAA
AHRlc3QvTUVUQS1JTkYvTUFOSUZFU1QuTUZQSwECFAAUAAAACACLS5RG8ycWZzIBAAD8AgAADAAA
AAAAAAABACAAAABUAQAAdGVzdC9wb20ueG1sUEsBAhQAFAAAAAAAREuURgAAAAAAAAAAAAAAAAkA
AAAAAAAAAAAQAAAAsAIAAHRlc3Qvc3JjL1BLAQIUABQAAAAIAEZLlEZNpqjofQAAAJcAAAAdAAAA
AAAAAAEAIAAAANcCAAB0ZXN0L3NyYy9EZXByZWNhdGVkQ2xhc3MuamF2YVBLBQYAAAAABgAGAIIB
AACPAwAAAAA=
</data>

          </attachment>
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>252725</attachid>
            <date>2015-04-24 06:17:00 -0400</date>
            <delta_ts>2015-04-24 06:17:46 -0400</delta_ts>
            <desc>tycho patch which removes compiler.apt</desc>
            <filename>0001-Patch-that-removes-compiler.apt-from.patch</filename>
            <type>text/plain</type>
            <size>1058</size>
            <attacher name="Jan Sievers">jan.sievers</attacher>
            
              <data encoding="base64">RnJvbSBiMjc3MzhmYTVjNjBkYWVmNDgwNGQ1ZWMxOGE1MTM0NTVmNWY1NmNmIE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBKYW4gU2lldmVycyA8amFuLnNpZXZlcnNAc2FwLmNvbT4KRGF0
ZTogRnJpLCAyNCBBcHIgMjAxNSAxMjoxMzoxMCArMDIwMApTdWJqZWN0OiBbUEFUQ0hdIFBhdGNo
IHRoYXQgcmVtb3ZlcyBjb21waWxlci5hcHQgZnJvbQoKdGhlIEpEVCBjb21waWxlcidzIHJ1bnRp
bWUgaW4gVHljaG8uCi0tLQogdHljaG8tY29tcGlsZXItamR0L3BvbS54bWwgfCA4ICsrKystLS0t
CiAxIGZpbGUgY2hhbmdlZCwgNCBpbnNlcnRpb25zKCspLCA0IGRlbGV0aW9ucygtKQoKZGlmZiAt
LWdpdCBhL3R5Y2hvLWNvbXBpbGVyLWpkdC9wb20ueG1sIGIvdHljaG8tY29tcGlsZXItamR0L3Bv
bS54bWwKaW5kZXggMmM5ZmI3NC4uNTQzYTNkZiAxMDA2NDQKLS0tIGEvdHljaG8tY29tcGlsZXIt
amR0L3BvbS54bWwKKysrIGIvdHljaG8tY29tcGlsZXItamR0L3BvbS54bWwKQEAgLTM3LDEwICsz
NywxMCBAQAogCQkJPGdyb3VwSWQ+b3JnLmVjbGlwc2UudHljaG88L2dyb3VwSWQ+CiAJCQk8YXJ0
aWZhY3RJZD5vcmcuZWNsaXBzZS5qZHQuY29yZTwvYXJ0aWZhY3RJZD4KIAkJPC9kZXBlbmRlbmN5
PgotCQk8ZGVwZW5kZW5jeT4KLQkJCTxncm91cElkPm9yZy5lY2xpcHNlLnR5Y2hvPC9ncm91cElk
PgotCQkJPGFydGlmYWN0SWQ+b3JnLmVjbGlwc2UuamR0LmNvbXBpbGVyLmFwdDwvYXJ0aWZhY3RJ
ZD4KLQkJPC9kZXBlbmRlbmN5PgorPCEtLSAJCTxkZXBlbmRlbmN5PiAtLT4KKzwhLS0gCQkJPGdy
b3VwSWQ+b3JnLmVjbGlwc2UudHljaG88L2dyb3VwSWQ+IC0tPgorPCEtLSAJCQk8YXJ0aWZhY3RJ
ZD5vcmcuZWNsaXBzZS5qZHQuY29tcGlsZXIuYXB0PC9hcnRpZmFjdElkPiAtLT4KKzwhLS0gCQk8
L2RlcGVuZGVuY3k+IC0tPgogCQk8ZGVwZW5kZW5jeT4KIAkJCTxncm91cElkPm9yZy5jb2RlaGF1
cy5wbGV4dXM8L2dyb3VwSWQ+CiAJCQk8YXJ0aWZhY3RJZD5wbGV4dXMtY29tcGlsZXItYXBpPC9h
cnRpZmFjdElkPgotLSAKMS45LjUubXN5c2dpdC4wCgo=
</data>

          </attachment>
      

    </bug>

</bugzilla>