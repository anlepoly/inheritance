<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>464312</bug_id>
          
          <creation_ts>2015-04-09 11:56:00 -0400</creation_ts>
          <short_desc>[formatter] for K_STATEMENTS, inserts an unexpected line delimiter after initial comment</short_desc>
          <delta_ts>2015-04-27 04:41:43 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.5</version>
          <rep_platform>All</rep_platform>
          <op_sys>All</op_sys>
          <bug_status>VERIFIED</bug_status>
          <resolution>FIXED</resolution>
          
          <see_also>https://git.eclipse.org/r/45752</see_also>
    
    <see_also>https://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=c8b40f13d99ab69db864b013de9cae48200942a8</see_also>
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>4.5 M7</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Markus Keller">markus_keller</reporter>
          <assigned_to name="Markus Keller">markus_keller</assigned_to>
          <cc>daniel_megert</cc>
    
    <cc>manpalat</cc>
    
    <cc>markus_keller</cc>
    
    <cc>mateusz.matela</cc>
    
    <cc>shankhba</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2544384</commentid>
    <comment_count>0</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2015-04-09 11:56:10 -0400</bug_when>
    <thetext>Format this line with CodeFormatter.K_STATEMENTS:

/**/int f;

This inserts an unexpected line delimiter after the comment.

I have a fix ready.


Original steps from Dani:

- have code:

package p;
public class A {
	static_fin
}

- put caret after &quot;static_fin&quot;, press Ctrl+Space, and apply the template

=&gt; was:
	public 
	static final String NAME = &quot;&quot;;

=&gt; expected:
	public static final String NAME = &quot;&quot;;</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2544388</commentid>
    <comment_count>1</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2015-04-09 12:02:06 -0400</bug_when>
    <thetext>Fixed with http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=24242f27a56569515f3a766b79af5b4f6c52fffe</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2544664</commentid>
    <comment_count>2</comment_count>
    <who name="Dani Megert">daniel_megert</who>
    <bug_when>2015-04-10 04:15:43 -0400</bug_when>
    <thetext>Verified in N20150409-2000.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2545061</commentid>
    <comment_count>3</comment_count>
    <who name="Mateusz Matela">mateusz.matela</who>
    <bug_when>2015-04-10 14:26:08 -0400</bug_when>
    <thetext>Actually, the excess line break before the first statement is supposed to be 1) moved in front of the initial comment (by CommentsPreparator#handleWhitespaceAround) and then 2) removed altogether (by WrapPreparator#preserveExistingLineBreaks, with instruction first.putLineBreaksBefore(startingBreaks - 1);).
The step 1) was not done because of the false negative on the additional condition commented as /* doesn&apos;t apply to a comment before the package declaration */.
Instead of commentIndex &gt; 0, this condition should be !this.tm.isInHeader(commentIndex).

The commited solution also works, but it&apos;s less compatible with the overall formatter logic. It&apos;s better to fix a bug in the already existing mechanism that should take care of the reported problem.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2545644</commentid>
    <comment_count>4</comment_count>
    <who name="Eclipse Genie">genie</who>
    <bug_when>2015-04-13 08:52:03 -0400</bug_when>
    <thetext>New Gerrit change created: https://git.eclipse.org/r/45752</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2545711</commentid>
    <comment_count>5</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2015-04-13 10:25:40 -0400</bug_when>
    <thetext>(In reply to Mateusz Matela from comment #3)
&gt; It&apos;s better to fix a bug in the already existing mechanism
&gt; that should take care of the reported problem.

Yes, I agree. Thanks for looking at this, Mateusz.

However, when I tried your proposed fix, I got 4 test failures in the RunFormatterTests e.g. org.eclipse.jdt.core.tests.formatter.FormatterBugsTests#testBug199265c1(), where a line break gets added between the line comment and the class declaration:

---
import java.util.List;

//            CU         snippet
public class X03 {
	List field;
}
---</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2545920</commentid>
    <comment_count>6</comment_count>
    <who name="Mateusz Matela">mateusz.matela</who>
    <bug_when>2015-04-13 16:41:26 -0400</bug_when>
    <thetext>(In reply to Markus Keller from comment #5)
&gt; However, when I tried your proposed fix, I got 4 test failures in the
&gt; RunFormatterTests

Oh, sorry - I thought I&apos;ve run all the tests before making this suggestion, but apparently not.
OK, so the condition should actually be: next.tokenType != TokenNamepackage
This time it&apos;s tested :)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2546236</commentid>
    <comment_count>7</comment_count>
    <who name="Eclipse Genie">genie</who>
    <bug_when>2015-04-14 10:14:17 -0400</bug_when>
    <thetext>Gerrit change https://git.eclipse.org/r/45752 was merged to [master].
Commit: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=c8b40f13d99ab69db864b013de9cae48200942a8</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2546240</commentid>
    <comment_count>8</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2015-04-14 10:17:00 -0400</bug_when>
    <thetext>(In reply to Mateusz Matela from comment #6)
&gt; OK, so the condition should actually be: next.tokenType != TokenNamepackage
&gt; This time it&apos;s tested :)

Yes, this looks better. Fix has been pushed.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2552039</commentid>
    <comment_count>9</comment_count>
    <who name="shankha banerjee">shankhba</who>
    <bug_when>2015-04-27 04:41:43 -0400</bug_when>
    <thetext>Verified for 4.5M7 using I20150421-0800 build.</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>