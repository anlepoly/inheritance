<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>393537</bug_id>
          
          <creation_ts>2012-11-05 06:00:00 -0500</creation_ts>
          <short_desc>[1.7][compiler] Wrong bytecode for string switch with empty default</short_desc>
          <delta_ts>2012-12-11 05:21:34 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.2.1</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Windows 7</op_sys>
          <bug_status>VERIFIED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>4.3 M4</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Christoph Leiter">mail</reporter>
          <assigned_to name="Olivier Thomann">Olivier_Thomann</assigned_to>
          <cc>jarthana</cc>
    
    <cc>Olivier_Thomann</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2179374</commentid>
    <comment_count>0</comment_count>
    <who name="Christoph Leiter">mail</who>
    <bug_when>2012-11-05 06:00:55 -0500</bug_when>
    <thetext>This code

public class Main {
    public static void main(String[] args) {
        switch (&quot;&quot;) {
        case &quot;&quot;:
        default:
        }
    }
}

fails with

Exception in thread &quot;main&quot; java.lang.ClassFormatError: Invalid pc in LineNumberTable in class file Main
	at java.lang.ClassLoader.defineClass1(Native Method)
	at java.lang.ClassLoader.defineClass(ClassLoader.java:791)
	at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142)
	at java.net.URLClassLoader.defineClass(URLClassLoader.java:449)
	at java.net.URLClassLoader.access$100(URLClassLoader.java:71)
	at java.net.URLClassLoader$1.run(URLClassLoader.java:361)
	at java.net.URLClassLoader$1.run(URLClassLoader.java:355)
	at java.security.AccessController.doPrivileged(Native Method)
	at java.net.URLClassLoader.findClass(URLClassLoader.java:354)
	at java.lang.ClassLoader.loadClass(ClassLoader.java:423)
	at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:308)
	at java.lang.ClassLoader.loadClass(ClassLoader.java:356)
	at sun.launcher.LauncherHelper.checkAndLoadMain(LauncherHelper.java:480)

Only happens if there&apos;s no break statement for the default case and there are no other statements after the switch in the method. Compiles fine with javac.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2179607</commentid>
    <comment_count>1</comment_count>
    <who name="Olivier Thomann">Olivier_Thomann</who>
    <bug_when>2012-11-05 12:13:19 -0500</bug_when>
    <thetext>The problem comes from an optimized bytecode. It is optimized out, but we try to insert a line number table entry to a position that no longer exists.
I think the fix is to simply insert a check to make sure we don&apos;t try to record a line number entry that is beyond the code stream position.
Patch to follow.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2179609</commentid>
    <comment_count>2</comment_count>
      <attachid>223190</attachid>
    <who name="Olivier Thomann">Olivier_Thomann</who>
    <bug_when>2012-11-05 12:24:49 -0500</bug_when>
    <thetext>Created attachment 223190
Proposed fix</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2179610</commentid>
    <comment_count>3</comment_count>
      <attachid>223191</attachid>
    <who name="Olivier Thomann">Olivier_Thomann</who>
    <bug_when>2012-11-05 12:25:05 -0500</bug_when>
    <thetext>Created attachment 223191
Regression test</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2180350</commentid>
    <comment_count>4</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2012-11-07 01:13:13 -0500</bug_when>
    <thetext>Thanks for the patch, Olivier. All tests pass and patch released here:

http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=2243a1720484174384e2e167f3a772c6dbdd7151</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2192833</commentid>
    <comment_count>5</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2012-12-11 04:00:41 -0500</bug_when>
    <thetext>Verified for 4.3 M4 with build I20121210-2000</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>223190</attachid>
            <date>2012-11-05 12:24:00 -0500</date>
            <delta_ts>2012-11-05 12:24:49 -0500</delta_ts>
            <desc>Proposed fix</desc>
            <filename>patch_393537.txt</filename>
            <type>text/plain</type>
            <size>1152</size>
            <attacher name="Olivier Thomann">Olivier_Thomann</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL29yZy5lY2xpcHNlLmpkdC5jb3JlL2NvbXBpbGVyL29yZy9lY2xpcHNlL2pk
dC9pbnRlcm5hbC9jb21waWxlci9jb2RlZ2VuL0NvZGVTdHJlYW0uamF2YSBiL29yZy5lY2xpcHNl
LmpkdC5jb3JlL2NvbXBpbGVyL29yZy9lY2xpcHNlL2pkdC9pbnRlcm5hbC9jb21waWxlci9jb2Rl
Z2VuL0NvZGVTdHJlYW0uamF2YQppbmRleCBhYzdiYmU5Li5kOTk4NDM2IDEwMDY0NAotLS0gYS9v
cmcuZWNsaXBzZS5qZHQuY29yZS9jb21waWxlci9vcmcvZWNsaXBzZS9qZHQvaW50ZXJuYWwvY29t
cGlsZXIvY29kZWdlbi9Db2RlU3RyZWFtLmphdmEKKysrIGIvb3JnLmVjbGlwc2UuamR0LmNvcmUv
Y29tcGlsZXIvb3JnL2VjbGlwc2UvamR0L2ludGVybmFsL2NvbXBpbGVyL2NvZGVnZW4vQ29kZVN0
cmVhbS5qYXZhCkBAIC0xLDUgKzEsNSBAQAogLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKLSAqIENv
cHlyaWdodCAoYykgMjAwMCwgMjAxMSBJQk0gQ29ycG9yYXRpb24gYW5kIG90aGVycy4KKyAqIENv
cHlyaWdodCAoYykgMjAwMCwgMjAxMiBJQk0gQ29ycG9yYXRpb24gYW5kIG90aGVycy4KICAqIEFs
bCByaWdodHMgcmVzZXJ2ZWQuIFRoaXMgcHJvZ3JhbSBhbmQgdGhlIGFjY29tcGFueWluZyBtYXRl
cmlhbHMKICAqIGFyZSBtYWRlIGF2YWlsYWJsZSB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEVjbGlw
c2UgUHVibGljIExpY2Vuc2UgdjEuMAogICogd2hpY2ggYWNjb21wYW5pZXMgdGhpcyBkaXN0cmli
dXRpb24sIGFuZCBpcyBhdmFpbGFibGUgYXQKQEAgLTU4NDEsNyArNTg0MSw4IEBACiAJICovCiAJ
aWYgKCh0aGlzLmdlbmVyYXRlQXR0cmlidXRlcyAmIENsYXNzRmlsZUNvbnN0YW50cy5BVFRSX0xJ
TkVTKSA9PSAwCiAJCQl8fCBzb3VyY2VQb3MgPT0gMAotCQkJfHwgKHN0YXJ0UEMgPT0gdGhpcy5w
b3NpdGlvbiAmJiAhd2lkZW4pKQorCQkJfHwgKHN0YXJ0UEMgPT0gdGhpcy5wb3NpdGlvbiAmJiAh
d2lkZW4pCisJCQl8fCBzdGFydFBDID4gdGhpcy5wb3NpdGlvbikKIAkJcmV0dXJuOwogCiAJLy8g
V2lkZW5pbmcgYW4gZXhpc3RpbmcgZW50cnkgdGhhdCBhbHJlYWR5IGhhcyB0aGUgc2FtZSBzb3Vy
Y2UgcG9zaXRpb25z
</data>

          </attachment>
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>223191</attachid>
            <date>2012-11-05 12:25:00 -0500</date>
            <delta_ts>2012-11-05 12:25:05 -0500</delta_ts>
            <desc>Regression test</desc>
            <filename>patch_393537_tests.txt</filename>
            <type>text/plain</type>
            <size>1615</size>
            <attacher name="Olivier Thomann">Olivier_Thomann</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL29yZy5lY2xpcHNlLmpkdC5jb3JlLnRlc3RzLmNvbXBpbGVyL3NyYy9vcmcv
ZWNsaXBzZS9qZHQvY29yZS90ZXN0cy9jb21waWxlci9yZWdyZXNzaW9uL1N3aXRjaFRlc3QuamF2
YSBiL29yZy5lY2xpcHNlLmpkdC5jb3JlLnRlc3RzLmNvbXBpbGVyL3NyYy9vcmcvZWNsaXBzZS9q
ZHQvY29yZS90ZXN0cy9jb21waWxlci9yZWdyZXNzaW9uL1N3aXRjaFRlc3QuamF2YQppbmRleCA2
ZDFlM2VhLi4zNzY2MWM0IDEwMDY0NAotLS0gYS9vcmcuZWNsaXBzZS5qZHQuY29yZS50ZXN0cy5j
b21waWxlci9zcmMvb3JnL2VjbGlwc2UvamR0L2NvcmUvdGVzdHMvY29tcGlsZXIvcmVncmVzc2lv
bi9Td2l0Y2hUZXN0LmphdmEKKysrIGIvb3JnLmVjbGlwc2UuamR0LmNvcmUudGVzdHMuY29tcGls
ZXIvc3JjL29yZy9lY2xpcHNlL2pkdC9jb3JlL3Rlc3RzL2NvbXBpbGVyL3JlZ3Jlc3Npb24vU3dp
dGNoVGVzdC5qYXZhCkBAIC0zMiw3ICszMiw3IEBACiAKIHN0YXRpYyB7CiAvLwlURVNUU19OVU1C
RVJTID0gbmV3IGludFtdIHsgMjIgfTsKLS8vCVRFU1RTX05BTUVTID0gbmV3IFN0cmluZ1tdIHsg
InRlc3RGb3IzNTYwMDIiLCAidGVzdEZvcjM1NjAwMl8yIiwgInRlc3RGb3IzNTYwMDJfMyIgfTsK
Ky8vCVRFU1RTX05BTUVTID0gbmV3IFN0cmluZ1tdIHsgInRlc3QzOTM1MzciIH07CiB9CiBwdWJs
aWMgU3dpdGNoVGVzdChTdHJpbmcgbmFtZSkgewogCXN1cGVyKG5hbWUpOwpAQCAtMjYyMSw2ICsy
NjIxLDM0IEBACiAJdHJ1ZSwKIAlvcHRpb25zKTsKIH0KKy8vSkRLNzogU3RyaW5ncyBpbiBTd2l0
Y2guCitwdWJsaWMgdm9pZCB0ZXN0MzkzNTM3KCkgeworCVN0cmluZyBlcnJvck1zZyA9IAkJCisJ
CQkiLS0tLS0tLS0tLVxuIiArIAorCQkJIjEuIEVSUk9SIGluIFguamF2YSAoYXQgbGluZSAzKVxu
IiArIAorCQkJIglzd2l0Y2ggKFwiXCIpIHtcbiIgKyAKKwkJCSIJICAgICAgICBeXlxuIiArIAor
CQkJIkNhbm5vdCBzd2l0Y2ggb24gYSB2YWx1ZSBvZiB0eXBlIFN0cmluZyBmb3Igc291cmNlIGxl
dmVsIGJlbG93IDEuNy4gT25seSBjb252ZXJ0aWJsZSBpbnQgdmFsdWVzIG9yIGVudW0gdmFyaWFi
bGVzIGFyZSBwZXJtaXR0ZWRcbiIgKyAKKwkJCSItLS0tLS0tLS0tXG4iOworCQorCVN0cmluZyBb
XSBzb3VyY2VGaWxlcyA9IAorCQluZXcgU3RyaW5nW10geworCQkiWC5qYXZhIiwKKwkJInB1Ymxp
YyBjbGFzcyBYIHtcbiIgKyAKKwkJIglwdWJsaWMgc3RhdGljIHZvaWQgbWFpbihTdHJpbmdbXSBh
cmdzKSB7XG4iICsgCisJCSIJCXN3aXRjaCAoXCJcIikge1xuIiArIAorCQkiCQkJY2FzZSBcIlwi
OlxuIiArIAorCQkiCQkJZGVmYXVsdDpcbiIgKyAKKwkJIgkJfVxuIiArIAorCQkiCX1cbiIgKyAK
KwkJIn0iLAorCX07CisJaWYgKHRoaXMuY29tcGxpYW5jZUxldmVsIDwgSkRLTGV2ZWxTdXBwb3J0
aW5nU3RyaW5nU3dpdGNoKSB7CisJCXRoaXMucnVuTmVnYXRpdmVUZXN0KHNvdXJjZUZpbGVzLCBl
cnJvck1zZyk7CisJfSBlbHNlIHsKKwkJdGhpcy5ydW5Db25mb3JtVGVzdChzb3VyY2VGaWxlcywg
IiIpOworCX0KK30KIHB1YmxpYyBzdGF0aWMgQ2xhc3MgdGVzdENsYXNzKCkgewogCXJldHVybiBT
d2l0Y2hUZXN0LmNsYXNzOwogfQ==
</data>

          </attachment>
      

    </bug>

</bugzilla>