<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>427627</bug_id>
          
          <creation_ts>2014-02-07 03:00:00 -0500</creation_ts>
          <short_desc>[1.8] List.toArray not compiled correctly (NoSuchMethodError) within Lambda</short_desc>
          <delta_ts>2014-02-12 05:49:21 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.4</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Windows 7</op_sys>
          <bug_status>VERIFIED</bug_status>
          <resolution>WORKSFORME</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>major</bug_severity>
          <target_milestone>BETA J8</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="John Hendrikx">hjohn</reporter>
          <assigned_to name="Srikanth Sankaran">srikanth_sankaran</assigned_to>
          <cc>srikanth_sankaran</cc>
    
    <cc>stephan.herrmann</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2359971</commentid>
    <comment_count>0</comment_count>
    <who name="John Hendrikx">hjohn</who>
    <bug_when>2014-02-07 03:00:43 -0500</bug_when>
    <thetext>This is using Early access release III.  Below is the code where the error occurs:

    parent.addStep(context.getUpdateExecutor(), p -&gt; {
      for(Identifier identifier : newIdentifiers) {
        mediaData.addIdentifier(identifier);
      }

      List&lt;SourceKey&gt; keys = new ArrayList&lt;&gt;();

      for(Identifier identifier : mediaItem.mediaData.get().identifiers.get()) {
        EntitySource source = sourceMatcher.sourceFromString(identifier.providerId.get().getProvider());

        if(source != null) {
          keys.add(new SourceKey(source, identifier.providerId.get().getId()));
        }
      }

      if(!keys.isEmpty()) {
        context.associate(mediaItem, keys.toArray(new SourceKey[keys.size()]));  // Line 130
      }
    });

And here is the relevant part of the stacktrace when trying to run the Eclipse compiled code (Maven compiled code runs fine):

Exception in thread &quot;JavaFX Application Thread&quot; java.lang.NoSuchMethodError: java.util.List.toArray([Lhs/mediasystem/entity/SourceKey;)Lhs/mediasystem/entity/SourceKey;
	at hs.mediasystem.framework.MediaItemEnricher.lambda$3(MediaItemEnricher.java:130)
	at hs.mediasystem.framework.MediaItemEnricher$$Lambda$50/17337967.run(Unknown Source)
	at hs.mediasystem.util.Task.run(Task.java:52)

Line 130 is marked in the source above.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2360374</commentid>
    <comment_count>1</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-02-07 13:49:27 -0500</bug_when>
    <thetext>John, any chance we can get a compilable program that shows the problem ?

Stephan, note the unerased signature - not sure what would explain it - yet,</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2360500</commentid>
    <comment_count>2</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-02-07 21:32:30 -0500</bug_when>
    <thetext>The method descriptor does not look right: 

java.util.List.toArray([Lhs/mediasystem/entity/SourceKey;)Lhs/mediasystem/entity/SourceKey

I would have expected to see (erased version) of

java.util.List.toArray([Lhs/mediasystem/entity/SourceKey;)[Lhs/mediasystem/entity/SourceKey

i.e return type should be an array (&apos;[&apos; missing in the attempted method&apos;s return 
type)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2360548</commentid>
    <comment_count>3</comment_count>
    <who name="John Hendrikx">hjohn</who>
    <bug_when>2014-02-08 07:10:07 -0500</bug_when>
    <thetext>Here is a small program that demonstrates the bug.  I didn&apos;t try to make it as small as possible, you may be able to remove more.  The exception it generates is:

Exception in thread &quot;main&quot; java.lang.NoSuchMethodError: java.util.List.toArray([LToListBug$SourceKey;)LToListBug$SourceKey;
	at ToListBug.lambda$0(ToListBug.java:9)
	at ToListBug$$Lambda$1/7600556.run(Unknown Source)
	at ToListBug.main(ToListBug.java:12)

The program:

import java.util.ArrayList;
import java.util.List;

public class ToListBug {
  public static void main(String[] args) {
    Runnable r = () -&gt; {
      List&lt;SourceKey&gt; keys = new ArrayList&lt;&gt;();

      associate(&quot;Test&quot;, keys.toArray(new SourceKey[keys.size()]));
    };

    r.run();
  }

  private static void associate(String o, SourceKey... keys) {
  }

  public class SourceKey {
    public SourceKey(Object source, Object key) {
    }
  }
}</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2360549</commentid>
    <comment_count>4</comment_count>
    <who name="John Hendrikx">hjohn</who>
    <bug_when>2014-02-08 07:14:01 -0500</bug_when>
    <thetext>I can confirm also that the method signatures I copy/pasted are accurate, so it may be that the return type is indeed missing the array identifier &quot;[&quot;.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2360550</commentid>
    <comment_count>5</comment_count>
    <who name="John Hendrikx">hjohn</who>
    <bug_when>2014-02-08 07:15:36 -0500</bug_when>
    <thetext>It also happens without the Lambda...

import java.util.ArrayList;
import java.util.List;

public class ToListBug {
  public static void main(String[] args) {
    List&lt;SourceKey&gt; keys = new ArrayList&lt;&gt;();

    associate(&quot;Test&quot;, keys.toArray(new SourceKey[keys.size()]));
  }

  private static void associate(String o, SourceKey... keys) {
  }

  public class SourceKey {
    public SourceKey(Object source, Object key) {
    }
  }
}

Exception in thread &quot;main&quot; java.lang.NoSuchMethodError: java.util.List.toArray([LToListBug$SourceKey;)LToListBug$SourceKey;
	at ToListBug.main(ToListBug.java:8)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2360553</commentid>
    <comment_count>6</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-02-08 07:45:44 -0500</bug_when>
    <thetext>John, thanks for the examples, I don&apos;t see this problem on branch HEAD
or on the latest JAVA8 bundles from the update site dated   

Eclipse Java Development Tools Patch for Java 8 Support (BETA)	1.0.0.v20140208-0104_BETA_JAVA8	org.eclipse.jdt.java8patch.feature.group	Eclipse.org

Even on the prior days&apos;s bundles the program runs fine. Could you update and
recheck.

For my part, I&apos;ll use the git revision history to do time travel to see if
I can locate a commit before which this fails.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2360554</commentid>
    <comment_count>7</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-02-08 07:49:02 -0500</bug_when>
    <thetext>(In reply to John Hendrikx from comment #0)
&gt; This is using Early access release III.  Below is the code where the error
&gt; occurs:

(FYI: the early access bundles are refreshed nightly. Since the time of the
announcement, we have fixed close to 50 defects reported by beta users as well
as found internally. We are requesting beta testers to refresh frequently
to pull in the fixes, even though that also means there is a bit of a risk
there that there could be regressions along with many good fixes - we will
try and offer prompt fixes for reproducible issues. When raising a defect
always include the bundle timestamps)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2360556</commentid>
    <comment_count>8</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-02-08 08:03:36 -0500</bug_when>
    <thetext>Good news: 

By time travelling back to 

http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=BETA_JAVA8&amp;id=e6d1c8eac73b65997182b9feaba7e190099afd1a

(Jan 31st - the last commit that went it for EAR III) I am able to reproduce
the problem.)

So some commit in between has resolved this issue. 

I&apos;ll track down the specific commit for curiosity purposes, add regression tests
and resolve. 

In the mean time John if you could verify from your end, the problem goes away
that would be super too. TIA.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2360577</commentid>
    <comment_count>9</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-02-08 12:07:47 -0500</bug_when>
    <thetext>This appears to have been taken care of the fix for bug 427282.

Regression test released here: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=BETA_JAVA8&amp;id=63dd1e4003395d388ef82cdd13a585b9acf5cf2a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2362075</commentid>
    <comment_count>10</comment_count>
    <who name="John Hendrikx">hjohn</who>
    <bug_when>2014-02-12 05:47:15 -0500</bug_when>
    <thetext>Looks good on my end too after updating the bundles.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2362077</commentid>
    <comment_count>11</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-02-12 05:49:21 -0500</bug_when>
    <thetext>(In reply to John Hendrikx from comment #10)
&gt; Looks good on my end too after updating the bundles.

Appreciate the note, thanks!</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>