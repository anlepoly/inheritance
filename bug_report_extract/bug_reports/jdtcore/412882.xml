<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>412882</bug_id>
          
          <creation_ts>2013-07-12 14:47:00 -0400</creation_ts>
          <short_desc>Unnecessary validation of optional library classpath entries.</short_desc>
          <delta_ts>2013-11-18 11:41:21 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.3</version>
          <rep_platform>All</rep_platform>
          <op_sys>All</op_sys>
          <bug_status>RESOLVED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>4.3 M4</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Thirumala Reddy Mutchukota">thirumala</reporter>
          <assigned_to name="Jay Arthanareeswaran">jarthana</assigned_to>
          <cc>daniel_megert</cc>
    
    <cc>jarthana</cc>
    
    <cc>markus_keller</cc>
    
    <cc>tparker</cc>
          
          <votes>0</votes>

      

      

      <flag name="review"
          id="59935"
          type_id="1"
          status="+"
          setter="jarthana"
    />

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2284027</commentid>
    <comment_count>0</comment_count>
    <who name="Thirumala Reddy Mutchukota">thirumala</who>
    <bug_when>2013-07-12 14:47:57 -0400</bug_when>
    <thetext>During the classpath validation first all the classpath entries are validated and then the validation status is not reported for the optional entries. Due to that when large number of optional entries existed on classpath a majority of portion is spent on their validation which is of no use.

In a project with 12000+ optional library jars, setRawclaasspath is spending  more than 90% of time on this unnecessary validation. Here is the call tree captured with a profiler ...

- 21,925 ms org.eclipse.jdt.internal.core.JavaProject.setRawClasspath
 - 21,925 ms org.eclipse.jdt.internal.core.JavaProject.setRawClasspath
  - 21,925 ms org.eclipse.jdt.internal.core.JavaModelOperation.runOperation
   - 21,675 ms org.eclipse.core.internal.resources.Workspace.run
    - 21,675 ms org.eclipse.jdt.internal.core.JavaModelOperation.run
     - 21,675 ms org.eclipse.jdt.internal.core.SetClasspathOperation.executeOperation
      - 20,500 ms org.eclipse.jdt.internal.core.ChangeClasspathOperation.classpathChanged
       - 20,376 ms org.eclipse.jdt.internal.core.ClasspathValidation.validate
        - 20,214 ms org.eclipse.jdt.internal.core.ClasspathEntry.validateClasspathEntry
         - 20,214 ms org.eclipse.jdt.internal.core.ClasspathEntry.validateClasspathEntry
          - 19,978 ms org.eclipse.jdt.internal.core.ClasspathEntry.validateLibraryEntry
           - 13,461 ms org.eclipse.jdt.internal.core.ClasspathEntry.validateLibraryContents
            - 13,461 ms org.eclipse.jdt.internal.core.JavaModelManager.verifyArchiveContent
             - 12,023 ms org.eclipse.jdt.internal.core.JavaModelManager.getZipFile
              - 12,006 ms java.util.zip.ZipFile.&lt;init&gt;
               - 5,511 s org.eclipse.core.internal.resources.Workspace.getRoot
                - 5,439 s org.eclipse.core.runtime.Path.toFile
                 - 1,438 ms org.eclipse.jdt.internal.core.JavaModelManager.closeZipFile

I am working on a patch to avoid this unncessery validation and will send it across soon.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2284083</commentid>
    <comment_count>1</comment_count>
    <who name="Thirumala Reddy Mutchukota">thirumala</who>
    <bug_when>2013-07-12 18:12:14 -0400</bug_when>
    <thetext>I pushed the patch (https://git.eclipse.org/r/#/c/14524/) to Gerrit. I added Jayaprakash Arthanareeswaran as reviewer to the change, please let me know if I need to add anyone else too.

I didn&apos;t added a regression test as I didn&apos;t find any simple way to validate that some file is not read during the classpath validation. In addition to that as this change is not changing any behaviour and only avoiding some unnecessary work, I thought it would be ok with out a test. Please let me know if the test is required and there is possible way to write one.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2284091</commentid>
    <comment_count>2</comment_count>
    <who name="Thirumala Reddy Mutchukota">thirumala</who>
    <bug_when>2013-07-12 18:53:51 -0400</bug_when>
    <thetext>Here is the call tree of setRawClasspath (with my patch) I captured of the same project with 12000+ optional jars. In my observation with this patch the setRawClasspath time went from around 22 seconds to around 4 seconds.

- 3,599 ms org.eclipse.jdt.internal.core.JavaProject.setRawClasspath
 - 3,599 ms org.eclipse.jdt.internal.core.JavaProject.setRawClasspath
   - 3,599 ms org.eclipse.jdt.internal.core.JavaModelOperation.runOperation
    - 3,420 ms org.eclipse.core.internal.resources.Workspace.run
     - 3,420 ms org.eclipse.jdt.internal.core.JavaModelOperation.run
      - 3,420 ms org.eclipse.jdt.internal.core.SetClasspathOperation.executeOperation
       - 2,351 ms org.eclipse.jdt.internal.core.ChangeClasspathOperation.classpathChanged
        - 2,187 ms org.eclipse.jdt.internal.core.ClasspathValidation.validate
         - 2,012 ms org.eclipse.jdt.internal.core.ClasspathEntry.validateClasspathEntry
          - 2,007 ms org.eclipse.jdt.internal.core.ClasspathEntry.validateClasspathEntry
           - 1,958 ms org.eclipse.jdt.internal.core.ClasspathEntry.validateLibraryEntry
            - 1,915 ms org.eclipse.jdt.internal.core.JavaModel.getTarget
             - 1,915 ms org.eclipse.jdt.internal.core.JavaModel.getExternalTarget
              - 1,894 ms java.io.File.isFile
               - 5,229 s org.eclipse.jdt.internal.core.JavaModel.existingExternalFilesAdd</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2284793</commentid>
    <comment_count>3</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-07-16 02:20:31 -0400</bug_when>
    <thetext>Will take a look at the patch sometime next week.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2285302</commentid>
    <comment_count>4</comment_count>
    <who name="Thirumala Reddy Mutchukota">thirumala</who>
    <bug_when>2013-07-16 22:00:12 -0400</bug_when>
    <thetext>I updated the patch to avoid org.eclipse.jdt.internal.core.JavaModel.getTarget -&gt;
org.eclipse.jdt.internal.core.JavaModel.getExternalTarget -&gt; java.io.File.isFile call sequence when JavaCore.CORE_INCOMPATIBLE_JDK_LEVEL project option is set to IGNORE and the library entry is optional. With this change the setRawClasspath execution time came to 2050 ms (from 3599 ms with previous patch and 21,925 ms originally).

I pushed the latest patch to Gerrit as Patch Set 2 and please have a look at it and let me know if you any suggestions.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2289925</commentid>
    <comment_count>5</comment_count>
    <who name="Thirumala Reddy Mutchukota">thirumala</who>
    <bug_when>2013-07-30 16:32:34 -0400</bug_when>
    <thetext>A gentle reminder ...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2292111</commentid>
    <comment_count>6</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-08-07 00:52:19 -0400</bug_when>
    <thetext>(In reply to comment #5)
&gt; A gentle reminder ...

Thanks for the reminder, but this one will have to wait as I am busy with Java 8 work. Let me see if I can find sometime during M2.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2307069</commentid>
    <comment_count>7</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-09-16 04:15:41 -0400</bug_when>
    <thetext>Sorry, but couldn&apos;t spare time for this during M2 amid tight java 8 schedule. Will have to take this up later.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2330604</commentid>
    <comment_count>8</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-11-15 04:49:57 -0500</bug_when>
    <thetext>Patch looks good. Will release it after running the tests once. Also we have existing tests that cover the scenario where optional classpath entries are not marked with classpath problems. So we don&apos;t need new tests.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2330648</commentid>
    <comment_count>9</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-11-15 07:03:59 -0500</bug_when>
    <thetext>Thanks for the patch, Thirumala! Gerrit patch has been merged into master:

http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=b95d0b5c5a2546979ad1285fdd89f2009b47e5cb</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2330752</commentid>
    <comment_count>10</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2013-11-15 10:35:45 -0500</bug_when>
    <thetext>Fixed typos: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=6d909392b424b951896d8712e15f8cc7ac1235db</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2330756</commentid>
    <comment_count>11</comment_count>
    <who name="Thirumala Reddy Mutchukota">thirumala</who>
    <bug_when>2013-11-15 10:43:45 -0500</bug_when>
    <thetext>Thank you Jayaprakash ...

(In reply to Jayaprakash Arthanareeswaran from comment #9)
&gt; Thanks for the patch, Thirumala! Gerrit patch has been merged into master:
&gt; 
&gt; http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
&gt; ?id=b95d0b5c5a2546979ad1285fdd89f2009b47e5cb</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>