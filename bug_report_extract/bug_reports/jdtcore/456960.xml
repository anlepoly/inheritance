<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>456960</bug_id>
          
          <creation_ts>2015-01-07 14:18:00 -0500</creation_ts>
          <short_desc>Broken classfile generated for incorrect annotation usage - case 2</short_desc>
          <delta_ts>2015-03-18 05:07:18 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.5</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Mac OS X</op_sys>
          <bug_status>VERIFIED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>4.5 M6</target_milestone>
          
          <blocked>455608</blocked>
          <everconfirmed>1</everconfirmed>
          <reporter name="Andrew Clement">aclement</reporter>
          <assigned_to name="Olivier Thomann">Olivier_Thomann</assigned_to>
          <cc>daniel_megert</cc>
    
    <cc>jarthana</cc>
    
    <cc>manpalat</cc>
    
    <cc>Olivier_Thomann</cc>
    
    <cc>saammana</cc>
          
          <votes>0</votes>

      

      

      <flag name="review"
          id="64099"
          type_id="1"
          status="+"
          setter="saammana"
    />

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2503005</commentid>
    <comment_count>0</comment_count>
    <who name="Andrew Clement">aclement</who>
    <bug_when>2015-01-07 14:18:30 -0500</bug_when>
    <thetext>This is another variant of bug 434556. Testcode:

===
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;

@Bar(String)
public class Code2 {
 
}

@Retention(RetentionPolicy.RUNTIME)
@interface Bar {
	Class&lt;?&gt;[] value();
}

===

If the annotation is correctly specified as &apos;@Bar(String.class)&apos; then the generated classfile is valid. If just @Bar(String) is used we get an error as expected but the generated class file has an invalid attribute for the annotation. Javap cannot understand it so just prints the bytes:

    RuntimeVisibleAnnotations: length = 0xA
     00 01 00 16 00 01 00 17 00 00 

00 01 = there is one annotation
00 16 = the nameindex for the annotation is 0x16: &apos;LBar;&apos;
00 01 = the annotation has one name value pair
00 17 = the name of the name value pair is at index 0x17: &apos;value&apos;
00 00 = ????? it should be one byte for the type of the annotation value and then a pair for the annotation value index.

This appears to be due to the handling in ClassFile.generateAnnotation() as with that other bug. That fix only got applied to the case of an annotation with multiple values, this time we have an annotation with only one value which is treated differently (as a SingleMemberAnnotation rather than a NormalAnnotation). Similar logic to what was used in the NormalAnnotation case under that bug fix needs applying here. We should be not including the invalid member value. From a cursory look it *might* be slightly different here as the &apos;if (this.contentsOffset == memberValuePairOffset)&apos; may be triggering.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2503138</commentid>
    <comment_count>1</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2015-01-07 23:57:19 -0500</bug_when>
    <thetext>Thanks for the report and analysis, Andrew. 

Sasi, please take a look.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2503381</commentid>
    <comment_count>2</comment_count>
    <who name="Olivier Thomann">Olivier_Thomann</who>
    <bug_when>2015-01-08 10:29:16 -0500</bug_when>
    <thetext>Jay, I can take care of this one as I did the fix that is mentioned in comment 0.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2503393</commentid>
    <comment_count>3</comment_count>
    <who name="Olivier Thomann">Olivier_Thomann</who>
    <bug_when>2015-01-08 10:44:08 -0500</bug_when>
    <thetext>Right now the code tries to remove just the annotation&apos;s value as it is invalid. As this seems to cause problem, the best solution is to remove the annotation all together.
Fix to follow.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2503398</commentid>
    <comment_count>4</comment_count>
      <attachid>249792</attachid>
    <who name="Olivier Thomann">Olivier_Thomann</who>
    <bug_when>2015-01-08 10:47:14 -0500</bug_when>
    <thetext>Created attachment 249792
Proposed patch including a regression test</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2503621</commentid>
    <comment_count>5</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2015-01-08 23:17:32 -0500</bug_when>
    <thetext>Thanks for the patch, Olivier!

Sasi, please review and release this patch.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2511745</commentid>
    <comment_count>6</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2015-01-29 00:02:18 -0500</bug_when>
    <thetext>Sasi, this one slipped through. Please take this up once M5 is out.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2514013</commentid>
    <comment_count>7</comment_count>
    <who name="Sasikanth Bharadwaj">saammana</who>
    <bug_when>2015-02-04 04:07:44 -0500</bug_when>
    <thetext>Patch looks good to me. All tests pass with the patch. Released via http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=51d45c360e379dc3d174cfefd6624f6613e9055b</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2533435</commentid>
    <comment_count>8</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2015-03-18 05:07:18 -0400</bug_when>
    <thetext>Verified for Eclipse Mars 4.5 M6 Build id: I20150317-2000</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>249792</attachid>
            <date>2015-01-08 10:47:00 -0500</date>
            <delta_ts>2015-01-08 10:47:14 -0500</delta_ts>
            <desc>Proposed patch including a regression test</desc>
            <filename>patch_456960.txt</filename>
            <type>text/plain</type>
            <size>3521</size>
            <attacher name="Olivier Thomann">Olivier_Thomann</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL29yZy5lY2xpcHNlLmpkdC5jb3JlLnRlc3RzLmNvbXBpbGVyL3NyYy9vcmcv
ZWNsaXBzZS9qZHQvY29yZS90ZXN0cy9jb21waWxlci9yZWdyZXNzaW9uL0Fubm90YXRpb25UZXN0
LmphdmEgYi9vcmcuZWNsaXBzZS5qZHQuY29yZS50ZXN0cy5jb21waWxlci9zcmMvb3JnL2VjbGlw
c2UvamR0L2NvcmUvdGVzdHMvY29tcGlsZXIvcmVncmVzc2lvbi9Bbm5vdGF0aW9uVGVzdC5qYXZh
CmluZGV4IGEyYzU5MTguLjBlMTdkMjAgMTAwNjQ0Ci0tLSBhL29yZy5lY2xpcHNlLmpkdC5jb3Jl
LnRlc3RzLmNvbXBpbGVyL3NyYy9vcmcvZWNsaXBzZS9qZHQvY29yZS90ZXN0cy9jb21waWxlci9y
ZWdyZXNzaW9uL0Fubm90YXRpb25UZXN0LmphdmEKKysrIGIvb3JnLmVjbGlwc2UuamR0LmNvcmUu
dGVzdHMuY29tcGlsZXIvc3JjL29yZy9lY2xpcHNlL2pkdC9jb3JlL3Rlc3RzL2NvbXBpbGVyL3Jl
Z3Jlc3Npb24vQW5ub3RhdGlvblRlc3QuamF2YQpAQCAtMTEyOTcsNCArMTEyOTcsNjIgQEAKIAl0
aGlzLnJ1bkNvbmZvcm1UZXN0KHRlc3RGaWxlcywgIiIpOwogCWNoZWNrRGlzYXNzZW1ibGVkQ2xh
c3NGaWxlKE9VVFBVVF9ESVIgKyBGaWxlLnNlcGFyYXRvciArICJwL3BhY2thZ2UtaW5mby5jbGFz
cyIsICIiLCAiSEVMTE8iKTsKIH0KKy8vaHR0cHM6Ly9idWdzLmVjbGlwc2Uub3JnL2J1Z3Mvc2hv
d19idWcuY2dpP2lkPTQ1Njk2MAorcHVibGljIHZvaWQgdGVzdDQ1Njk2MCgpIHRocm93cyBFeGNl
cHRpb24geworCWlmICh0aGlzLmNvbXBsaWFuY2VMZXZlbCA8IENsYXNzRmlsZUNvbnN0YW50cy5K
REsxXzUpIHsKKwkJcmV0dXJuOworCX0KKwlNYXAgb3B0aW9ucyA9IGdldENvbXBpbGVyT3B0aW9u
cygpOworCW9wdGlvbnMucHV0KENvbXBpbGVyT3B0aW9ucy5PUFRJT05fU291cmNlLCBDb21waWxl
ck9wdGlvbnMuVkVSU0lPTl8xXzUpOworCW9wdGlvbnMucHV0KENvbXBpbGVyT3B0aW9ucy5PUFRJ
T05fVGFyZ2V0UGxhdGZvcm0sIENvbXBpbGVyT3B0aW9ucy5WRVJTSU9OXzFfNSk7CisJb3B0aW9u
cy5wdXQoQ29tcGlsZXJPcHRpb25zLk9QVElPTl9Db21wbGlhbmNlLCBDb21waWxlck9wdGlvbnMu
VkVSU0lPTl8xXzUpOworCXRoaXMucnVuTmVnYXRpdmVUZXN0KAorCQluZXcgU3RyaW5nW10gewor
CQkJIlguamF2YSIsCisJCQkiQEJhcihTdHJpbmcpXG4iICsgCisJCQkicHVibGljIGNsYXNzIFgg
e1xuIiArCisJCQkifSIsCisJCQkiQmFyLmphdmEiLAorCQkJImltcG9ydCBqYXZhLmxhbmcuYW5u
b3RhdGlvbi5SZXRlbnRpb247XG4iICsgCisJCQkiaW1wb3J0IGphdmEubGFuZy5hbm5vdGF0aW9u
LlJldGVudGlvblBvbGljeTtcbiIgKyAKKwkJCSJAUmV0ZW50aW9uKFJldGVudGlvblBvbGljeS5S
VU5USU1FKVxuIiArIAorCQkJIkBpbnRlcmZhY2UgQmFyIHtcbiIgKyAKKwkJCSIJQ2xhc3M8Pz5b
XSB2YWx1ZSgpO1xuIiArIAorCQkJIn0iCisJCX0sCisJCSItLS0tLS0tLS0tXG4iICsgCisJCSIx
LiBFUlJPUiBpbiBYLmphdmEgKGF0IGxpbmUgMSlcbiIgKyAKKwkJIglAQmFyKFN0cmluZylcbiIg
KyAKKwkJIgkgICAgIF5eXl5eXlxuIiArIAorCQkiU3RyaW5nIGNhbm5vdCBiZSByZXNvbHZlZCB0
byBhIHZhcmlhYmxlXG4iICsgCisJCSItLS0tLS0tLS0tXG4iLAorCQludWxsLAorCQl0cnVlLAor
CQludWxsLAorCQl0cnVlLCAvLyBnZW5lcmF0ZSBvdXRwdXQKKwkJZmFsc2UsCisJCWZhbHNlKTsK
KworCVN0cmluZyBleHBlY3RlZE91dHB1dCA9CisJCQkicHVibGljIGNsYXNzIFgge1xuIiArIAor
CQkJIiAgXG4iICsgCisJCQkiICAvLyBNZXRob2QgZGVzY3JpcHRvciAjNiAoKVZcbiIgKyAKKwkJ
CSIgIC8vIFN0YWNrOiAzLCBMb2NhbHM6IDFcbiIgKyAKKwkJCSIgIHB1YmxpYyBYKCk7XG4iICsg
CisJCQkiICAgICAwICBuZXcgamF2YS5sYW5nLkVycm9yIFs4XVxuIiArIAorCQkJIiAgICAgMyAg
ZHVwXG4iICsgCisJCQkiICAgICA0ICBsZGMgPFN0cmluZyBcIlVucmVzb2x2ZWQgY29tcGlsYXRp
b24gcHJvYmxlbTogXFxuXFx0U3RyaW5nIGNhbm5vdCBiZSByZXNvbHZlZCB0byBhIHZhcmlhYmxl
XFxuXCI+IFsxMF1cbiIgKyAKKwkJCSIgICAgIDYgIGludm9rZXNwZWNpYWwgamF2YS5sYW5nLkVy
cm9yKGphdmEubGFuZy5TdHJpbmcpIFsxMl1cbiIgKyAKKwkJCSIgICAgIDkgIGF0aHJvd1xuIiAr
IAorCQkJIiAgICAgIExpbmUgbnVtYmVyczpcbiIgKyAKKwkJCSIgICAgICAgIFtwYzogMCwgbGlu
ZTogMV1cbiIgKyAKKwkJCSIgICAgICBMb2NhbCB2YXJpYWJsZSB0YWJsZTpcbiIgKyAKKwkJCSIg
ICAgICAgIFtwYzogMCwgcGM6IDEwXSBsb2NhbDogdGhpcyBpbmRleDogMCB0eXBlOiBYXG4iICsg
CisJCQkifSI7CisJdHJ5IHsKKwkJY2hlY2tEaXNhc3NlbWJsZWRDbGFzc0ZpbGUoT1VUUFVUX0RJ
UiArIEZpbGUuc2VwYXJhdG9yICArIlguY2xhc3MiLCAiWCIsIGV4cGVjdGVkT3V0cHV0LCBDbGFz
c0ZpbGVCeXRlc0Rpc2Fzc2VtYmxlci5ERVRBSUxFRCk7CisJfSBjYXRjaChvcmcuZWNsaXBzZS5q
ZHQuY29yZS51dGlsLkNsYXNzRm9ybWF0RXhjZXB0aW9uIGNmZSkgeworCQlmYWlsKCJFcnJvciBy
ZWFkaW5nIGNsYXNzZmlsZSIpOworCX0KK30KIH0KZGlmZiAtLWdpdCBhL29yZy5lY2xpcHNlLmpk
dC5jb3JlL2NvbXBpbGVyL29yZy9lY2xpcHNlL2pkdC9pbnRlcm5hbC9jb21waWxlci9DbGFzc0Zp
bGUuamF2YSBiL29yZy5lY2xpcHNlLmpkdC5jb3JlL2NvbXBpbGVyL29yZy9lY2xpcHNlL2pkdC9p
bnRlcm5hbC9jb21waWxlci9DbGFzc0ZpbGUuamF2YQppbmRleCAzMmQ5ZjUxLi5kMzQ4NDY4IDEw
MDY0NAotLS0gYS9vcmcuZWNsaXBzZS5qZHQuY29yZS9jb21waWxlci9vcmcvZWNsaXBzZS9qZHQv
aW50ZXJuYWwvY29tcGlsZXIvQ2xhc3NGaWxlLmphdmEKKysrIGIvb3JnLmVjbGlwc2UuamR0LmNv
cmUvY29tcGlsZXIvb3JnL2VjbGlwc2UvamR0L2ludGVybmFsL2NvbXBpbGVyL0NsYXNzRmlsZS5q
YXZhCkBAIC0yMzkwLDkgKzIzOTAsOCBAQAogCQkJCXRyeSB7CiAJCQkJCWdlbmVyYXRlRWxlbWVu
dFZhbHVlKHNpbmdsZU1lbWJlckFubm90YXRpb24ubWVtYmVyVmFsdWUsIG1ldGhvZEJpbmRpbmcu
cmV0dXJuVHlwZSwgbWVtYmVyVmFsdWVQYWlyT2Zmc2V0KTsKIAkJCQkJaWYgKHRoaXMuY29udGVu
dHNPZmZzZXQgPT0gbWVtYmVyVmFsdWVQYWlyT2Zmc2V0KSB7Ci0JCQkJCQkvLyBpZ25vcmUgYW5u
b3RhdGlvbiB2YWx1ZQotCQkJCQkJdGhpcy5jb250ZW50c1t0aGlzLmNvbnRlbnRzT2Zmc2V0Kytd
ID0gMDsKLQkJCQkJCXRoaXMuY29udGVudHNbdGhpcy5jb250ZW50c09mZnNldCsrXSA9IDA7CisJ
CQkJCQkvLyBjb21wbGV0ZWx5IHJlbW92ZSB0aGUgYW5ub3RhdGlvbiBhcyBpdHMgdmFsdWUgaXMg
aW52YWxpZAorCQkJCQkJdGhpcy5jb250ZW50c09mZnNldCA9IHN0YXJ0aW5nQ29udGVudHNPZmZz
ZXQ7CiAJCQkJCX0KIAkJCQl9IGNhdGNoKENsYXNzQ2FzdEV4Y2VwdGlvbiBlKSB7CiAJCQkJCXRo
aXMuY29udGVudHNPZmZzZXQgPSBzdGFydGluZ0NvbnRlbnRzT2Zmc2V0Owo=
</data>

          </attachment>
      

    </bug>

</bugzilla>