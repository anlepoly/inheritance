<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>426977</bug_id>
          
          <creation_ts>2014-01-30 05:25:00 -0500</creation_ts>
          <short_desc>[dom ast] CCE: AnnotationTypeDeclaration cannot be cast to TypeDeclaration</short_desc>
          <delta_ts>2014-08-06 00:02:32 -0400</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.4</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Windows 7</op_sys>
          <bug_status>VERIFIED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>4.5 M1</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Noopur Gupta">noopur_gupta</reporter>
          <assigned_to name="Manoj Palat Away Until May 11 2015">manpalat</assigned_to>
          <cc>daniel_megert</cc>
    
    <cc>jarthana</cc>
    
    <cc>manpalat</cc>
    
    <cc>markus_keller</cc>
    
    <cc>shankhba</cc>
    
    <cc>srikanth_sankaran</cc>
          
          <votes>0</votes>

      

      

      <flag name="review"
          id="62233"
          type_id="1"
          status="+"
          setter="jarthana"
    />

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2356474</commentid>
    <comment_count>0</comment_count>
    <who name="Noopur Gupta">noopur_gupta</who>
    <bug_when>2014-01-30 05:25:54 -0500</bug_when>
    <thetext>package com.test.todo;

import java.lang.annotation.ElementType;
import java.lang.annotation.Target;

public class Test {
	static void m() {
		
	}
	new Runnable() {
		public void run(|) {
			
		}
	};
}

@Target(ElementType.TYPE_USE)
@interface TU { }
------------------------------------------------

In the above example, type &quot;R&quot; in the parenthesis of &quot;run()&quot; in place of &apos;|&apos;.
We get the following exception:

java.lang.ClassCastException: org.eclipse.jdt.core.dom.AnnotationTypeDeclaration cannot be cast to org.eclipse.jdt.core.dom.TypeDeclaration
	at org.eclipse.jdt.core.dom.ASTConverter.convert(ASTConverter.java:2729)
	at org.eclipse.jdt.core.dom.ASTConverter.convert(ASTConverter.java:637)
	at org.eclipse.jdt.core.dom.ASTConverter.buildBodyDeclarations(ASTConverter.java:199)
	at org.eclipse.jdt.core.dom.ASTConverter.convert(ASTConverter.java:2956)
	at org.eclipse.jdt.core.dom.ASTConverter.convert(ASTConverter.java:1373)
	at org.eclipse.jdt.core.dom.AST.convertCompilationUnit(AST.java:274)
	at org.eclipse.jdt.internal.core.ReconcileWorkingCopyOperation.makeConsistent(ReconcileWorkingCopyOperation.java:207)
	at org.eclipse.jdt.internal.core.ReconcileWorkingCopyOperation.executeOperation(ReconcileWorkingCopyOperation.java:90)
	at org.eclipse.jdt.internal.core.JavaModelOperation.run(JavaModelOperation.java:729)
	at org.eclipse.jdt.internal.core.JavaModelOperation.runOperation(JavaModelOperation.java:789)
	at org.eclipse.jdt.internal.core.CompilationUnit.reconcile(CompilationUnit.java:1248)
	at org.eclipse.jdt.internal.ui.text.java.JavaReconcilingStrategy.reconcile(JavaReconcilingStrategy.java:126)
...</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2356576</commentid>
    <comment_count>1</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2014-01-30 08:31:10 -0500</bug_when>
    <thetext>Not a 1.8 specific issue. Moving out of Beta Java 8 target.

[Try the same test case with TYPE for a 1.7 case]</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2370308</commentid>
    <comment_count>2</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2014-03-03 01:17:28 -0500</bug_when>
    <thetext>Just had a quick look and it looks like the problem is with recovery. With the given code, the annotation declaration ends up as one of the statements inside the m() method. This is wrong. Even though we can avoid the CCE in ASTConverter, the ASTConverter is right in assuming that it can&apos;t be a AnnotationTypeDeclaration, because we can&apos;t have annotations inside methods.

Given that the code in comment #0 is broke, I suggest we move it out of M6 and investigate later.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2397962</commentid>
    <comment_count>3</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2014-05-07 04:56:23 -0400</bug_when>
    <thetext>Manoj, can we we address the CCE and perhaps mark the AST as malformed and close this? I don&apos;t see anything else that we can do at this point.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2399159</commentid>
    <comment_count>4</comment_count>
      <attachid>242877</attachid>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2014-05-08 20:43:23 -0400</bug_when>
    <thetext>Created attachment 242877
Proposed Patch

Jay: have implemented the check and added a test case. Would keep the bug open for now.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2399172</commentid>
    <comment_count>5</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2014-05-09 00:17:28 -0400</bug_when>
    <thetext>Fix looks good. Just one comment on the test: For an expected exception, it&apos;s okay &apos;not&apos; to print the stack trace. Also, fail() is a better option to use than calling assertTrue() with a forced condition:

fail(e.getMessage()) will do I guess.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2399258</commentid>
    <comment_count>6</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2014-05-09 05:40:52 -0400</bug_when>
    <thetext>(In reply to Jayaprakash Arthanareeswaran from comment #5)
&gt; Fix looks good. Just one comment on the test: For an expected exception,
Thanks for the review, Jay. Committed with suggested changes by: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=b652b7fd3a65d4ba23b1274ed0c9b6a3e193e11c</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2399262</commentid>
    <comment_count>7</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2014-05-09 05:44:57 -0400</bug_when>
    <thetext>(In reply to Manoj Palat from comment #6)
&gt; (In reply to Jayaprakash Arthanareeswaran from comment #5)
&gt; &gt; Fix looks good. Just one comment on the test: For an expected exception,
&gt; Thanks for the review, Jay. Committed with suggested changes by:
&gt; http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/
&gt; ?id=b652b7fd3a65d4ba23b1274ed0c9b6a3e193e11c

The commit still uses assertTrue and not fail(). I agree some other tests had it too, but that is not the correct way of doing things.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2399291</commentid>
    <comment_count>8</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2014-05-09 07:15:13 -0400</bug_when>
    <thetext>(In reply to Jayaprakash Arthanareeswaran from comment #7)

&gt; The commit still uses assertTrue and not fail(). I agree some other tests
&gt; had it too, but that is not the correct way of doing things.

sure - modified by http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?id=1a4f5bb865742ca9381a39bc6aa684319210a5d8</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2428588</commentid>
    <comment_count>9</comment_count>
    <who name="Manoj Palat Away Until May 11 2015">manpalat</who>
    <bug_when>2014-07-17 00:30:17 -0400</bug_when>
    <thetext>fixed [ref comment 3]</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2436026</commentid>
    <comment_count>10</comment_count>
    <who name="shankha banerjee">shankhba</who>
    <bug_when>2014-08-05 23:09:44 -0400</bug_when>
    <thetext>Verified for 4.5 M1 using I20140804-2000 build.</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>242877</attachid>
            <date>2014-05-08 20:43:00 -0400</date>
            <delta_ts>2014-05-08 20:43:23 -0400</delta_ts>
            <desc>Proposed Patch</desc>
            <filename>Fix-for-Bug-426977-dom-ast-CCE-AnnotationTypeDeclara.patch</filename>
            <type>text/plain</type>
            <size>2096</size>
            <attacher name="Manoj Palat Away Until May 11 2015">manpalat</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL29yZy5lY2xpcHNlLmpkdC5jb3JlLnRlc3RzLm1vZGVsL3NyYy9vcmcvZWNs
aXBzZS9qZHQvY29yZS90ZXN0cy9kb20vQVNUQ29udmVydGVyMThUZXN0LmphdmEgYi9vcmcuZWNs
aXBzZS5qZHQuY29yZS50ZXN0cy5tb2RlbC9zcmMvb3JnL2VjbGlwc2UvamR0L2NvcmUvdGVzdHMv
ZG9tL0FTVENvbnZlcnRlcjE4VGVzdC5qYXZhCmluZGV4IGUyZDRmMTMuLmQ1YzNiMGIgMTAwNjQ0
Ci0tLSBhL29yZy5lY2xpcHNlLmpkdC5jb3JlLnRlc3RzLm1vZGVsL3NyYy9vcmcvZWNsaXBzZS9q
ZHQvY29yZS90ZXN0cy9kb20vQVNUQ29udmVydGVyMThUZXN0LmphdmEKKysrIGIvb3JnLmVjbGlw
c2UuamR0LmNvcmUudGVzdHMubW9kZWwvc3JjL29yZy9lY2xpcHNlL2pkdC9jb3JlL3Rlc3RzL2Rv
bS9BU1RDb252ZXJ0ZXIxOFRlc3QuamF2YQpAQCAtNDM2Miw0ICs0MzYyLDMwIEBACiAJCWFzc2Vy
dFRydWUoIlRlc3QgRmFpbGVkIiwgZmFsc2UpOwogCX0KIH0KKy8qKgorICogaHR0cHM6Ly9idWdz
LmVjbGlwc2Uub3JnL2J1Z3Mvc2hvd19idWcuY2dpP2lkPTQyNjk3NworICogCisgKiBAdGhyb3dz
IEphdmFNb2RlbEV4Y2VwdGlvbgorICovCitwdWJsaWMgdm9pZCB0ZXN0QnVnNDI2OTc3KCkgdGhy
b3dzIEphdmFNb2RlbEV4Y2VwdGlvbiB7CisJU3RyaW5nIGNvbnRlbnRzID0KKwkJCSJwYWNrYWdl
IGNvbS50ZXN0LnRvZG87XHJcbiIrCisJCQkiaW1wb3J0IGphdmEubGFuZy5hbm5vdGF0aW9uLkVs
ZW1lbnRUeXBlO1xyXG4iKworCQkJImltcG9ydCBqYXZhLmxhbmcuYW5ub3RhdGlvbi5UYXJnZXQ7
XHJcbiIrCisJCQkicHVibGljIGNsYXNzIFRlc3Qge1xyXG4iKworCQkJIglzdGF0aWMgdm9pZCBt
KCkge31cclxuIisKKwkJCSIJbmV3IFJ1bm5hYmxlKCkge1xyXG4iKworCQkJIgkJcHVibGljIHZv
aWQgcnVuKFIpIHt9XHJcbiIrCisJCQkiCX07XHJcbiIrCisJCQkifVxyXG4iKworCQkJIkBUYXJn
ZXQoRWxlbWVudFR5cGUuVFlQRV9VU0UpXHJcbiIrCisJCQkiQGludGVyZmFjZSBUVSB7IH0iOwor
CXRoaXMud29ya2luZ0NvcHkgPSBnZXRXb3JraW5nQ29weSgiL0NvbnZlcnRlcjE4L3NyYy9jb20v
dGVzdC90b2RvL1Rlc3QuamF2YSIsIHRydWUvKmNvbXB1dGVQcm9ibGVtcyovKTsKKwl0cnkgewor
CQlidWlsZEFTVChBU1QuSkxTOCwgY29udGVudHMsIHRoaXMud29ya2luZ0NvcHksIGZhbHNlLCB0
cnVlLCB0cnVlKTsKKwl9IGNhdGNoIChDbGFzc0Nhc3RFeGNlcHRpb24gZSkgeworCQllLnByaW50
U3RhY2tUcmFjZSgpOworCQlhc3NlcnRUcnVlKCJUZXN0IEZhaWxlZCIsIGZhbHNlKTsKKwl9Cit9
CiB9CmRpZmYgLS1naXQgYS9vcmcuZWNsaXBzZS5qZHQuY29yZS9kb20vb3JnL2VjbGlwc2UvamR0
L2NvcmUvZG9tL0FTVENvbnZlcnRlci5qYXZhIGIvb3JnLmVjbGlwc2UuamR0LmNvcmUvZG9tL29y
Zy9lY2xpcHNlL2pkdC9jb3JlL2RvbS9BU1RDb252ZXJ0ZXIuamF2YQppbmRleCA4NTE0NDhiLi4y
ZTU4ZDI0IDEwMDY0NAotLS0gYS9vcmcuZWNsaXBzZS5qZHQuY29yZS9kb20vb3JnL2VjbGlwc2Uv
amR0L2NvcmUvZG9tL0FTVENvbnZlcnRlci5qYXZhCisrKyBiL29yZy5lY2xpcHNlLmpkdC5jb3Jl
L2RvbS9vcmcvZWNsaXBzZS9qZHQvY29yZS9kb20vQVNUQ29udmVydGVyLmphdmEKQEAgLTI3MjQs
NyArMjcyNCw3IEBACiAJCX0KIAkJaWYgKHN0YXRlbWVudCBpbnN0YW5jZW9mIG9yZy5lY2xpcHNl
LmpkdC5pbnRlcm5hbC5jb21waWxlci5hc3QuVHlwZURlY2xhcmF0aW9uKSB7CiAJCQlBU1ROb2Rl
IHJlc3VsdCA9IGNvbnZlcnQoKG9yZy5lY2xpcHNlLmpkdC5pbnRlcm5hbC5jb21waWxlci5hc3Qu
VHlwZURlY2xhcmF0aW9uKSBzdGF0ZW1lbnQpOwotCQkJaWYgKHJlc3VsdCA9PSBudWxsKSB7CisJ
CQlpZiAocmVzdWx0ID09IG51bGwgfHwgIShyZXN1bHQgaW5zdGFuY2VvZiBUeXBlRGVjbGFyYXRp
b24pKSB7CiAJCQkJcmV0dXJuIGNyZWF0ZUZha2VFbXB0eVN0YXRlbWVudChzdGF0ZW1lbnQpOwog
CQkJfQogCQkJLy8gYW5ub3RhdGlvbiBhbmQgZW51bSB0eXBlIGRlY2xhcmF0aW9ucyBhcmUgbm90
IHJldHVybmVkIGJ5IHRoZSBwYXJzZXIgaW5zaWRlIG1ldGhvZCBib2RpZXM=
</data>

          </attachment>
      

    </bug>

</bugzilla>