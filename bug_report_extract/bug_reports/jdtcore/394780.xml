<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>394780</bug_id>
          
          <creation_ts>2012-11-21 09:21:00 -0500</creation_ts>
          <short_desc>try-with-resource fails if resource is of generic type</short_desc>
          <delta_ts>2013-01-11 21:24:12 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.2</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>VERIFIED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>3.8.2</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Gernot Kvas">gernot</reporter>
          <assigned_to name="Jay Arthanareeswaran">jarthana</assigned_to>
          <cc>anchakrk</cc>
    
    <cc>jarthana</cc>
    
    <cc>Olivier_Thomann</cc>
    
    <cc>srikanth_sankaran</cc>
    
    <cc>stephan.herrmann</cc>
          
          <votes>0</votes>

      

      

      

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2186159</commentid>
    <comment_count>0</comment_count>
    <who name="Gernot Kvas">gernot</who>
    <bug_when>2012-11-21 09:21:59 -0500</bug_when>
    <thetext>The below example (full code at https://github.com/gkvas/tryWithResourceBug):

package at.kvas.jdt.bug;

public class Main&lt;R extends Resource&gt; {

    public static void main(String[] args) {

        Main&lt;Resource&gt; m = new Main&lt;&gt;();
        m.tryWithResource(new ResourceImpl());

    }

    public void tryWithResource(R resource) {
        try (R r = resource) {
            r.compute();
        }
    }
}

fails with the following exception

Exception in thread &quot;main&quot; java.lang.IncompatibleClassChangeError: Found interface at.kvas.jdt.bug.Resource, but class was expected
	at at.kvas.jdt.bug.Main.tryWithResource(Main.java:18)
	at at.kvas.jdt.bug.Main.main(Main.java:11)

Looking at the bytecode, r.close() is invoked via invokevirtual, not invokeinterface. The same code using Oracles javac works.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2186219</commentid>
    <comment_count>1</comment_count>
    <who name="Olivier Thomann">Olivier_Thomann</who>
    <bug_when>2012-11-21 10:28:01 -0500</bug_when>
    <thetext>Taking the erasure of the resource binding in org.eclipse.jdt.internal.compiler.codegen.CodeStream#invokeAutoCloseableClose(TypeBinding) like this:
...
resourceType.erasure().isInterface() ? Opcodes.OPC_invokeinterface : Opcodes.OPC_invokevirtual,
...
would fix this issue.
Srikanth, not sure this is enough though.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2186220</commentid>
    <comment_count>2</comment_count>
      <attachid>223812</attachid>
    <who name="Olivier Thomann">Olivier_Thomann</who>
    <bug_when>2012-11-21 10:28:40 -0500</bug_when>
    <thetext>Created attachment 223812
Proposed fix</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2186221</commentid>
    <comment_count>3</comment_count>
      <attachid>223813</attachid>
    <who name="Olivier Thomann">Olivier_Thomann</who>
    <bug_when>2012-11-21 10:29:59 -0500</bug_when>
    <thetext>Created attachment 223813
Regression test</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2186458</commentid>
    <comment_count>4</comment_count>
    <who name="Stephan Herrmann">stephan.herrmann</who>
    <bug_when>2012-11-21 18:38:08 -0500</bug_when>
    <thetext>I thought I could contribute another example of this kind using a type parameter in a foreach loop (because invokeIterableIterator() contains the same logic without calling erasure()), but after failing to create a witness I found that ForeachStatement uses this:

  this.iteratorReceiverType = collectionType.erasure();

This backs the plan to let CodeStream use the erasure also for the auto close call. Makes sense to me.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2186523</commentid>
    <comment_count>5</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2012-11-22 04:24:23 -0500</bug_when>
    <thetext>Jay, please take to this to completion, TIA.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2186722</commentid>
    <comment_count>6</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2012-11-22 11:21:05 -0500</bug_when>
    <thetext>All tests pass. Released in master and R3_8_maintenance.

Thanks for the patch, Olivier!</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2192876</commentid>
    <comment_count>7</comment_count>
    <who name="Stephan Herrmann">stephan.herrmann</who>
    <bug_when>2012-12-11 04:59:38 -0500</bug_when>
    <thetext>Verified for 4.3 M4 using build I20121210-2000.

Leaving bug status at resolved for verification against 3.8.2.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2201579</commentid>
    <comment_count>8</comment_count>
    <who name="ANIRBAN CHAKRABORTY">anchakrk</who>
    <bug_when>2013-01-11 00:03:52 -0500</bug_when>
    <thetext>Hello,

I&apos;m trying to verify this for 4.2.2 M20130109-1200.
It seems that the testcase specified in this bug is NOT coming clean.

Even after I provided the AutoCloseable interface, there is this following error:

&apos;The resource type R does not implement java.lang.AutoCloseable	Main.java	/test422/src/at/kvas/jdt/bug	line 13	Java Problem&apos;

Am I missing something?

Regards
Anirban</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2201580</commentid>
    <comment_count>9</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2013-01-11 00:14:05 -0500</bug_when>
    <thetext>(In reply to comment #8)
&gt; Hello,
&gt; 
&gt; I&apos;m trying to verify this for 4.2.2 M20130109-1200.
&gt; It seems that the testcase specified in this bug is NOT coming clean.
&gt; 
&gt; Even after I provided the AutoCloseable interface, there is this following
&gt; error:

What is the test case you are trying with ? Comment#0 contains only partial
code snippet which needs to be augmented with more code before it can
be tried out. Please look in https://bugs.eclipse.org/bugs/attachment.cgi?id=223813 for a full test case - let me know if the problem persists.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2201581</commentid>
    <comment_count>10</comment_count>
    <who name="ANIRBAN CHAKRABORTY">anchakrk</who>
    <bug_when>2013-01-11 00:21:57 -0500</bug_when>
    <thetext>Hello Srikanth,
I took the full sources form the &apos; https://github.com/gkvas/tryWithResourceBug&apos;, as specified in Comment#0. Still that required a declaration of AutoCloseable (as Resource was extending from that). I provided that interface too. Then other errors are gone, but the one specified in Comment#8 still remains.

Anirban</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2201583</commentid>
    <comment_count>11</comment_count>
    <who name="Jay Arthanareeswaran">jarthana</who>
    <bug_when>2013-01-11 00:27:41 -0500</bug_when>
    <thetext>(In reply to comment #8)
&gt; Am I missing something?

Possible. Can you check if you had set the compliance level to 1.7 and had a 1.7 JDK in the project&apos;s build path? I can see that the fix works.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2201589</commentid>
    <comment_count>12</comment_count>
    <who name="ANIRBAN CHAKRABORTY">anchakrk</who>
    <bug_when>2013-01-11 00:51:46 -0500</bug_when>
    <thetext>Hello,
It seems that the issue was caused because JRE 1.7 was not in the path.
Apologies for the confusion.
Thanks
Anirban</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2201953</commentid>
    <comment_count>13</comment_count>
    <who name="ANIRBAN CHAKRABORTY">anchakrk</who>
    <bug_when>2013-01-11 15:11:10 -0500</bug_when>
    <thetext>Verified for 4.2.2 M20130109-1200</thetext>
  </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>223812</attachid>
            <date>2012-11-21 10:28:00 -0500</date>
            <delta_ts>2012-11-21 10:28:40 -0500</delta_ts>
            <desc>Proposed fix</desc>
            <filename>patch_394780.txt</filename>
            <type>text/plain</type>
            <size>842</size>
            <attacher name="Olivier Thomann">Olivier_Thomann</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL29yZy5lY2xpcHNlLmpkdC5jb3JlL2NvbXBpbGVyL29yZy9lY2xpcHNlL2pk
dC9pbnRlcm5hbC9jb21waWxlci9jb2RlZ2VuL0NvZGVTdHJlYW0uamF2YSBiL29yZy5lY2xpcHNl
LmpkdC5jb3JlL2NvbXBpbGVyL29yZy9lY2xpcHNlL2pkdC9pbnRlcm5hbC9jb21waWxlci9jb2Rl
Z2VuL0NvZGVTdHJlYW0uamF2YQppbmRleCBkOTk4NDM2Li5jYjJhNTg2IDEwMDY0NAotLS0gYS9v
cmcuZWNsaXBzZS5qZHQuY29yZS9jb21waWxlci9vcmcvZWNsaXBzZS9qZHQvaW50ZXJuYWwvY29t
cGlsZXIvY29kZWdlbi9Db2RlU3RyZWFtLmphdmEKKysrIGIvb3JnLmVjbGlwc2UuamR0LmNvcmUv
Y29tcGlsZXIvb3JnL2VjbGlwc2UvamR0L2ludGVybmFsL2NvbXBpbGVyL2NvZGVnZW4vQ29kZVN0
cmVhbS5qYXZhCkBAIC00MDQ1LDcgKzQwNDUsNyBAQAogcHVibGljIHZvaWQgaW52b2tlQXV0b0Ns
b3NlYWJsZUNsb3NlKFR5cGVCaW5kaW5nIHJlc291cmNlVHlwZSkgewogCS8vIGludm9rZXZpcnR1
YWwvaW50ZXJmYWNlOiA8cmVzb3VyY2VUeXBlPi5jbG9zZSgpCiAJaW52b2tlKAotCQkJcmVzb3Vy
Y2VUeXBlLmlzSW50ZXJmYWNlKCkgPyBPcGNvZGVzLk9QQ19pbnZva2VpbnRlcmZhY2UgOiBPcGNv
ZGVzLk9QQ19pbnZva2V2aXJ0dWFsLAorCQkJcmVzb3VyY2VUeXBlLmVyYXN1cmUoKS5pc0ludGVy
ZmFjZSgpID8gT3Bjb2Rlcy5PUENfaW52b2tlaW50ZXJmYWNlIDogT3Bjb2Rlcy5PUENfaW52b2tl
dmlydHVhbCwKIAkJCTEsIC8vIHJlY2VpdmVyQW5kQXJnc1NpemUKIAkJCTAsIC8vIHJldHVyblR5
cGVTaXplCiAJCQlyZXNvdXJjZVR5cGUuY29uc3RhbnRQb29sTmFtZSgpLCA=
</data>

          </attachment>
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>223813</attachid>
            <date>2012-11-21 10:29:00 -0500</date>
            <delta_ts>2012-11-21 10:29:59 -0500</delta_ts>
            <desc>Regression test</desc>
            <filename>patch_394780_tests.txt</filename>
            <type>text/plain</type>
            <size>2146</size>
            <attacher name="Olivier Thomann">Olivier_Thomann</attacher>
            
              <data encoding="base64">ZGlmZiAtLWdpdCBhL29yZy5lY2xpcHNlLmpkdC5jb3JlLnRlc3RzLmNvbXBpbGVyL3NyYy9vcmcv
ZWNsaXBzZS9qZHQvY29yZS90ZXN0cy9jb21waWxlci9yZWdyZXNzaW9uL1RyeVdpdGhSZXNvdXJj
ZXNTdGF0ZW1lbnRUZXN0LmphdmEgYi9vcmcuZWNsaXBzZS5qZHQuY29yZS50ZXN0cy5jb21waWxl
ci9zcmMvb3JnL2VjbGlwc2UvamR0L2NvcmUvdGVzdHMvY29tcGlsZXIvcmVncmVzc2lvbi9UcnlX
aXRoUmVzb3VyY2VzU3RhdGVtZW50VGVzdC5qYXZhCmluZGV4IDQzYTdmYTQuLjkxNmE1YWIgMTAw
NjQ0Ci0tLSBhL29yZy5lY2xpcHNlLmpkdC5jb3JlLnRlc3RzLmNvbXBpbGVyL3NyYy9vcmcvZWNs
aXBzZS9qZHQvY29yZS90ZXN0cy9jb21waWxlci9yZWdyZXNzaW9uL1RyeVdpdGhSZXNvdXJjZXNT
dGF0ZW1lbnRUZXN0LmphdmEKKysrIGIvb3JnLmVjbGlwc2UuamR0LmNvcmUudGVzdHMuY29tcGls
ZXIvc3JjL29yZy9lY2xpcHNlL2pkdC9jb3JlL3Rlc3RzL2NvbXBpbGVyL3JlZ3Jlc3Npb24vVHJ5
V2l0aFJlc291cmNlc1N0YXRlbWVudFRlc3QuamF2YQpAQCAtMjMsNyArMjMsNyBAQAogcHVibGlj
IGNsYXNzIFRyeVdpdGhSZXNvdXJjZXNTdGF0ZW1lbnRUZXN0IGV4dGVuZHMgQWJzdHJhY3RSZWdy
ZXNzaW9uVGVzdCB7CiAKIHN0YXRpYyB7Ci0vLwlURVNUU19OQU1FUyA9IG5ldyBTdHJpbmdbXSB7
ICJ0ZXN0MzgwMTEyZSJ9OworCVRFU1RTX05BTUVTID0gbmV3IFN0cmluZ1tdIHsgInRlc3QzOTQ3
ODAifTsKIC8vCVRFU1RTX05VTUJFUlMgPSBuZXcgaW50W10geyA1MCB9OwogLy8JVEVTVFNfUkFO
R0UgPSBuZXcgaW50W10geyAxMSwgLTEgfTsKIH0KQEAgLTQxOTIsNiArNDE5Miw0MiBAQAogCQkJ
CSJ9XG4iCiAJCQl9LCAiRG9uZSIsIGxpYnMsIHRydWUsIG5ldyBTdHJpbmdbXSB7Ii1jcCIsIHBh
dGh9KTsKIH0KKy8vaHR0cHM6Ly9idWdzLmVjbGlwc2Uub3JnL2J1Z3Mvc2hvd19idWcuY2dpP2lk
PTM5NDc4MAorcHVibGljIHZvaWQgdGVzdDM5NDc4MCgpIHsKKwl0aGlzLnJ1bkNvbmZvcm1UZXN0
KAorCQkJbmV3IFN0cmluZ1tdIHsKKwkJCQkiWC5qYXZhIiwgCisJCQkJInB1YmxpYyBjbGFzcyBY
PFIgZXh0ZW5kcyBSZXNvdXJjZT4ge1xuIiArIAorCQkJCSIgICAgcHVibGljIHN0YXRpYyB2b2lk
IG1haW4oU3RyaW5nW10gYXJncykge1xuIiArIAorCQkJCSIgICAgICAgIFg8UmVzb3VyY2U+IG0g
PSBuZXcgWDw+KCk7XG4iICsgCisJCQkJIiAgICAgICAgbS50cnlXaXRoUmVzb3VyY2UobmV3IFJl
c291cmNlSW1wbCgpKTtcbiIgKyAKKwkJCQkiICAgIH1cbiIgKyAKKwkJCQkiICAgIHB1YmxpYyB2
b2lkIHRyeVdpdGhSZXNvdXJjZShSIHJlc291cmNlKSB7XG4iICsgCisJCQkJIiAgICAgICAgdHJ5
IChSIHIgPSByZXNvdXJjZSkge1xuIiArIAorCQkJCSIgICAgICAgICAgICByLmNvbXB1dGUoKTtc
biIgKyAKKwkJCQkiICAgICAgICB9XG4iICsgCisJCQkJIiAgICB9XG4iICsgCisJCQkJIn0iLAor
CQkJCSJSZXNvdXJjZS5qYXZhIiwKKwkJCQkicHVibGljIGludGVyZmFjZSBSZXNvdXJjZSBleHRl
bmRzIEF1dG9DbG9zZWFibGUge1xuIiArIAorCQkJCSIgICAgdm9pZCBjb21wdXRlKCk7XG4iICsg
CisJCQkJIiAgICBAT3ZlcnJpZGVcbiIgKyAKKwkJCQkiICAgIHB1YmxpYyB2b2lkIGNsb3NlKCk7
XG4iICsgCisJCQkJIn0iLAorCQkJCSJSZXNvdXJjZUltcGwuamF2YSIsCisJCQkJInB1YmxpYyBj
bGFzcyBSZXNvdXJjZUltcGwgaW1wbGVtZW50cyBSZXNvdXJjZSB7XG4iICsgCisJCQkJIiAgICBA
T3ZlcnJpZGVcbiIgKyAKKwkJCQkiICAgIHB1YmxpYyB2b2lkIGNsb3NlKCkge1xuIiArIAorCQkJ
CSIgICAgICAgIFN5c3RlbS5vdXQucHJpbnQoXCJjbG9zZVwiKTtcbiIgKyAKKwkJCQkiICAgIH1c
biIgKyAKKwkJCQkiICAgIEBPdmVycmlkZVxuIiArIAorCQkJCSIgICAgcHVibGljIHZvaWQgY29t
cHV0ZSgpIHtcbiIgKyAKKwkJCQkiICAgICAgICBTeXN0ZW0ub3V0LnByaW50KFwiY29tcHV0ZVwi
KTtcbiIgKyAKKwkJCQkiICAgIH1cbiIgKyAKKwkJCQkifSIKKwkJCX0sIAorCQkJImNvbXB1dGVj
bG9zZSIpOworfQogcHVibGljIHN0YXRpYyBDbGFzcyB0ZXN0Q2xhc3MoKSB7CiAJcmV0dXJuIFRy
eVdpdGhSZXNvdXJjZXNTdGF0ZW1lbnRUZXN0LmNsYXNzOwogfQ==
</data>

          </attachment>
      

    </bug>

</bugzilla>