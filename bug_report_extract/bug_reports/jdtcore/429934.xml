<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugs.eclipse.org/bugs/page.cgi?id=bugzilla.dtd">

<bugzilla version="4.4.7"
          urlbase="https://bugs.eclipse.org/bugs/"
          
          maintainer="webmaster@eclipse.org"
>

    <bug>
          <bug_id>429934</bug_id>
          
          <creation_ts>2014-03-08 08:14:00 -0500</creation_ts>
          <short_desc>[1.8][search] for references to type of lambda with &apos;this&apos; parameter throws AIIOBE</short_desc>
          <delta_ts>2014-11-27 10:37:32 -0500</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>2</classification_id>
          <classification>Eclipse</classification>
          <product>JDT</product>
          <component>Core</component>
          <version>4.4</version>
          <rep_platform>All</rep_platform>
          <op_sys>All</op_sys>
          <bug_status>RESOLVED</bug_status>
          <resolution>FIXED</resolution>
          
          
          <bug_file_loc></bug_file_loc>
          <status_whiteboard></status_whiteboard>
          <keywords></keywords>
          <priority>P3</priority>
          <bug_severity>normal</bug_severity>
          <target_milestone>BETA J8</target_milestone>
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Markus Keller">markus_keller</reporter>
          <assigned_to name="Srikanth Sankaran">srikanth_sankaran</assigned_to>
          <cc>srikanth_sankaran</cc>
    
    <cc>stephan.herrmann</cc>
          
          <votes>0</votes>

      

      

      <flag name="review"
          id="61852"
          type_id="1"
          status="+"
          setter="stephan.herrmann"
    />

          <comment_sort_order>oldest_to_newest</comment_sort_order>  
          <long_desc isprivate="0" >
    <commentid>2373352</commentid>
    <comment_count>0</comment_count>
    <who name="Markus Keller">markus_keller</who>
    <bug_when>2014-03-08 08:14:16 -0500</bug_when>
    <thetext>Search for references to the functional interface type of a lambda with an (illegal!) &apos;this&apos; parameter throws AIIOBE.

Search for references to type &quot;Function&quot; here:

	Function&lt;String, String&gt; f1= (String s, Function this) -&gt; s;
	Function&lt;String, String&gt; f2= (Function this, String s) -&gt; s;

The line numbers in the stacktrace may not be accurate, since I had some pending changes in my workspace. The AIOOBE happens in line
	String signature = manager.intern(new String(lambdaExpression.descriptor.parameters[i].signature()));

I think the &quot;length&quot; variable should be set to min(lambdaExpression.descriptor.parameters.length,lambdaExpression.arguments.length). Note that &quot;length&quot; is currently written twice.

!ENTRY org.eclipse.core.jobs 4 2 2014-03-08 14:06:23.938
!MESSAGE An internal error occurred during: &quot;Java Search&quot;.
!STACK 0
java.lang.ArrayIndexOutOfBoundsException: 1
	at org.eclipse.jdt.internal.core.LambdaMethod.make(LambdaMethod.java:62)
	at org.eclipse.jdt.internal.core.LambdaExpression.&lt;init&gt;(LambdaExpression.java:49)
	at org.eclipse.jdt.internal.core.search.matching.MatchLocator.createHandle(MatchLocator.java:457)
	at org.eclipse.jdt.internal.core.search.matching.MatchLocator.reportMatching(MatchLocator.java:2226)
	at org.eclipse.jdt.internal.core.search.matching.MemberDeclarationVisitor.visit(MemberDeclarationVisitor.java:216)
	at org.eclipse.jdt.internal.compiler.ast.LambdaExpression.traverse(LambdaExpression.java:637)
	at org.eclipse.jdt.internal.compiler.ast.FieldDeclaration.traverse(FieldDeclaration.java:343)
	at org.eclipse.jdt.internal.core.search.matching.MatchLocator.reportMatching(MatchLocator.java:2612)
	at org.eclipse.jdt.internal.core.search.matching.MatchLocator.reportMatching(MatchLocator.java:2845)
	at org.eclipse.jdt.internal.core.search.matching.MatchLocator.reportMatching(MatchLocator.java:2572)
	at org.eclipse.jdt.internal.core.search.matching.MatchLocator.process(MatchLocator.java:1755)
	at org.eclipse.jdt.internal.core.search.matching.MatchLocator.locateMatches(MatchLocator.java:1164)
	at org.eclipse.jdt.internal.core.search.matching.MatchLocator.locateMatches(MatchLocator.java:1205)
	at org.eclipse.jdt.internal.core.search.matching.MatchLocator.locateMatches(MatchLocator.java:1322)
	at org.eclipse.jdt.internal.core.search.JavaSearchParticipant.locateMatches(JavaSearchParticipant.java:122)
	at org.eclipse.jdt.internal.core.search.BasicSearchEngine.findMatches(BasicSearchEngine.java:232)
	at org.eclipse.jdt.internal.core.search.BasicSearchEngine.search(BasicSearchEngine.java:516)
	at org.eclipse.jdt.core.search.SearchEngine.search(SearchEngine.java:584)
	at org.eclipse.jdt.internal.ui.search.JavaSearchQuery.run(JavaSearchQuery.java:144)
	at org.eclipse.search2.internal.ui.InternalSearchUI$InternalSearchJob.run(InternalSearchUI.java:91)
	at org.eclipse.core.internal.jobs.Worker.run(Worker.java:53)</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2373354</commentid>
    <comment_count>1</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-03-08 08:17:21 -0500</bug_when>
    <thetext>Thanks Markus, I&apos;ll follow up.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2373359</commentid>
    <comment_count>2</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-03-08 08:50:36 -0500</bug_when>
    <thetext>Actually just saving:

public class X {
	
	public static void main(String[] args) {
		Function&lt;String, String&gt; f1= (String s, Function this) -&gt; s;
		Function&lt;String, String&gt; f2= (Function this, String s) -&gt; s;
	}
	
}

triggers an NPE, I&apos;ll include a fix for this too here.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2373363</commentid>
    <comment_count>3</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-03-08 09:10:50 -0500</bug_when>
    <thetext>(In reply to Markus Keller from comment #0)
&gt; Search for references to the functional interface type of a lambda with an
&gt; (illegal!) &apos;this&apos; parameter throws AIIOBE.
&gt; 
&gt; Search for references to type &quot;Function&quot; here:
&gt; 
&gt; 	Function&lt;String, String&gt; f1= (String s, Function this) -&gt; s;
&gt; 	Function&lt;String, String&gt; f2= (Function this, String s) -&gt; s;

Markus, can you post the full test case you tried ? 

I am having trouble with just this snippet in reproducing.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2373366</commentid>
    <comment_count>4</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-03-08 09:21:00 -0500</bug_when>
    <thetext>(In reply to Srikanth Sankaran from comment #2)
&gt; Actually just saving:
&gt; 
&gt; public class X {
&gt; 	
&gt; 	public static void main(String[] args) {
&gt; 		Function&lt;String, String&gt; f1= (String s, Function this) -&gt; s;
&gt; 		Function&lt;String, String&gt; f2= (Function this, String s) -&gt; s;
&gt; 	}
&gt; 	
&gt; }
&gt; 
&gt; triggers an NPE, I&apos;ll include a fix for this too here.

Totally unrelated root cause, so I opened https://bugs.eclipse.org/bugs/show_bug.cgi?id=429935</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2373379</commentid>
    <comment_count>5</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-03-08 10:57:54 -0500</bug_when>
    <thetext>(In reply to Srikanth Sankaran from comment #3)

&gt; Markus, can you post the full test case you tried ? 
&gt; 
&gt; I am having trouble with just this snippet in reproducing.

Simple enough: 

// --
import java.util.function.*;
public class X {
	public static void main(String[] args) {
		Function&lt;String, String&gt; f1= (String s, Function this) -&gt; s;
		Function&lt;String, String&gt; f2= (Function this, String s) -&gt; s;
	} 
}</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2373505</commentid>
    <comment_count>6</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-03-09 09:58:26 -0400</bug_when>
    <thetext>Fix and tests here: http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=BETA_JAVA8&amp;id=8d4ab5644565c055b67fa7745388cbe96026e76a

Amendments here: 
http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=BETA_JAVA8&amp;id=d40d65cc310f8b80e4964046fc88b861b3de2b63

With this fix, we will not create a Java model element for a lambda expression
that is not well formed.

Wellformedness includes:

    - Having a target type that is a functional interface type.
    - Lambda arity should match sam arity
    - For explicitly typed lambdas, the parameters at the lambda site should
      match the sam from the interface.

    - Errors in body do not influence wellformedness.

A lambda expression relies heavily on its descriptor to derive its own traits.
Broken lambdas are problematic to handle - I am not sure how many places would
require to be adjusted and it is too risky at the moment.

As a result, if a subelement of a broken lambda happens to be the focus element,
its parent will be the parent of the broken lambda expression.

This may or may not jell well with the overall of scheme of things. Markus,
if it is very important to clients to see even broken lambdas, please open
a fresh defect - we will look at it for 4.4 - Thanks.</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2373549</commentid>
    <comment_count>7</comment_count>
    <who name="Stephan Herrmann">stephan.herrmann</who>
    <bug_when>2014-03-09 18:26:32 -0400</bug_when>
    <thetext>I haven&apos;t debugged the corresponding tests, but I&apos;d suggest trying the following:

instead

  if (!(expectedParameterType instanceof InferenceVariable)) {

you may want to write

  if (expectedParameterType.isProperType(true)) {

This would be the canonical way of checking if *any* inference variable is involved *somewhere* in &apos;expectedParameterType&apos;.

(See that InferenceVariable directly answers &apos;false&apos;).


Does this make sense / work for the case at hand?</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2373569</commentid>
    <comment_count>8</comment_count>
    <who name="Srikanth Sankaran">srikanth_sankaran</who>
    <bug_when>2014-03-09 21:02:06 -0400</bug_when>
    <thetext>(In reply to Stephan Herrmann from comment #7)

&gt; you may want to write
&gt; 
&gt;   if (expectedParameterType.isProperType(true)) {
&gt; 
&gt; This would be the canonical way of checking if *any* inference variable is
&gt; involved *somewhere* in &apos;expectedParameterType&apos;.

Perfect, thanks for catching this:
http://git.eclipse.org/c/jdt/eclipse.jdt.core.git/commit/?h=BETA_JAVA8&amp;id=a8cbebd170009b62a902461aed94df473d2c0d4a</thetext>
  </long_desc><long_desc isprivate="0" >
    <commentid>2489824</commentid>
    <comment_count>9</comment_count>
    <who name="Stephan Herrmann">stephan.herrmann</who>
    <bug_when>2014-11-27 10:37:32 -0500</bug_when>
    <thetext>Cleaning stale review flag to +1 :)</thetext>
  </long_desc>
      
      

    </bug>

</bugzilla>